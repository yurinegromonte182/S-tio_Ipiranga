<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="App para gestÃ£o e monitoramento das frutÃ­feras do SÃ­tio Ipiranga">
  <meta name="theme-color" content="#10b981">
  <title>SÃ­tio Ipiranga - GestÃ£o de FrutÃ­feras</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SÃ­tio Ipiranga">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f3f4f6;
      overflow-x: hidden;
      min-height: 100vh;
    }

    #appLoader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      transition: opacity 0.3s;
    }

    #appLoader.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loader-icon {
      font-size: 4rem;
      animation: bounce 1s infinite;
      margin-bottom: 1rem;
    }

    .loader-text {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .loader-progress {
      width: 200px;
      height: 4px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .loader-bar {
      height: 100%;
      background: white;
      width: 0%;
      animation: progressBar 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    @keyframes progressBar {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    #mainApp {
      opacity: 0;
      transition: opacity 0.3s;
      min-height: 100vh;
    }

    #mainApp.loaded {
      opacity: 1;
    }

    .status-bar {
      background: #1f2937;
      color: white;
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 2s infinite;
    }

    .status-dot.offline {
      background: #ef4444;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .header {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 1.5rem 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header h1 {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .header-stats {
      font-size: 0.9rem;
      opacity: 0.95;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .tabs {
      display: flex;
      background: white;
      border-bottom: 2px solid #e5e7eb;
      overflow-x: auto;
      position: sticky;
      top: 100px;
      z-index: 99;
    }
    
    .tab {
      flex: 1;
      padding: 1rem;
      border: none;
      background: white;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      min-width: 100px;
    }
    
    .tab.active {
      border-bottom-color: #10b981;
      color: #10b981;
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
      padding: 1rem;
      animation: fadeIn 0.3s;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .section {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .section-title.clickable {
      cursor: pointer;
      user-select: none;
    }

    .section-title.clickable:hover {
      color: #10b981;
    }

    #cadastroFormContainer {
      transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
      overflow: hidden;
      max-height: 2000px;
      opacity: 1;
    }

    #cadastroFormContainer.collapsed {
      max-height: 0;
      opacity: 0;
      margin-bottom: 0;
    }
    
    .action-item {
      padding: 1rem;
      border-left: 4px solid #10b981;
      background: #f0fdf4;
      border-radius: 8px;
      margin-bottom: 0.75rem;
    }
    
    .action-item.urgent {
      border-left-color: #ef4444;
      background: #fef2f2;
    }
    
    .action-item.warning {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }

    .action-title {
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .action-meta {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
    
    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge.urgent {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .badge.warning {
      background: #fef3c7;
      color: #d97706;
    }
    
    .action-desc {
      color: #4b5563;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    
    .btn {
      padding: 0.75rem 1.25rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 0.75rem;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #10b981;
      color: white;
    }
    
    .btn-primary:active {
      background: #059669;
      transform: scale(0.98);
    }

    .btn-secondary {
      background: white;
      color: #10b981;
      border: 2px solid #10b981;
    }

    .filter-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      overflow-x: auto;
      padding-bottom: 0.25rem;
    }
    
    .filter-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .filter-btn.active {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .search-box, .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      font-family: inherit;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #374151;
      font-size: 0.9rem;
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .frutifera-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .frutifera-card:active {
      transform: scale(0.98);
    }
    
    .frutifera-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    
    .frutifera-name {
      font-weight: 600;
      font-size: 1rem;
    }
    
    .frutifera-info {
      display: grid;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: #6b7280;
    }

    .info-box {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: #0c4a6e;
    }

    .success-box {
      background: #f0fdf4;
      border: 1px solid #86efac;
      color: #166534;
    }

    .warning-box {
      background: #fffbeb;
      border: 1px solid #fde68a;
      color: #92400e;
    }

    .error-box {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 2000;
      display: none;
      max-width: 90%;
    }

    .toast.show {
      display: block;
      animation: slideUp 0.3s;
    }

    @keyframes slideUp {
      from { transform: translateY(20px) translateX(-50%); opacity: 0; }
      to { transform: translateY(0) translateX(-50%); opacity: 1; }
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #9ca3af;
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 1.25rem;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    
    .stat-label {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .footer-space {
      height: 2rem;
    }

    /* ESTILOS DO MAPA */
    #mapContainer {
      width: 100%;
      height: calc(100vh - 180px);
      min-height: 400px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .map-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .map-btn {
      padding: 0.75rem;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
      text-align: center;
    }

    .map-btn:hover {
      border-color: #10b981;
      color: #10b981;
    }

    .map-btn.active {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .layer-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }

    .layer-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .layer-badge {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 3px solid currentColor;
    }

    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #d1d5db;
      border-radius: 24px;
      transition: all 0.2s;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: all 0.2s;
    }

    input:checked + .toggle-slider {
      background-color: #10b981;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

    .leaflet-popup-content-wrapper {
      border-radius: 8px !important;
    }

    .leaflet-popup-content {
      font-family: inherit !important;
      line-height: 1.6 !important;
      margin: 0.75rem !important;
    }

    .popup-content h3 {
      margin: 0 0 0.75rem 0;
      color: #10b981;
      border-bottom: 2px solid #10b981;
      padding-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .popup-content .info-row {
      margin: 0.5rem 0;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      font-size: 0.85rem;
    }

    .popup-content .info-label {
      font-weight: 600;
      color: #6b7280;
    }

    .popup-content .info-value {
      color: #1f2937;
      text-align: right;
    }

    @media (max-width: 768px) {
      #mapContainer {
        height: calc(100vh - 220px);
      }
      
      .map-controls {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="appLoader">
    <div class="loader-icon">ğŸŒ¿</div>
    <div class="loader-text">SÃ­tio Ipiranga</div>
    <div style="font-size: 0.9rem; opacity: 0.9;">Carregando frutÃ­feras...</div>
    <div class="loader-progress">
      <div class="loader-bar"></div>
    </div>
  </div>

  <div id="mainApp">
    <div class="status-bar">
      <div class="status-indicator">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Online</span>
      </div>
      <div id="syncStatus" style="font-size: 0.75rem;">SÃ­tio Ipiranga</div>
    </div>

    <div class="header">
      <h1>ğŸŒ¿ SÃ­tio Ipiranga</h1>
      <div class="header-stats">
        <span id="frutiferaCount">ğŸ“Š 0 frutÃ­feras</span>
        <span id="actionCount">ğŸ“‹ 0 aÃ§Ãµes</span>
        <span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">âœ… Supabase</span>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab(event, 'acoes')">ğŸ“‹ AÃ§Ãµes</button>
      <button class="tab" onclick="switchTab(event, 'mapa')">ğŸ—ºï¸ Mapa</button>
      <button class="tab" onclick="switchTab(event, 'frutiferas')">ğŸŒ± FrutÃ­feras</button>
      <button class="tab" onclick="switchTab(event, 'historico')">ğŸ“œ HistÃ³rico</button>
      <button class="tab" onclick="switchTab(event, 'stats')">ğŸ“Š Stats</button>
      <button class="tab" onclick="switchTab(event, 'config')">âš™ï¸ Config</button>
    </div>
    
    <!-- Tab: AÃ§Ãµes -->
    <div id="acoes" class="tab-content active">
      <div class="section">
        <div class="section-title">ğŸ“‹ AÃ§Ãµes NecessÃ¡rias</div>
        
        <div id="autoSyncInfo" class="info-box">
          <span>ğŸ“¡ Dados sincronizados com Supabase</span><br>
          <small>As aÃ§Ãµes sÃ£o salvas localmente e sincronizadas com o banco de dados</small>
        </div>
        
        <!-- BOTÃƒO PARA ZERAR TODAS AS AÃ‡Ã•ES - FUNCIONANDO -->
        <button class="btn btn-secondary" onclick="zerarTodasAcoes()" 
                style="margin-bottom: 1rem; background: #ef4444; color: white; border: 2px solid #dc2626; font-weight: bold;">
          ğŸ—‘ï¸ Zerar Todas as AÃ§Ãµes
        </button>
        
        <div class="filter-group">
          <button class="filter-btn active" onclick="filterAcoes(event, 'todas')">Todas</button>
          <button class="filter-btn" onclick="filterAcoes(event, 'urgente')">ğŸš¨ Urgentes</button>
          <button class="filter-btn" onclick="filterAcoes(event, 'rega')">ğŸ’§ Rega</button>
          <button class="filter-btn" onclick="filterAcoes(event, 'poda')">âœ‚ï¸ Poda</button>
          <button class="filter-btn" onclick="filterAcoes(event, 'colheita')">ğŸŠ Colheita</button>
        </div>
        
        <!-- CONTADOR DE AÃ‡Ã•ES -->
        <div id="contadorAcoes" style="margin-bottom: 1rem; padding: 0.5rem; background: #f0f9ff; border-radius: 8px; text-align: center; font-weight: 600;">
          ğŸ“‹ <span id="totalAcoes">0</span> aÃ§Ãµes pendentes
        </div>
        
        <div id="acoesHoje">
          <div class="loading">Carregando dados...</div>
        </div>
      </div>
    </div>

    <!-- Tab: Mapa -->
    <div id="mapa" class="tab-content">
      <div class="section">
        <div class="section-title">ğŸ—ºï¸ VisualizaÃ§Ã£o do Mapa</div>
        
        <!-- BotÃ£o de Sincronizar (EM CIMA DO MAPA) -->
        <button class="btn btn-secondary" onclick="sincronizarComSupabase()" 
                style="margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; position: relative; padding: 0.75rem; border: 2px solid #10b981; background: white; color: #10b981; font-weight: 600; border-radius: 8px; cursor: pointer;">
          <span>ğŸ”„</span>
          <span id="syncButtonText">Sincronizar com Banco de Dados</span>
        </button>
        
        <div id="syncMessage" style="font-size: 0.85rem; color: #6b7280; margin-bottom: 1rem; text-align: center; min-height: 1.2rem;"></div>
        
        <div class="info-box" style="margin-bottom: 1rem;">
          <strong>ğŸ“ Visualize todas as frutÃ­feras georeferenciadas no mapa</strong><br>
          <small>Clique nos pontos para ver detalhes. Use o botÃ£o acima para sincronizar novas frutÃ­feras.</small>
        </div>

        <!-- Controles do Mapa -->
        <div class="map-controls" style="margin-bottom: 1rem;">
          <button class="map-btn" data-basemap="satellite" onclick="changeBasemap('satellite', event)">
            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">ğŸ›°ï¸</div>
            <div style="font-size: 0.75rem; font-weight: 600;">SatÃ©lite</div>
          </button>
          <button class="map-btn active" data-basemap="orthomosaic" onclick="changeBasemap('orthomosaic', event)">
            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">ğŸ“¸</div>
            <div style="font-size: 0.75rem; font-weight: 600;">Ortomosaico</div>
          </button>
        </div>

        <!-- Toggle da camada de frutÃ­feras -->
        <div class="layer-toggle" style="margin-bottom: 1rem;">
          <div class="layer-label">
            <div class="layer-badge" style="color: #10b981; background-color: #10b981;"></div>
            <span style="font-weight: 500;">FrutÃ­feras no mapa</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleFrutiferas" checked onchange="toggleFrutiferasLayer()">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <!-- Legenda de EspÃ©cies -->
        <div style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border: 1px solid #e5e7eb; border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
          <div style="font-size: 0.8rem; font-weight: 700; color: #374151; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">ğŸŒ¿ Legenda por EspÃ©cie</div>
          <div id="mapLegend" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
              <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #10b981; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div>
              <span style="font-size: 0.8rem; font-weight: 500;">ğŸ¥­ Mangabeira</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
              <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #f59e0b; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div>
              <span style="font-size: 0.8rem; font-weight: 500;">ğŸŒ° Cajueiro</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
              <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #ef4444; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div>
              <span style="font-size: 0.8rem; font-weight: 500;">ğŸ¥¥ Coqueiro</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
              <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #8b5cf6; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div>
              <span style="font-size: 0.8rem; font-weight: 500;">ğŸ« Cacau</span>
            </div>
          </div>
        </div>

        <!-- Container do Mapa -->
        <div id="mapContainer" style="width: 100%; height: 50vh; min-height: 400px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; margin-bottom: 2rem;"></div>

        <!-- SeÃ§Ã£o de Cadastro (EMBAIXO DO MAPA) -->
        <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #bbf7d0; margin-top: 1rem;">
          <div class="section-title clickable" onclick="toggleCadastroForm()" 
               style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: white; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #10b981; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <span style="font-size: 1.5rem; color: #10b981;">â•</span>
              <div>
                <div style="font-weight: 700; color: #1f2937; font-size: 1.1rem;">Cadastrar Nova FrutÃ­fera</div>
                <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem;">Clique para expandir/recolher</div>
              </div>
            </div>
            <span id="cadastroToggleIcon" style="font-size: 1.5rem; color: #10b981; transition: transform 0.3s ease;">â–¼</span>
          </div>
          
          <div id="cadastroFormContainer" class="cadastro-form-container">
            <div class="info-box" style="background: white; border: 1px solid #bbf7d0; color: #065f46; margin-bottom: 1.5rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="font-size: 1.2rem;">ğŸŒ±</span>
                <strong>Como funciona:</strong>
              </div>
              <div style="font-size: 0.9rem; line-height: 1.5;">
                1. Preencha os dados da frutÃ­fera<br>
                2. Clique em "Cadastrar FrutÃ­fera"<br>
                3. A frutÃ­fera aparecerÃ¡ no mapa<br>
                4. Use o botÃ£o "Sincronizar" acima para enviar ao banco de dados
              </div>
            </div>

            <form onsubmit="cadastrarFrutifera(event)" id="formCadastroFrutifera" style="background: white; padding: 1.5rem; border-radius: 10px; border: 1px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
              <!-- EspÃ©cie -->
              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.2rem;">ğŸŒ¿</span>
                  <span style="font-weight: 600; color: #374151;">EspÃ©cie *</span>
                </label>
                <select id="novaEspecie" required style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem; background: white; transition: all 0.2s;" 
                        onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#d1d5db'">
                  <option value="">Selecione uma espÃ©cie...</option>
                  <option value="Mangabeira">ğŸ¥­ Mangabeira</option>
                  <option value="Cajueiro">ğŸŒ° Cajueiro</option>
                  <option value="Coqueiro">ğŸ¥¥ Coqueiro</option>
                  <option value="Cacau">ğŸ« Cacau</option>
                </select>
              </div>

              <!-- Data do Plantio e Idade -->
              <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0;">
                <div class="form-group">
                  <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.2rem;">ğŸ“…</span>
                    <span style="font-weight: 600; color: #374151;">Data do Plantio *</span>
                  </label>
                  <input type="date" id="dataPlantio" required style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;">
                </div>
                <div class="form-group">
                  <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.2rem;">ğŸŒ±</span>
                    <span style="font-weight: 600; color: #374151;">Idade (meses)</span>
                  </label>
                  <input type="number" id="idadeFrutifera" min="0" placeholder="Ex: 12" style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;">
                </div>
              </div>

      
              <!-- LocalizaÃ§Ã£o GPS -->
              <div class="form-group" style="margin: 1.5rem 0;">
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.2rem;">ğŸ“</span>
                  <span style="font-weight: 600; color: #374151;">LocalizaÃ§Ã£o GPS</span>
                </label>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.75rem; align-items: end;">
                  <input type="text" id="coordenadas" placeholder="Latitude, Longitude" readonly 
                         style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem; background: #f9fafb;">
                  <button type="button" onclick="obterLocalizacao()" 
                          style="padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap; transition: all 0.2s;"
                          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'"
                          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <span style="font-size: 1.2rem; margin-right: 0.5rem;">ğŸ“</span>
                    Obter GPS
                  </button>
                </div>
                <div id="coordDisplay" style="background: #f0f9ff; padding: 0.75rem; border-radius: 6px; font-size: 0.9rem; color: #0c4a6e; margin-top: 0.75rem; display: none; border: 1px solid #bae6fd;"></div>
              </div>

              <!-- ResponsÃ¡vel -->
              <div class="form-group" style="margin: 1.5rem 0;">
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.2rem;">ğŸ‘¤</span>
                  <span style="font-weight: 600; color: #374151;">ResponsÃ¡vel pelo plantio</span>
                </label>
                <input type="text" id="responsavel" placeholder="Digite o nome do responsÃ¡vel" 
                       style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;">
              </div>

              <!-- BotÃ£o de Cadastro -->
              <button type="submit" class="btn btn-primary" 
                      style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 1rem; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.75rem;"
                      onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.4)'"
                      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <span style="font-size: 1.5rem;">âœ…</span>
                <span>Cadastrar FrutÃ­fera</span>
              </button>
              
              <div style="text-align: center; margin-top: 1rem; color: #6b7280; font-size: 0.85rem;">
                <span style="display: inline-flex; align-items: center; gap: 0.25rem;">
                  <span>ğŸ’¡</span> 
                  A frutÃ­fera serÃ¡ salva localmente e aparecerÃ¡ no mapa imediatamente
                </span>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tab: FrutÃ­feras -->
    <div id="frutiferas" class="tab-content">
      <div class="section">
        <div class="section-title">ğŸŒ± Minhas FrutÃ­feras</div>
        
        <div class="info-box">
          ğŸ’¾ Dados sincronizados com Supabase
        </div>
        
        <input type="text" class="search-box" id="searchFrutifera" placeholder="ğŸ” Buscar frutÃ­fera..." onkeyup="filtrarFrutiferas()">
        
        <div style="margin-top: 1rem;" id="frutiferasList"></div>
      </div>
    </div>

    <!-- Tab: HistÃ³rico -->
    <div id="historico" class="tab-content">
      <div class="section">
        <div class="section-title">ğŸ“œ HistÃ³rico de AÃ§Ãµes</div>
        <div class="filter-group">
          <button class="filter-btn active" onclick="filterHistorico(event, '7')">Ãšltimos 7 dias</button>
          <button class="filter-btn" onclick="filterHistorico(event, '30')">Ãšltimos 30 dias</button>
          <button class="filter-btn" onclick="filterHistorico(event, 'todos')">Tudo</button>
        </div>
        <div id="historicoList">
          <div class="loading">Carregando histÃ³rico</div>
        </div>
      </div>
    </div>

    <!-- Tab: Stats -->
    <div id="stats" class="tab-content">
      <div class="section">
        <div class="section-title">ğŸ“Š EstatÃ­sticas Gerais</div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">Total FrutÃ­feras</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statPend">0</div>
            <div class="stat-label">PendÃªncias</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statUrg">0</div>
            <div class="stat-label">Urgentes</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statEsp">0</div>
            <div class="stat-label">EspÃ©cies</div>
          </div>
        </div>

        <div class="section" style="margin-top: 1rem;">
          <div class="section-title">ğŸŒ³ Resumo por EspÃ©cie</div>
          <div id="speciesSummary"></div>
        </div>
      </div>
    </div>

    <!-- Tab: Config -->
    <div id="config" class="tab-content">
      <div class="section">
        <div class="section-title">ğŸ“‹ Intervalos por EspÃ©cie (dias)</div>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">
          Ajuste os intervalos de manutenÃ§Ã£o para cada tipo de frutÃ­fera
        </p>
        
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <h3 style="margin: 0 0 1rem 0; font-size: 1rem;">ğŸ¥­ Mangabeira</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">ğŸ’§ Rega</label>
              <input type="number" id="mang_rega" value="7" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">âœ‚ï¸ Poda</label>
              <input type="number" id="mang_poda" value="180" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">ğŸŠ Colheita</label>
              <input type="number" id="mang_colh" value="90" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
        </div>

        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <h3 style="margin: 0 0 1rem 0; font-size: 1rem;">ğŸŒ° Cajueiro</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">ğŸ’§ Rega</label>
              <input type="number" id="caju_rega" value="10" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">âœ‚ï¸ Poda</label>
              <input type="number" id="caju_poda" value="365" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">ğŸŠ Colheita</label>
              <input type="number" id="caju_colh" value="60" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
        </div>

        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <h3 style="margin: 0 0 1rem 0; font-size: 1rem;">ğŸ¥¥ Coqueiro</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">ğŸ’§ Rega</label>
              <input type="number" id="coq_rega" value="5" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">âœ‚ï¸ Poda</label>
              <input type="number" id="coq_poda" value="730" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">ğŸŠ Colheita</label>
              <input type="number" id="coq_colh" value="30" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
        </div>

        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <h3 style="margin: 0 0 1rem 0; font-size: 1rem;">ğŸ« Cacau</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">ğŸ’§ Rega</label>
              <input type="number" id="cac_rega" value="3" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">âœ‚ï¸ Poda</label>
              <input type="number" id="cac_poda" value="180" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">ğŸŠ Colheita</label>
              <input type="number" id="cac_colh" value="120" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
        </div>

        <button class="btn btn-primary" onclick="saveConfig()">ğŸ’¾ Salvar Intervalos</button>
      </div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="footer-space"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script>
    /* ============================
   SCRIPT COMPLETO - SITE IPIRANGA
   ============================ */

/* CONFIG SUPABASE */
const SUPABASE_URL = 'https://erbefbnjxgpetbetlzya.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyYmVmYm5qeGdwZXRiZXRsenlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMzI4ODcsImV4cCI6MjA3NjYwODg4N30.d09pjgddZpNY3Z4cVZ3V4h77aAf_GVGF0sOBTZkZf2A';

let frutiferas = [];
let historico = [];
let perfilAtual = localStorage.getItem('perfilAtual') || 'Default';
let currentFilter = 'todas';
let pendingSync = [];

/* MAPA */
let map = null;
let baseLayers = {};
let orthomosaicLayer = null;
let frutiferasLayer = null;
let markers = {};
const speciesColors = {
  'Mangabeira': '#10b981',
  'Cajueiro': '#f59e0b',
  'Coqueiro': '#ef4444',
  'Cacau': '#8b5cf6'
};

/* DEBOUNCE MULTI-KEY */
const debounceTimers = {};
function debounce(key, func, wait) {
  return function(...args) {
    if (debounceTimers[key]) clearTimeout(debounceTimers[key]);
    debounceTimers[key] = setTimeout(() => {
      try { func.apply(this, args); } finally { delete debounceTimers[key]; }
    }, wait);
  };
}

/* Declarar debounced functions (padrÃ£o) */
const carregarAcoesHojeDebounced = debounce('acoesHoje', carregarAcoesHoje, 300);

/* UTILITÃRIOS */
function mostrarToast(msg, timeout = 3000) {
  const t = document.getElementById('toast');
  if (!t) return;
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), timeout);
}

function formatarData(d) {
  if (!d) return '';
  const dt = new Date(d);
  if (isNaN(dt)) return d;
  return dt.toLocaleDateString('pt-BR');
}

function calcularDias(d) {
  if (!d) return 999;
  const dt = new Date(d);
  return Math.floor((Date.now() - dt.getTime()) / (1000*60*60*24));
}

function obterIntervaloRega(f) {
  switch (f.especie) {
    case 'Mangabeira': return 7;
    case 'Cajueiro': return 10;
    case 'Coqueiro': return 5;
    case 'Cacau': return 3;
    default: return 7;
  }
}
function obterIntervaloPoda(f) {
  switch (f.especie) {
    case 'Mangabeira': return 180;
    case 'Cajueiro': return 365;
    case 'Coqueiro': return 730;
    case 'Cacau': return 180;
    default: return 180;
  }
}
function obterIntervaloColheita(f) {
  switch (f.especie) {
    case 'Mangabeira': return 90;
    case 'Cajueiro': return 60;
    case 'Coqueiro': return 30;
    case 'Cacau': return 120;
    default: return 90;
  }
}

/* CARREGAR FRUTÃFERAS (do Supabase ou cache) */
async function carregarFrutiferas() {
  console.log('ğŸ”¥ Carregando frutÃ­feras do Supabase...');
  try {
    if (navigator.onLine) {
      const resp = await fetch(`${SUPABASE_URL}/rest/v1/frutiferas?select=*`, {
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
        }
      });
      if (resp.ok) {
        const dados = await resp.json();
        frutiferas = dados.map(f => ({
          id: f.id,
          fid: f.fid,
          especie: f.nome_popular,
          nome_popular: f.nome_popular,
          identificacao: f.fid,
          data_plantio: f.data_plantio || null,
          ultima_rega: f.data_irrigacao_ordinaria || null,
          ultima_poda: f.data_poda_formacao_1 || null,
          ultima_colheita: f.inicio_colheita || null,
          latitude: f.latitude || null,
          longitude: f.longitude || null,
          altura_total: f.altura_total || null,
          diametro_copa: f.diametro_copa || null,
          created_at: f.created_at || new Date().toISOString()
        }));
        localStorage.setItem('frutiferas', JSON.stringify(frutiferas));
        console.log(`âœ… ${frutiferas.length} frutÃ­feras carregadas do Supabase`);
        atualizarTodasAbas({ skipAcoesHoje: true }); // evitar loop
        if (document.getElementById('mapa') && document.getElementById('mapa').classList.contains('active')) {
          atualizarMapa();
        }
      } else {
        console.error('Erro na resposta do Supabase:', resp.status);
        carregarDoCache();
      }
    } else {
      console.log('ğŸ“¡ Modo offline - carregando do cache');
      carregarDoCache();
    }
  } catch (err) {
    console.error('âŒ Erro ao carregar frutÃ­feras:', err);
    mostrarToast('âš ï¸ Erro ao carregar. Usando dados locais.');
    carregarDoCache();
  }
}

function carregarDoCache() {
  const localData = JSON.parse(localStorage.getItem('frutiferas') || '[]');
  if (localData.length > 0) {
    frutiferas = localData;
    console.log(`ğŸ“¦ ${frutiferas.length} frutÃ­feras do cache local`);
    atualizarTodasAbas({ skipAcoesHoje: true });
  }
}

/* ATUALIZAÃ‡ÃƒO GERAL DA UI */
function atualizarTodasAbas(options = {}) {
  console.log('ğŸ”„ Atualizando UI com', frutiferas.length, 'frutÃ­feras');
  const fc = document.getElementById('frutiferaCount');
  if (fc) fc.textContent = `ğŸ“Š ${frutiferas.length} frutÃ­feras`;
  atualizarListaFrutiferas();
  atualizarStats();
  if (!options.skipAcoesHoje) carregarAcoesHojeDebounced();
}

/* LISTA DE FRUTÃFERAS */
function atualizarListaFrutiferas() {
  const lista = document.getElementById('frutiferasList');
  if (!lista) return;
  if (frutiferas.length === 0) {
    lista.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸŒ±</div>
        <p>Nenhuma frutÃ­fera cadastrada ainda.</p>
        <p><small>VÃ¡ para a aba "Mapa" para adicionar sua primeira frutÃ­fera!</small></p>
      </div>`;
    return;
  }
  lista.innerHTML = frutiferas.map(f => `
    <div class="frutifera-card" onclick="mostrarDetalhesFrutifera('${f.id || f.fid || f.identificacao}')">
      <div class="frutifera-header">
        <div class="frutifera-name">${f.nome_popular || f.especie}</div>
        <span class="badge">${f.identificacao || f.id || f.fid}</span>
      </div>
      <div class="frutifera-info">
        <div>ğŸ“… Plantio: ${formatarData(f.data_plantio) || 'Sem data'}</div>
        <div>ğŸ’§ Ãšltima rega: ${formatarData(f.ultima_rega) || 'Nunca'}</div>
        <div>âœ‚ï¸ Ãšltima poda: ${formatarData(f.ultima_poda) || 'Nunca'}</div>
        ${f.latitude && f.longitude ? `<div>ğŸ“ GPS: ${f.latitude.toFixed(6)}, ${f.longitude.toFixed(6)}</div>` : ''}
      </div>
    </div>
  `).join('');
}

/* MOSTRAR DETALHES */
function mostrarDetalhesFrutifera(id) {
  const f = frutiferas.find(x => x.id === id || x.fid === id || x.identificacao === id);
  if (!f) return;
  const modal = document.createElement('div');
  modal.innerHTML = `
    <div style="position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,.5); z-index:2000; display:flex; align-items:center; justify-content:center;">
      <div style="background:white; border-radius:12px; padding:1.25rem; width:90%; max-width:420px; max-height:80vh; overflow:auto;">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem;">
          <h3 style="margin:0; color:#10b981;">${f.nome_popular || f.especie}</h3>
          <button style="background:none; border:none; font-size:1.4rem; cursor:pointer;" onclick="this.closest('div[style]').parentElement.remove()">Ã—</button>
        </div>
        <div style="font-size:0.95rem; color:#374151;">
          <div><strong>CÃ³digo:</strong> ${f.identificacao || f.id || f.fid}</div>
          ${f.data_plantio ? `<div><strong>Plantio:</strong> ${formatarData(f.data_plantio)}</div>` : ''}
          ${f.ultima_rega ? `<div><strong>Ãšltima rega:</strong> ${formatarData(f.ultima_rega)} (${calcularDias(f.ultima_rega)} dias atrÃ¡s)</div>` : ''}
          ${f.ultima_poda ? `<div><strong>Ãšltima poda:</strong> ${formatarData(f.ultima_poda)} (${calcularDias(f.ultima_poda)} dias atrÃ¡s)</div>` : ''}
          ${f.latitude && f.longitude ? `<div><strong>LocalizaÃ§Ã£o:</strong> ${f.latitude.toFixed(6)}, ${f.longitude.toFixed(6)}</div>` : ''}
        </div>
        <div style="margin-top:1rem;">
          <button style="width:100%; padding:.75rem; border-radius:8px; background:#10b981; color:white; border:none;" onclick="this.closest('div[style]').parentElement.remove()">Fechar</button>
        </div>
      </div>
    </div>
  `;
  document.body.appendChild(modal.firstElementChild);
}

/* CARREGAR AÃ‡Ã•ES HOJE */
function carregarAcoesHoje() {
  console.log('ğŸ“‹ carregarAcoesHoje() executando...');
  const container = document.getElementById('acoesHoje');
  if (!container) return;

  if (frutiferas.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ğŸ“‹</div>
        <p>Nenhuma frutÃ­fera cadastrada.</p>
        <p><small>Cadastre frutÃ­feras para ver as aÃ§Ãµes pendentes</small></p>
      </div>`;
    document.getElementById('actionCount').textContent = 'ğŸ“‹ 0 aÃ§Ãµes';
    return;
  }

  const acoesPorEspecie = {
    'Mangabeira': { rega: [], poda: [], colheita: [], icone: 'ğŸ¥­' },
    'Cajueiro': { rega: [], poda: [], colheita: [], icone: 'ğŸŒ°' },
    'Coqueiro': { rega: [], poda: [], colheita: [], icone: 'ğŸ¥¥' },
    'Cacau': { rega: [], poda: [], colheita: [], icone: 'ğŸ«' }
  };

  frutiferas.forEach(f => {
    const especie = f.especie || f.nome_popular || 'Desconhecida';
    if (!acoesPorEspecie[especie]) return;

    const diasRega = f.ultima_rega ? calcularDias(f.ultima_rega) : 999;
    const intervaloRega = obterIntervaloRega(f);
    if (diasRega >= intervaloRega) {
      acoesPorEspecie[especie].rega.push({
        tipo: 'rega',
        urgencia: diasRega >= (intervaloRega + 2) ? 'urgent' : 'warning',
        frutifera: f,
        dias: diasRega,
        titulo: `Regar ${f.nome_popular || f.especie}`,
        descricao: `Ãšltima rega: ${diasRega === 999 ? 'Nunca' : diasRega + ' dias atrÃ¡s'}`
      });
    }

    const diasPoda = f.ultima_poda ? calcularDias(f.ultima_poda) : 999;
    const intervaloPoda = obterIntervaloPoda(f);
    if (diasPoda >= intervaloPoda) {
      acoesPorEspecie[especie].poda.push({
        tipo: 'poda',
        urgencia: 'warning',
        frutifera: f,
        dias: diasPoda,
        titulo: `Podar ${f.nome_popular || f.especie}`,
        descricao: `Ãšltima poda: ${diasPoda === 999 ? 'Nunca' : diasPoda + ' dias atrÃ¡s'}`
      });
    }

    const diasColheita = f.ultima_colheita ? calcularDias(f.ultima_colheita) : 999;
    const intervaloColheita = obterIntervaloColheita(f);
    if (diasColheita >= intervaloColheita) {
      acoesPorEspecie[especie].colheita.push({
        tipo: 'colheita',
        urgencia: 'normal',
        frutifera: f,
        dias: diasColheita,
        titulo: `Colher ${f.nome_popular || f.especie}`,
        descricao: `Ãšltima colheita: ${diasColheita === 999 ? 'Nunca' : diasColheita + ' dias atrÃ¡s'}`
      });
    }
  });

  let totalAcoes = 0;
  Object.values(acoesPorEspecie).forEach(es => totalAcoes += es.rega.length + es.poda.length + es.colheita.length);

  if (document.getElementById('actionCount')) document.getElementById('actionCount').textContent = `ğŸ“‹ ${totalAcoes} aÃ§Ãµes`;

  if (totalAcoes === 0) {
    container.innerHTML = `<div class="info-box success-box">âœ… <strong>Tudo em dia!</strong><br>Nenhuma aÃ§Ã£o pendente no momento.</div>`;
    return;
  }

  // Gerar HTML por espÃ©cie
  let html = '';
  Object.entries(acoesPorEspecie).forEach(([especie, dados]) => {
    const totalEspecie = dados.rega.length + dados.poda.length + dados.colheita.length;
    if (totalEspecie === 0) return;

    let acoesFiltradas = [];
    if (currentFilter === 'todas') {
      acoesFiltradas = [...dados.rega, ...dados.poda, ...dados.colheita];
    } else if (currentFilter === 'urgente') {
      acoesFiltradas = [...dados.rega.filter(a => a.urgencia === 'urgent'),
                        ...dados.poda.filter(a => a.urgencia === 'urgent'),
                        ...dados.colheita.filter(a => a.urgencia === 'urgent')];
    } else if (currentFilter === 'rega') acoesFiltradas = dados.rega;
    else if (currentFilter === 'poda') acoesFiltradas = dados.poda;
    else if (currentFilter === 'colheita') acoesFiltradas = dados.colheita;

    if (acoesFiltradas.length === 0) return;

    const especieId = especie.toLowerCase().replace(/\s+/g, '-');
    html += `
      <div class="especie-section">
        <div class="especie-header" onclick="toggleEspecieSection('${especieId}')" style="display:flex;align-items:center;justify-content:space-between;padding:0.75rem;border-radius:8px;background:#fff;margin-bottom:0.5rem;border:1px solid #e5e7eb;cursor:pointer;">
          <div style="display:flex;align-items:center;gap:0.75rem;">
            <span style="font-size:1.5rem;">${dados.icone}</span>
            <div>
              <div style="font-weight:700;color:#1f2937">${especie}</div>
              <div style="font-size:0.85rem;color:#6b7280">${acoesFiltradas.length} aÃ§Ã£o(Ãµes) pendente(s)</div>
            </div>
          </div>
          <span id="toggle-${especieId}" style="font-size:1.1rem;color:#10b981;transform:rotate(180deg);">â–¼</span>
        </div>
        <div id="content-${especieId}" class="especie-content" style="max-height:2000px;overflow:hidden;transition:max-height .4s;">`;

    acoesFiltradas.forEach(acao => {
      const frId = acao.frutifera.id || acao.frutifera.fid || acao.frutifera.identificacao;
      const actionKey = `action-${frId}-${acao.tipo}`;
      const isDone = localStorage.getItem(actionKey) === 'true';
      const borderColor = isDone ? '#10b981' : (acao.urgencia === 'urgent' ? '#ef4444' : acao.urgencia === 'warning' ? '#f59e0b' : '#10b981');
      const bg = isDone ? '#f0fdf4' : (acao.urgencia === 'urgent' ? '#fef2f2' : acao.urgencia === 'warning' ? '#fffbeb' : '#f0fdf4');

      html += `
        <div class="action-item" style="border-left:4px solid ${borderColor};background:${bg};border-radius:8px;padding:1rem;margin-bottom:0.75rem;">
          ${isDone ? `<div style="position:absolute;right:1rem;top:-8px;background:#10b981;color:white;padding:4px 8px;border-radius:12px;font-size:0.75rem;">âœ… Feito</div>` : ''}
          <div class="action-title" style="font-weight:700;margin-bottom:0.5rem;">
            ${acao.urgencia === 'urgent' ? 'ğŸš¨' : acao.tipo === 'rega' ? 'ğŸ’§' : acao.tipo === 'poda' ? 'âœ‚ï¸' : 'ğŸŠ'}
            ${acao.titulo}
          </div>
          <div class="action-desc" style="color:#4b5563;margin-bottom:0.5rem;">${acao.descricao}</div>
          <div style="font-size:0.8rem;color:#6b7280;margin-bottom:0.5rem;">CÃ³digo: ${acao.frutifera.identificacao || acao.frutifera.id} ${acao.frutifera.latitude && acao.frutifera.longitude ? `â€¢ ğŸ“ ${acao.frutifera.latitude.toFixed(4)}, ${acao.frutifera.longitude.toFixed(4)}` : ''}</div>
          <button onclick="toggleAction('${acao.tipo}','${frId}','${actionKey}', event)" style="width:100%;padding:.75rem;border-radius:8px;border:none;font-weight:600;cursor:pointer;background:linear-gradient(135deg,#10b981 0%,#059669 100%);color:white;">
            ${isDone ? 'Desmarcar' : 'Marcar como feito'}
          </button>
        </div>`;
    });

    html += `</div></div>`;
  });

  if (html === '') {
    html = `<div class="info-box">â„¹ï¸ <strong>Nenhuma aÃ§Ã£o encontrada</strong><br>Com o filtro atual, nÃ£o hÃ¡ aÃ§Ãµes para exibir.</div>`;
  }

  container.innerHTML = html;

  // abrir todas as seÃ§Ãµes por padrÃ£o
  Object.keys(acoesPorEspecie).forEach(especie => {
    const id = especie.toLowerCase().replace(/\s+/g, '-');
    const content = document.getElementById(`content-${id}`);
    const toggle = document.getElementById(`toggle-${id}`);
    if (content && toggle) {
      content.style.maxHeight = '2000px';
      toggle.style.transform = 'rotate(180deg)';
    }
  });
}

/* MARCAR / DESMARCAR AÃ‡ÃƒO */
function toggleAction(tipo, frutiferaId, actionId, event) {
  event.stopPropagation();
  const key = actionId;
  const isDone = localStorage.getItem(key) === 'true';
  if (isDone) localStorage.removeItem(key); else localStorage.setItem(key, 'true');
  carregarAcoesHojeDebounced();
}

/* TOGGLE SEÃ‡ÃƒO ESPÃ‰CIE */
function toggleEspecieSection(especieId) {
  const content = document.getElementById(`content-${especieId}`);
  const toggle = document.getElementById(`toggle-${especieId}`);
  if (!content || !toggle) return;
  if (content.style.maxHeight === '0px' || !content.style.maxHeight) {
    content.style.maxHeight = '2000px';
    toggle.style.transform = 'rotate(180deg)';
  } else {
    content.style.maxHeight = '0px';
    toggle.style.transform = 'rotate(0deg)';
  }
}

/* FILTROS E ABAS */
function switchTab(e, tab) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  if (e && e.currentTarget) e.currentTarget.classList.add('active');
  document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));
  const el = document.getElementById(tab);
  if (el) el.classList.add('active');

  if (tab === 'mapa') setTimeout(() => atualizarMapa(), 150);
}

function filterAcoes(e, tipo) {
  currentFilter = tipo;
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  if (e && e.currentTarget) e.currentTarget.classList.add('active');
  carregarAcoesHojeDebounced();
}

function filterHistorico(e, periodo) {
  // periodo: '7','30','todos'
  document.querySelectorAll('#historico .filter-btn').forEach(b => b.classList.remove('active'));
  if (e && e.currentTarget) e.currentTarget.classList.add('active');

  const days = periodo === 'todos' ? null : parseInt(periodo, 10);
  const list = document.getElementById('historicoList');
  if (!list) return;

  // exemplo simples: histÃ³rico salvo em localStorage (array de eventos)
  const all = JSON.parse(localStorage.getItem('historico') || '[]');
  const filtered = days ? all.filter(h => (Date.now() - new Date(h.date).getTime()) <= days * 24 * 3600 * 1000) : all;
  if (filtered.length === 0) {
    list.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ğŸ“œ</div><p>Nenhum registro no perÃ­odo selecionado.</p></div>`;
    return;
  }
  list.innerHTML = filtered.map(h => `<div style="padding:.75rem;border-bottom:1px solid #eee;">${formatarData(h.date)} â€” ${h.text}</div>`).join('');
}

/* SINCRONIZAÃ‡ÃƒO COM SUPABASE (exemplo simples) */
async function sincronizarComSupabase() {
  const syncMessage = document.getElementById('syncMessage');
  if (syncMessage) syncMessage.textContent = 'Sincronizando...';
  try {
    // Implementar lÃ³gica real de push das pendingSync se necessÃ¡rio.
    // Aqui forÃ§amos recarregar a fonte de verdade:
    await carregarFrutiferas();
    if (syncMessage) syncMessage.textContent = 'Sincronizado com sucesso.';
    mostrarToast('ğŸ”„ Sincronizado com sucesso');
    carregarAcoesHojeDebounced();
  } catch (err) {
    console.error(err);
    if (syncMessage) syncMessage.textContent = 'Erro ao sincronizar';
    mostrarToast('Erro ao sincronizar');
  }
}

/* SALVAR CONFIG */
function saveConfig() {
  const keys = ['mang_rega','mang_poda','mang_colh','caju_rega','caju_poda','caju_colh','coq_rega','coq_poda','coq_colh','cac_rega','cac_poda','cac_colh'];
  const cfg = {};
  keys.forEach(k => { const el = document.getElementById(k); if (el) cfg[k] = el.value; });
  localStorage.setItem('site_config', JSON.stringify(cfg));
  mostrarToast('ğŸ’¾ ConfiguraÃ§Ãµes salvas');
  carregarAcoesHojeDebounced();
}

/* CADASTRO DE FRUTÃFERA */
function cadastrarFrutifera(e) {
  if (e) e.preventDefault();
  const especie = (document.getElementById('novaEspecie') || {}).value || 'Desconhecida';
  const dataPlantio = (document.getElementById('dataPlantio') || {}).value || null;
  const idade = (document.getElementById('idadeFrutifera') || {}).value || null;
  const coordenadas = (document.getElementById('coordenadas') || {}).value || null;
  const responsavel = (document.getElementById('responsavel') || {}).value || null;

  const novo = {
    id: 'local-' + Date.now(),
    especie,
    nome_popular: especie,
    identificacao: 'LOCAL-' + Date.now(),
    data_plantio: dataPlantio,
    ultima_rega: null,
    ultima_poda: null,
    ultima_colheita: null,
    responsavel: responsavel || null
  };
  if (coordenadas) {
    const parts = coordenadas.split(',');
    novo.latitude = parseFloat(parts[0]);
    novo.longitude = parseFloat(parts[1]);
  }

  frutiferas.push(novo);
  localStorage.setItem('frutiferas', JSON.stringify(frutiferas));
  mostrarToast('âœ… FrutÃ­fera cadastrada localmente');
  atualizarTodasAbas();
  pendingSync.push(novo);
}

/* OBTER LOCALIZAÃ‡ÃƒO (botÃ£o 'Obter GPS') */
function obterLocalizacao() {
  const coordInput = document.getElementById('coordenadas');
  const coordDisplay = document.getElementById('coordDisplay');
  if (!navigator.geolocation) {
    mostrarToast('Navegador nÃ£o suporta geolocalizaÃ§Ã£o');
    return;
  }
  mostrarToast('Aguardando GPS (atÃ© 20s)...', 2000);
  navigator.geolocation.getCurrentPosition(pos => {
    const lat = pos.coords.latitude;
    const lon = pos.coords.longitude;
    if (coordInput) coordInput.value = `${lat.toFixed(6)}, ${lon.toFixed(6)}`;
    if (coordDisplay) {
      coordDisplay.style.display = 'block';
      coordDisplay.textContent = `Lat: ${lat.toFixed(6)}, Lon: ${lon.toFixed(6)}`;
    }
    mostrarToast('ğŸ“ Coordenadas obtidas');
  }, err => {
    console.error(err);
    mostrarToast('Erro ao obter GPS');
  }, { enableHighAccuracy: true, timeout: 20000 });
}

/* TOGGLE FORM CADASTRO */
function toggleCadastroForm() {
  const cont = document.getElementById('cadastroFormContainer');
  const icon = document.getElementById('cadastroToggleIcon');
  if (!cont) return;
  if (cont.classList.contains('collapsed')) {
    cont.classList.remove('collapsed');
    if (icon) icon.style.transform = 'rotate(0deg)';
  } else {
    cont.classList.add('collapsed');
    if (icon) icon.style.transform = 'rotate(180deg)';
  }
}

/* LAYERS / BASEMAPS (simples) */
let currentBasemap = 'ortomosaic';
function changeBasemap(name, e) {
  currentBasemap = name;
  document.querySelectorAll('.map-btn').forEach(b => b.classList.remove('active'));
  if (e && e.currentTarget) e.currentTarget.classList.add('active');
  // implementaÃ§Ã£o simples: se quiser, carregue tiles diferentes
  // por enquanto, sÃ³ dispara um toast e mantÃ©m OSM padrÃ£o
  mostrarToast(`Base trocada para: ${name}`);
}

/* TOGGLE VISIBILIDADE FRUTÃFERAS */
function toggleFrutiferasLayer() {
  const checkbox = document.getElementById('toggleFrutiferas');
  if (!checkbox || !frutiferasLayer || !map) return;
  if (checkbox.checked) {
    frutiferasLayer.addTo(map);
  } else {
    map.removeLayer(frutiferasLayer);
  }
}

/* MAP: atualizar marcadores */
function atualizarMapa() {
  const container = document.getElementById('mapContainer');
  if (!container) return;
  if (!map) {
    map = L.map('mapContainer', { preferCanvas: true }).setView([-3.7, -38.5], 14);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);
  }
  if (frutiferasLayer) frutiferasLayer.clearLayers();
  frutiferasLayer = L.layerGroup().addTo(map);
  frutiferas.forEach(f => {
    if (f.latitude && f.longitude) {
      const color = speciesColors[f.especie] || '#10b981';
      const marker = L.circleMarker([f.latitude, f.longitude], { radius: 7, color, weight: 2, fillOpacity: 0.9 });
      marker.bindPopup(`<div class="popup-content"><h3>${f.nome_popular || f.especie}</h3><div class="info-row"><div class="info-label">ID</div><div class="info-value">${f.identificacao || f.id}</div></div></div>`);
      frutiferasLayer.addLayer(marker);
    }
  });
}

/* ESTATÃSTICAS */
function atualizarStats() {
  const total = frutiferas.length;
  const pend = (() => {
    let cnt = 0;
    frutiferas.forEach(f => {
      if (calcularDias(f.ultima_rega) >= obterIntervaloRega(f)) cnt++;
      if (calcularDias(f.ultima_poda) >= obterIntervaloPoda(f)) cnt++;
    });
    return cnt;
  })();
  const urg = (() => {
    let cnt = 0;
    frutiferas.forEach(f => {
      if (calcularDias(f.ultima_rega) >= obterIntervaloRega(f) + 2) cnt++;
    });
    return cnt;
  })();
  const elTotal = document.getElementById('statTotal'); if (elTotal) elTotal.textContent = total;
  const elPend = document.getElementById('statPend'); if (elPend) elPend.textContent = pend;
  const elUrg = document.getElementById('statUrg'); if (elUrg) elUrg.textContent = urg;
  const elEsp = document.getElementById('statEsp'); if (elEsp) elEsp.textContent = new Set(frutiferas.map(f => f.especie)).size;
  // resumo por espÃ©cie
  const summaryEl = document.getElementById('speciesSummary');
  if (summaryEl) {
    const counts = {};
    frutiferas.forEach(f => { counts[f.especie] = (counts[f.especie] || 0) + 1; });
    summaryEl.innerHTML = Object.entries(counts).map(([k,v]) => `<div style="padding:.5rem;background:#fff;border-radius:8px;margin-bottom:.25rem;">${k}: <strong>${v}</strong></div>`).join('') || '<div class="empty-state"><p>Nenhuma frutÃ­fera.</p></div>';
  }
}

/* INICIALIZAÃ‡ÃƒO */
window.addEventListener('load', () => {
  // esconder loader
  const loader = document.getElementById('appLoader'); if (loader) loader.classList.add('hidden');
  const main = document.getElementById('mainApp'); if (main) main.classList.add('loaded');

  // carregar config salvo
  const cfg = JSON.parse(localStorage.getItem('site_config') || '{}');
  Object.keys(cfg).forEach(k => { const el = document.getElementById(k); if (el) el.value = cfg[k]; });

  // carregar frutiferas
  carregarFrutiferas();

  // chamar aÃ§Ãµes de forma controlada no final
  setTimeout(() => carregarAcoesHojeDebounced(), 600);

  // ligar eventos que dependem do DOM (caso nÃ£o estejam inline)
  const toggle = document.getElementById('toggleFrutiferas');
  if (toggle) toggle.addEventListener('change', toggleFrutiferasLayer);

  // garantir mapa se jÃ¡ na aba mapa
  if (document.getElementById('mapa') && document.getElementById('mapa').classList.contains('active')) {
    setTimeout(() => atualizarMapa(), 200);
  }
});

    function inicializarMapa() {
      if (map) return;
      
      map = L.map('mapContainer').setView([-7.1195, -34.8450], 13);
      
      baseLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Esri, Maxar',
        maxZoom: 19
      });
      
      const orthoBounds = [
        [-7.2567123407225420, -34.8508400655581880],
        [-7.2534701604245848, -34.8470106189991711]
      ];

      orthomosaicLayer = L.imageOverlay('orthomosaic.jpeg', orthoBounds, {
        opacity: 1,
        attribution: 'Ortomosaico SÃ­tio Ipiranga'
      }).addTo(map);

      frutiferasLayer = L.layerGroup().addTo(map);
      map.fitBounds(orthoBounds);
      atualizarMapa();
    }

    function atualizarMapa() {
      if (!map || !frutiferasLayer) return;
      
      frutiferasLayer.clearLayers();
      markers = {};
      
      const bounds = [];
      
      frutiferas.forEach(f => {
        if (f.latitude && f.longitude) {
          const color = speciesColors[f.especie] || '#10b981';
          
          const marker = L.circleMarker([f.latitude, f.longitude], {
            radius: 8,
            fillColor: color,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
          });

          const popupContent = `
            <div class="popup-content">
              <h3>${f.nome_popular || f.especie}</h3>
              <div class="info-row">
                <span class="info-label">CÃ³digo:</span>
                <span class="info-value">${f.identificacao || f.id}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Data Plantio:</span>
                <span class="info-value">${formatarData(f.data_plantio) || 'NÃ£o informado'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Ãšltima Rega:</span>
                <span class="info-value">${formatarData(f.ultima_rega) || 'Nunca'}</span>
              </div>
              ${f.altura_total ? `
              <div class="info-row">
                <span class="info-label">Altura:</span>
                <span class="info-value">${f.altura_total} m</span>
              </div>` : ''}
            </div>
          `;

          marker.bindPopup(popupContent);
          frutiferasLayer.addLayer(marker);
          markers[f.id] = marker;
          bounds.push([f.latitude, f.longitude]);
        }
      });

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [50, 50] });
      }
    }

    function changeBasemap(basemapType, event) {
      document.querySelectorAll('.map-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      Object.values(baseLayers).forEach(layer => {
        if (map.hasLayer(layer)) map.removeLayer(layer);
      });
      
      if (orthomosaicLayer && map.hasLayer(orthomosaicLayer)) {
        map.removeLayer(orthomosaicLayer);
      }
      
      if (basemapType === 'orthomosaic') {
        orthomosaicLayer.addTo(map);
        const orthoBounds = [
          [-7.2567123407225420, -34.8508400655581880],
          [-7.2534701604245848, -34.8470106189991711]
        ];
        map.fitBounds(orthoBounds);
      } else if (basemapType === 'satellite') {
        baseLayers.satellite.addTo(map);
        const markerBounds = Object.values(markers).map(m => m.getLatLng());
        if (markerBounds.length > 0) {
          map.fitBounds(markerBounds, { padding: [50, 50] });
        }
      }
    }

    function toggleFrutiferasLayer() {
      const isChecked = document.getElementById('toggleFrutiferas').checked;
      if (isChecked) {
        frutiferasLayer.addTo(map);
      } else {
        map.removeLayer(frutiferasLayer);
      }
    }

    function toggleCadastroForm() {
      const container = document.getElementById('cadastroFormContainer');
      const icon = document.getElementById('cadastroToggleIcon');
      
      if (container.classList.contains('collapsed')) {
        container.classList.remove('collapsed');
        icon.textContent = 'â–¼';
      } else {
        container.classList.add('collapsed');
        icon.textContent = 'â–¶';
      }
    }

    function calcularDias(dataString) {
      if (!dataString) return 999;
      const data = new Date(dataString);
      const hoje = new Date();
      const diff = hoje - data;
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    function formatarData(dataString) {
      if (!dataString) return null;
      const data = new Date(dataString);
      return data.toLocaleDateString('pt-BR');
    }

    function mostrarToast(mensagem) {
      const toast = document.getElementById('toast');
      toast.textContent = mensagem;
      toast.className = 'toast show';
      
      setTimeout(() => {
        toast.className = 'toast';
      }, 3000);
    }

    function switchTab(event, tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      if (tabName === 'mapa') {
        setTimeout(() => {
          if (!map) {
            inicializarMapa();
          } else {
            map.invalidateSize();
            atualizarMapa();
          }
        }, 100);
      }
      
      // Se for a tab AÃ§Ãµes, recarregar as aÃ§Ãµes
      if (tabName === 'acoes') {
        setTimeout(() => {
          carregarAcoesHoje();
        }, 100);
      }
    }

    function filterAcoes(event, filtro) {
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      currentFilter = filtro;
      carregarAcoesHoje();
    }

    function filtrarFrutiferas() {
      const query = document.getElementById('searchFrutifera').value.toLowerCase();
      const cards = document.querySelectorAll('.frutifera-card');
      
      cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        card.style.display = text.includes(query) ? 'block' : 'none';
      });
    }

    function filterHistorico(event, periodo) {
      document.querySelectorAll('#historico .filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
    }

    /* ============================================================
   OBTER LOCALIZAÃ‡ÃƒO (corrigido + otimizado)
   ============================================================ */
function obterLocalizacao() {

    if (!navigator.geolocation) {
        mostrarToast('âŒ GeolocalizaÃ§Ã£o nÃ£o suportada');
        return;
    }

    mostrarToast('ğŸ“ Obtendo localizaÃ§Ã£o...');

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const lat = position.coords.latitude.toFixed(6);
            const lon = position.coords.longitude.toFixed(6);

            const coordInput = document.getElementById('coordenadas');
            const coordDisplay = document.getElementById('coordDisplay');

            if (coordInput) coordInput.value = `${lat}, ${lon}`;

            if (coordDisplay) {
                coordDisplay.style.display = 'block';
                coordDisplay.textContent = `âœ… LocalizaÃ§Ã£o obtida: ${lat}, ${lon}`;
            }

            mostrarToast('âœ… LocalizaÃ§Ã£o obtida!');
        },
        (error) => {
            console.error('Erro ao obter localizaÃ§Ã£o:', error);

            let msg = 'âŒ Erro ao obter localizaÃ§Ã£o';

            if (error.code === 1) msg = "âŒ PermissÃ£o negada";
            if (error.code === 2) msg = "âŒ LocalizaÃ§Ã£o indisponÃ­vel";
            if (error.code === 3) msg = "â³ Tempo esgotado";

            mostrarToast(msg);
        },
        { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );
}

/* ============================================================
   INICIALIZAÃ‡ÃƒO (compatÃ­vel com seu HTML)
   ============================================================ */
function inicializarApp() {

    console.log("ğŸš€ Inicializando app...");

    // Oculta loader e exibe app
    const loader = document.getElementById("appLoader");
    if (loader) loader.classList.add("hidden");

    const main = document.getElementById("mainApp");
    if (main) main.classList.add("loaded");

    // Carrega configuraÃ§Ãµes salvas
    const cfg = JSON.parse(localStorage.getItem("site_config") || "{}");
    Object.keys(cfg).forEach(k => {
        const el = document.getElementById(k);
        if (el) el.value = cfg[k];
    });

    // Carrega frutÃ­feras + atualiza UI
    carregarFrutiferas().then(() => {
        console.log("âœ… App inicializado com sucesso!");
        carregarAcoesHojeDebounced();
    });
}

/* ============================================================
   ACIONAR INICIALIZAÃ‡ÃƒO COMO NO SEU HTML ORIGINAL
   ============================================================ */
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarApp);
} else {
    inicializarApp();
}

</script>
</body>
</html>
