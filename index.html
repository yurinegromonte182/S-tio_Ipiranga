<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="App para gest√£o e monitoramento das frut√≠feras do S√≠tio Ipiranga">
  <meta name="theme-color" content="#10b981">
  <title>S√≠tio Ipiranga - Gest√£o de Frut√≠feras</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="S√≠tio Ipiranga">
  
  <!-- Bootstrap CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
  
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  
  <style>
    /* ============================================ */
    /* VARI√ÅVEIS CSS CUSTOMIZADAS */
    /* ============================================ */
    :root {
      --sidebar-width: 380px;
      --header-height: 64px;
      --font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    }

    /* ============================================ */
    /* CONFIGURA√á√ïES GLOBAIS */
    /* ============================================ */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-family);
      overflow: hidden;
    }

    /* ============================================ */
    /* LOADING SCREEN */
    /* ============================================ */
    #appLoader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      transition: opacity 0.3s;
    }

    #appLoader.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loader-icon {
      font-size: 4rem;
      animation: bounce 1s infinite;
      margin-bottom: 1rem;
    }

    .loader-text {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .loader-progress {
      width: 200px;
      height: 4px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .loader-bar {
      height: 100%;
      background: white;
      width: 0%;
      animation: progressBar 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    @keyframes progressBar {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    /* ============================================ */
    /* CABE√áALHO / HEADER */
    /* ============================================ */
    .navbar {
      height: var(--header-height);
      z-index: 1000;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    /* ============================================ */
    /* CONTAINER PRINCIPAL */
    /* ============================================ */
    .main-container {
      height: 100vh;
      padding-top: var(--header-height);
      display: flex;
    }

    /* ============================================ */
    /* BARRA LATERAL / SIDEBAR */
    /* ============================================ */
    .sidebar {
      width: var(--sidebar-width);
      padding: 1.5rem;
      z-index: 100;
      background-color: #f8f9fa;
      overflow-y: auto;
      border-right: 1px solid #e5e7eb;
    }

    .sidebar::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar::-webkit-scrollbar-track {
      background: #f3f4f6;
    }

    .sidebar::-webkit-scrollbar-thumb {
      background: #d1d5db;
      border-radius: 3px;
    }

    /* ============================================ */
    /* PAIN√âIS DE CARDS */
    /* ============================================ */
    .card {
      border: 1px solid #e5e7eb;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      margin-bottom: 1rem;
    }

    .card-header {
      padding: 1rem 1.25rem;
      background-color: white;
      border-bottom: 1px solid #e5e7eb;
      font-weight: 600;
      color: #374151;
    }

    .stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1rem;
      border-radius: 0.5rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .stat-card .number {
      font-size: 2rem;
      font-weight: bold;
      margin-bottom: 0.25rem;
    }

    .stat-card .label {
      font-size: 0.875rem;
      opacity: 0.9;
    }

    /* ============================================ */
    /* MAPAS BASE */
    /* ============================================ */
    .basemap-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }

    .basemap-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background-color: #f9fafb;
      border: 2px solid #e5e7eb;
      border-radius: 0.5rem;
      cursor: pointer;
      transition: all 0.2s ease;
      font-size: 0.875rem;
      font-weight: 500;
      color: #374151;
    }

    .basemap-btn:hover {
      background-color: #dbeafe;
      border-color: #1e40af;
      color: #1e40af;
    }

    .basemap-btn.active {
      background-color: #1e40af;
      border-color: #1e3a8a;
      color: white;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .basemap-btn i {
      font-size: 1.5rem;
    }

    /* ============================================ */
    /* ITENS DE CAMADAS */
    /* ============================================ */
    .layer-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      background-color: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 0.5rem;
      margin-bottom: 0.5rem;
      transition: all 0.2s ease;
    }

    .layer-item:hover {
      background-color: #dbeafe;
      border-color: #1e40af;
    }

    .layer-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .layer-badge {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      border: 3px solid currentColor;
    }

    .layer-label {
      font-weight: 500;
      color: #374151;
      font-size: 0.875rem;
    }

    /* ============================================ */
    /* SWITCH DE CAMADAS (Toggle) */
    /* ============================================ */
    .layer-switch {
      position: relative;
      width: 44px;
      height: 24px;
    }

    .layer-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .layer-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #d1d5db;
      border-radius: 24px;
      transition: all 0.2s ease;
    }

    .layer-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: all 0.2s ease;
    }

    input:checked + .layer-slider {
      background-color: #1e40af;
    }

    input:checked + .layer-slider:before {
      transform: translateX(20px);
    }

    /* ============================================ */
    /* SIMBOLOGIA */
    /* ============================================ */
    .symbology-section {
      margin-top: 0.5rem;
      padding: 0.75rem;
      background-color: white;
      border-radius: 0.5rem;
      border: 1px solid #e5e7eb;
    }

    .symbology-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
      font-size: 0.813rem;
    }

    .symbology-item:last-child {
      margin-bottom: 0;
    }

    .symbology-icon {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid;
    }

    /* ============================================ */
    /* CONTAINER DO MAPA */
    /* ============================================ */
    .map-container {
      position: relative;
      flex: 1;
    }

    #map {
      width: 100%;
      height: 100%;
    }

    /* ============================================ */
    /* CUSTOMIZA√á√ïES DO LEAFLET */
    /* ============================================ */
    .leaflet-popup-content-wrapper {
      border-radius: 0.5rem !important;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1) !important;
    }

    .leaflet-popup-content {
      font-family: var(--font-family) !important;
      line-height: 1.6 !important;
    }

    .popup-content {
      max-width: 300px;
      font-size: 13px;
    }

    .popup-content h3 {
      margin: 0 0 10px 0;
      color: #667eea;
      border-bottom: 2px solid #667eea;
      padding-bottom: 5px;
    }

    .popup-content .info-row {
      margin: 8px 0;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
    }

    .popup-content .info-label {
      font-weight: bold;
      color: #555;
    }

    .popup-content .info-value {
      color: #333;
      text-align: right;
    }

    /* ============================================ */
    /* PAINEL DE STATUS */
    /* ============================================ */
    .status-panel {
      display: none;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      border-radius: 0.5rem;
      font-size: 0.875rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }

    .status-panel.show {
      display: flex !important;
    }

    .status-panel.success {
      background-color: #dcfce7;
      color: #166534;
      border: 1px solid #bbf7d0;
    }

    .status-panel.error {
      background-color: #fef2f2;
      color: #dc2626;
      border: 1px solid #fecaca;
    }

    .status-panel.info {
      background-color: #dbeafe;
      color: #1e40af;
      border: 1px solid #bae6fd;
    }

    /* ============================================ */
    /* APP PRINCIPAL */
    /* ============================================ */
    #mainApp {
      display: none;
      opacity: 0;
      transition: opacity 0.3s;
      min-height: 100vh;
    }

    #mainApp.loaded {
      display: block;
      opacity: 1;
    }

    /* ============================================ */
    /* TABS DO APP */
    /* ============================================ */
    .tabs {
      display: flex;
      background: white;
      border-bottom: 2px solid #e5e7eb;
      overflow-x: auto;
      position: sticky;
      top: 0;
      z-index: 99;
    }
    
    .tab {
      flex: 1;
      padding: 1rem;
      border: none;
      background: white;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      min-width: 100px;
    }
    
    .tab.active {
      border-bottom-color: #10b981;
      color: #10b981;
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
      padding: 1rem;
      animation: fadeIn 0.3s;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* ============================================ */
    /* RESPONSIVIDADE - MOBILE */
    /* ============================================ */
    @media (max-width: 768px) {
      :root {
        --header-height: auto;
      }
      
      .navbar {
        height: auto;
        padding: 0.75rem 1rem;
      }
      
      .main-container {
        flex-direction: column;
        padding-top: 0;
      }
      
      .sidebar {
        width: 100%;
        order: 2;
        max-height: 40vh;
      }
      
      .map-container {
        order: 1;
        height: 60vh;
      }

      .basemap-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- LOADING SCREEN -->
  <div id="appLoader">
    <div class="loader-icon">üåø</div>
    <div class="loader-text">S√≠tio Ipiranga</div>
    <div style="font-size: 0.9rem; opacity: 0.9;">Carregando frut√≠feras...</div>
    <div class="loader-progress">
      <div class="loader-bar"></div>
    </div>
  </div>

  <!-- APP PRINCIPAL -->
  <div id="mainApp">
    <!-- CABE√áALHO -->
    <nav class="navbar navbar-dark fixed-top">
      <div class="container-fluid">
        <span class="navbar-brand mb-0 h1">
          <i class="fas fa-tree"></i> S√≠tio Ipiranga
        </span>
        <span class="text-white">
          <i class="fas fa-map-marked-alt"></i> Gest√£o de Frut√≠feras
        </span>
      </div>
    </nav>

    <!-- CONTAINER PRINCIPAL -->
    <div class="main-container">
      <!-- BARRA LATERAL -->
      <div class="sidebar">
        <!-- Painel de Status -->
        <div id="statusPanel" class="status-panel">
          <i class="fas fa-info-circle"></i>
          <span id="statusMessage">Carregando dados...</span>
        </div>

        <!-- Card de Estat√≠sticas -->
        <div class="card">
          <div class="card-header">
            <i class="fas fa-chart-bar"></i> Estat√≠sticas
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-6">
                <div class="stat-card">
                  <div class="number" id="totalTrees">0</div>
                  <div class="label">√Årvores</div>
                </div>
              </div>
              <div class="col-6">
                <div class="stat-card">
                  <div class="number" id="totalSpecies">0</div>
                  <div class="label">Esp√©cies</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Card de Mapas Base -->
        <div class="card">
          <div class="card-header">
            <i class="fas fa-layer-group"></i> Mapas Base
          </div>
          <div class="card-body">
            <div class="basemap-grid">
              <div class="basemap-btn active" data-basemap="osm">
                <i class="fas fa-map"></i>
                <span>OpenStreetMap</span>
              </div>
              <div class="basemap-btn" data-basemap="satellite">
                <i class="fas fa-satellite"></i>
                <span>Sat√©lite</span>
              </div>
              <div class="basemap-btn" data-basemap="topo">
                <i class="fas fa-mountain"></i>
                <span>Topogr√°fico</span>
              </div>
              <div class="basemap-btn" data-basemap="dark">
                <i class="fas fa-moon"></i>
                <span>Escuro</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Card de Camadas -->
        <div class="card">
          <div class="card-header">
            <i class="fas fa-layer-group"></i> Camadas
          </div>
          <div class="card-body">
            <!-- Camada de Frut√≠feras -->
            <div class="layer-item">
              <div class="layer-left">
                <div class="layer-badge" style="color: #10b981;"></div>
                <span class="layer-label">Frut√≠feras</span>
              </div>
              <label class="layer-switch">
                <input type="checkbox" id="layerFrutiferas" checked>
                <span class="layer-slider"></span>
              </label>
            </div>
            
            <!-- Simbologia de Frut√≠feras -->
            <div class="symbology-section" id="symbologyFrutiferas">
              <div class="text-muted mb-2" style="font-size: 0.75rem; font-weight: 600;">LEGENDA POR ESP√âCIE</div>
              <div class="symbology-item">
                <div class="symbology-icon" style="border-color: #10b981; background-color: #10b981;"></div>
                <span id="species1">Carregando...</span>
              </div>
              <div class="symbology-item">
                <div class="symbology-icon" style="border-color: #f59e0b; background-color: #f59e0b;"></div>
                <span id="species2">Carregando...</span>
              </div>
              <div class="symbology-item">
                <div class="symbology-icon" style="border-color: #ef4444; background-color: #ef4444;"></div>
                <span id="species3">Carregando...</span>
              </div>
              <div class="symbology-item">
                <div class="symbology-icon" style="border-color: #8b5cf6; background-color: #8b5cf6;"></div>
                <span id="species4">Carregando...</span>
              </div>
            </div>

            <!-- Camada de Mosaico -->
            <div class="layer-item">
              <div class="layer-left">
                <div class="layer-badge" style="color: #f59e0b;"></div>
                <span class="layer-label">Mosaico A√©reo</span>
              </div>
              <label class="layer-switch">
                <input type="checkbox" id="layerMosaico">
                <span class="layer-slider"></span>
              </label>
            </div>

            <!-- Simbologia de Mosaico -->
            <div class="symbology-section" id="symbologyMosaico" style="display: none;">
              <div class="text-muted mb-2" style="font-size: 0.75rem; font-weight: 600;">LEGENDA</div>
              <div class="symbology-item">
                <div style="width: 30px; height: 16px; background: linear-gradient(to right, #f59e0b, #ef4444); border: 1px solid #d1d5db; border-radius: 2px;"></div>
                <span>Imagem Ortorretificada</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- MAPA -->
      <div class="map-container">
        <div id="map"></div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <script>
    // ============================================
    // üîß CONFIGURA√á√ÉO SUPABASE
    // ============================================
    const SUPABASE_URL = 'https://erbefbnjxgpetbetlzya.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyYmVmYm5qeGdwZXRiZXRsenlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMzI4ODcsImV4cCI6MjA3NjYwODg4N30.d09pjgddZpNY3Z4cVZ3V4h77aAf_GVGF0sOBTZkZf2A';
    
    const { createClient } = supabase;
    const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Vari√°veis globais
    let frutiferas = [];
    let map;
    let baseLayers = {};
    let overlayLayers = {};
    let markers = {};
    let allTreesData = [];
    let currentBaseLayer = 'osm';
    let speciesColors = {
      color1: '#10b981',
      color2: '#f59e0b', 
      color3: '#ef4444',
      color4: '#8b5cf6'
    };
    let speciesColorMap = {};

    // ============================================
    // üì• FUN√á√ÉO PARA CARREGAR FRUT√çFERAS
    // ============================================
    async function carregarFrutiferas() {
      console.log('üì• Carregando frut√≠feras do Supabase...');
      
      try {
        // Tentar carregar do localStorage primeiro
        const frutiferasLocal = JSON.parse(localStorage.getItem('frutiferas') || '[]');
        
        if (frutiferasLocal.length > 0) {
          frutiferas = frutiferasLocal;
          console.log(`üì¶ ${frutiferas.length} frut√≠feras do cache local`);
          atualizarMapa();
          atualizarEstatisticas();
        }
        
        // Buscar dados atualizados do Supabase
        if (navigator.onLine) {
          const response = await fetch(
            `${SUPABASE_URL}/rest/v1/rpc/get_plantas_para_telegram`,
            {
              method: 'POST',
              headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({})
            }
          );
          
          if (response.ok) {
            const dados = await response.json();
            
            // Converter os dados da fun√ß√£o RPC para o formato do app
            frutiferas = dados.map(item => ({
              id: item.id || 'S/N',
              especie: item.nome || 'Frut√≠fera',
              nome_popular: item.nome || 'Frut√≠fera',
              identificacao: item.id || 'S/N',
              data_plantio: item.dataPlantio || null,
              ultima_rega: item.ultRega || null,
              ultima_poda: item.ultPoda || null,
              ultima_colheita: item.ultColh || null,
              latitude: item.latitude || -7.1195,
              longitude: item.longitude || -34.8450,
              created_at: new Date().toISOString()
            }));
            
            localStorage.setItem('frutiferas', JSON.stringify(frutiferas));
            console.log(`‚úÖ ${frutiferas.length} frut√≠feras carregadas do Supabase`);
            atualizarMapa();
            atualizarEstatisticas();
          } else {
            console.warn('‚ö†Ô∏è Erro ao buscar do Supabase:', response.status);
            await tentarTabelaDireta();
          }
        } else {
          console.log('üì° Offline - usando dados do cache');
          mostrarStatus('Modo offline - usando dados locais', 'info');
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar frut√≠feras:', error);
        mostrarStatus('‚ö†Ô∏è Erro ao carregar. Usando dados locais.', 'error');
      }
    }

    // ============================================
    // üó∫Ô∏è FUN√á√ïES DO MAPA
    // ============================================
    function initMap() {
      map = L.map('map').setView([-7.1195, -34.8450], 13);
      
      // Mapas Base
      baseLayers.osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors',
        maxZoom: 19
      }).addTo(map);

      baseLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Esri, Maxar, Earthstar Geographics',
        maxZoom: 19
      });

      baseLayers.topo = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenTopoMap contributors',
        maxZoom: 17
      });

      baseLayers.dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        attribution: '¬© CARTO',
        maxZoom: 19
      });

      // Layer group para marcadores
      overlayLayers.frutiferas = L.layerGroup().addTo(map);

      // Event listeners para mapas base
      document.querySelectorAll('.basemap-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const basemapType = this.dataset.basemap;
          
          // Remove active de todos
          document.querySelectorAll('.basemap-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');
          
          // Remove camada atual
          if (baseLayers[currentBaseLayer]) {
            map.removeLayer(baseLayers[currentBaseLayer]);
          }
          
          // Adiciona nova camada
          if (baseLayers[basemapType]) {
            baseLayers[basemapType].addTo(map);
            currentBaseLayer = basemapType;
          }
        });
      });

      // Event listener para camada de frut√≠feras
      document.getElementById('layerFrutiferas').addEventListener('change', function() {
        const symbology = document.getElementById('symbologyFrutiferas');
        if (this.checked) {
          overlayLayers.frutiferas.addTo(map);
          symbology.style.display = 'block';
        } else {
          map.removeLayer(overlayLayers.frutiferas);
          symbology.style.display = 'none';
        }
      });

      // Event listener para camada de mosaico
      document.getElementById('layerMosaico').addEventListener('change', function() {
        const symbology = document.getElementById('symbologyMosaico');
        if (this.checked) {
          // Carregar mosaico se dispon√≠vel
          carregarMosaico();
          symbology.style.display = 'block';
        } else {
          if (overlayLayers.mosaico) {
            map.removeLayer(overlayLayers.mosaico);
          }
          symbology.style.display = 'none';
        }
      });
    }

    function atualizarMapa() {
      // Limpar marcadores existentes
      overlayLayers.frutiferas.clearLayers();
      
      if (frutiferas.length === 0) {
        mostrarStatus('Nenhuma frut√≠fera cadastrada', 'info');
        return;
      }

      const bounds = [];
      const species = new Set();
      
      // Identificar as esp√©cies √∫nicas
      frutiferas.forEach(tree => {
        if (tree.especie) {
          species.add(tree.especie);
        }
      });

      // Mapear cores para as esp√©cies
      const speciesArray = Array.from(species).sort();
      const colors = ['#10b981', '#f59e0b', '#ef4444', '#8b5cf6'];
      speciesArray.forEach((sp, idx) => {
        speciesColorMap[sp] = colors[idx % colors.length];
      });

      // Atualizar legenda
      speciesArray.forEach((sp, idx) => {
        const element = document.getElementById(`species${idx + 1}`);
        if (element && idx < 4) {
          element.textContent = sp;
        }
      });

      // Ocultar legendas n√£o utilizadas
      for (let i = speciesArray.length; i < 4; i++) {
        const element = document.getElementById(`species${i + 1}`);
        if (element) {
          element.parentElement.style.display = 'none';
        }
      }

      // Adicionar marcadores ao mapa
      frutiferas.forEach(tree => {
        const lat = tree.latitude || -7.1195;
        const lon = tree.longitude || -34.8450;
        
        const marker = L.marker([lat, lon], {
          icon: getMarkerIcon(tree.especie)
        });

        marker.bindPopup(createPopupContent(tree));
        overlayLayers.frutiferas.addLayer(marker);
        bounds.push([lat, lon]);
      });

      // Ajustar vis√£o do mapa para mostrar todos os marcadores
      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [50, 50] });
      }

      mostrarStatus(`${frutiferas.length} frut√≠feras carregadas no mapa`, 'success');
    }

    function getMarkerIcon(species) {
      const color = speciesColorMap[species] || '#10b981';
      const colorName = {
        '#10b981': 'green',
        '#f59e0b': 'orange',
        '#ef4444': 'red',
        '#8b5cf6': 'violet'
      }[color] || 'green';

      return L.icon({
        iconUrl: `https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-${colorName}.png`,
        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/images/marker-shadow.png',
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41]
      });
    }

    function createPopupContent(tree) {
      let content = `
        <div class="popup-content">
          <h3>${tree.especie || tree.nome_popular || 'Frut√≠fera'}</h3>
          <div class="info-row">
            <span class="info-label">Identifica√ß√£o:</span>
            <span class="info-value">${tree.identificacao || tree.id}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Data Plantio:</span>
            <span class="info-value">${formatarData(tree.data_plantio) || 'N√£o informado'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">√öltima Rega:</span>
            <span class="info-value">${formatarData(tree.ultima_rega) || 'Nunca'}</span>
          </div>
          <div class="info-row">
            <span class="info-label">√öltima Poda:</span>
            <span class="info-value">${formatarData(tree.ultima_poda) || 'Nunca'}</span>
          </div>
      `;

      if (tree.ultima_colheita) {
        content += `
          <div class="info-row">
            <span class="info-label">√öltima Colheita:</span>
            <span class="info-value">${formatarData(tree.ultima_colheita)}</span>
          </div>
        `;
      }

      content += `</div>`;
      return content;
    }

    function carregarMosaico() {
      // Exemplo de carregamento de mosaico a√©reo
      // Nota: Substitua as coordenadas e URL pelo seu mosaico real
      overlayLayers.mosaico = L.imageOverlay(
        'https://erbefbnjxgpetbetlzya.supabase.co/storage/v1/object/public/mosaico_tiles/mosaico_tile.tif',
        [[-7.15, -34.88], [-7.09, -34.81]],
        {
          opacity: 0.7,
          attribution: 'Mosaico A√©reo'
        }
      ).addTo(map);
      
      mostrarStatus('Mosaico a√©reo carregado', 'success');
    }

    // ============================================
    // üìä FUN√á√ïES AUXILIARES
    // ============================================
    function atualizarEstatisticas() {
      const total = frutiferas.length;
      const especies = [...new Set(frutiferas.map(f => f.especie || f.nome_popular))].length;
      
      document.getElementById('totalTrees').textContent = total;
      document.getElementById('totalSpecies').textContent = especies;
    }

    function mostrarStatus(message, type = 'info') {
      const panel = document.getElementById('statusPanel');
      const messageEl = document.getElementById('statusMessage');
      
      panel.className = `status-panel show ${type}`;
      messageEl.textContent = message;

      if (type === 'success' || type === 'info') {
        setTimeout(() => {
          panel.classList.remove('show');
        }, 3000);
      }
    }

    function formatarData(dataString) {
      if (!dataString) return null;
      const data = new Date(dataString);
      return data.toLocaleDateString('pt-BR');
    }

    // ============================================
    // üöÄ INICIALIZA√á√ÉO
    // ============================================
    async function inicializarApp() {
      console.log('üöÄ Inicializando app...');
      
      const loader = document.getElementById('appLoader');
      const mainApp = document.getElementById('mainApp');
      
      try {
        // Inicializar mapa
        initMap();
        
        // Carregar frut√≠feras
        await carregarFrutiferas();
        
        // Aguardar m√≠nimo para UX
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Remover loader
        if (loader) {
          loader.classList.add('hidden');
          setTimeout(() => loader.remove(), 300);
        }
        
        if (mainApp) {
          mainApp.classList.add('loaded');
        }
        
        console.log('‚úÖ App inicializado com sucesso!');
        
      } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
        if (loader) loader.classList.add('hidden');
        if (mainApp) mainApp.classList.add('loaded');
        mostrarStatus('Erro ao inicializar o aplicativo', 'error');
      }
    }

    // Iniciar quando DOM estiver pronto
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializarApp);
    } else {
      inicializarApp();
    }
  </script>
</body>
</html>
