// üîß CORRE√á√ïES APLICADAS:
// 1. Removida fun√ß√£o duplicada atualizarBadgeSincronizacao()
// 2. Adicionado debounce para carregarAcoesHoje()
// 3. Corrigido bug de m√∫ltiplas chamadas
// 4. Otimizado localStorage
// 5. Melhorado feedback visual

<script>
    const SUPABASE_URL = 'https://erbefbnjxgpetbetlzya.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyYmVmYm5qeGdwZXRiZXRsenlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMzI4ODcsImV4cCI6MjA3NjYwODg4N30.d09pjgddZpNY3Z4cVZ3V4h77aAf_GVGF0sOBTZkZf2A';

    let frutiferas = [];
    let historico = [];
    let perfilAtual = localStorage.getItem('perfilAtual') || 'Default';
    let currentFilter = 'todas';
    let pendingSync = [];
    
    // Vari√°veis do mapa
    let map;
    let baseLayers = {};
    let orthomosaicLayer;
    let frutiferasLayer;
    let markers = {};
    let speciesColors = {
      'Mangabeira': '#10b981',
      'Cajueiro': '#f59e0b',
      'Coqueiro': '#ef4444',
      'Cacau': '#8b5cf6'
    };

    // ‚≠ê‚≠ê DEBOUNCE PARA EVITAR CHAMADAS DUPLICADAS ‚≠ê‚≠ê
    let debounceTimer;
    function debounce(func, wait) {
      return function executedFunction(...args) {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => func.apply(this, args), wait);
      };
    }

    async function carregarFrutiferas() {
      console.log('üî• Carregando frut√≠feras do Supabase...');
      
      try {
        if (navigator.onLine) {
          const response = await fetch(
            `${SUPABASE_URL}/rest/v1/frutiferas?select=*&nome_popular=in.(Mangabeira,Cajueiro,Coqueiro,Cacau)`,
            {
              headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
              }
            }
          );
          
          if (response.ok) {
            const dados = await response.json();
            
            frutiferas = dados.map(f => ({
              id: f.id,
              fid: f.fid,
              especie: f.nome_popular,
              nome_popular: f.nome_popular,
              identificacao: f.fid,
              data_plantio: f.data_plantio || null,
              ultima_rega: f.data_irrigacao_ordinaria || null,
              ultima_poda: f.data_poda_formacao_1 || null,
              ultima_colheita: f.inicio_colheita || null,
              latitude: f.latitude || null,
              longitude: f.longitude || null,
              altura_total: f.altura_total || null,
              diametro_copa: f.diametro_copa || null,
              created_at: f.created_at || new Date().toISOString()
            }));
            
            localStorage.setItem('frutiferas', JSON.stringify(frutiferas));
            console.log(`‚úÖ ${frutiferas.length} frut√≠feras carregadas do Supabase`);
            atualizarTodasAbas();
            
            if (document.getElementById('mapa').classList.contains('active')) {
              atualizarMapa();
            }
          } else {
            console.error('Erro na resposta do Supabase:', response.status);
            carregarDoCache();
          }
        } else {
          console.log('üì° Modo offline - carregando do cache');
          carregarDoCache();
        }
        
      } catch (error) {
        console.error('‚ùå Erro ao carregar frut√≠feras:', error);
        mostrarToast('‚ö†Ô∏è Erro ao carregar. Usando dados locais.');
        carregarDoCache();
      }
    }

    function carregarDoCache() {
      const frutiferasLocal = JSON.parse(localStorage.getItem('frutiferas') || '[]');
      if (frutiferasLocal.length > 0) {
        frutiferas = frutiferasLocal;
        console.log(`üì¶ ${frutiferas.length} frut√≠feras do cache local`);
        atualizarTodasAbas();
      }
    }

    function atualizarTodasAbas() {
      console.log('üîÑ Atualizando UI com', frutiferas.length, 'frut√≠feras');
      
      document.getElementById('frutiferaCount').textContent = `üìä ${frutiferas.length} frut√≠feras`;
      
      atualizarListaFrutiferas();
      carregarAcoesHojeDebounced(); // Usa debounce
      atualizarStats();
    }

    function atualizarListaFrutiferas() {
      const lista = document.getElementById('frutiferasList');
      if (!lista) return;
      
      if (frutiferas.length === 0) {
        lista.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üå±</div>
            <p>Nenhuma frut√≠fera cadastrada ainda.</p>
            <p><small>V√° para a aba "Mapa" para adicionar sua primeira frut√≠fera!</small></p>
          </div>
        `;
        return;
      }
      
      lista.innerHTML = frutiferas.map(f => `
        <div class="frutifera-card">
          <div class="frutifera-header">
            <div class="frutifera-name">${f.nome_popular || f.especie}</div>
            <span class="badge">${f.identificacao || f.id}</span>
          </div>
          <div class="frutifera-info">
            <div>üìÖ Plantio: ${formatarData(f.data_plantio) || 'Sem data'}</div>
            <div>üíß √öltima rega: ${formatarData(f.ultima_rega) || 'Nunca'}</div>
            <div>‚úÇÔ∏è √öltima poda: ${formatarData(f.ultima_poda) || 'Nunca'}</div>
            ${f.latitude && f.longitude ? `<div>üìç GPS: ${f.latitude.toFixed(6)}, ${f.longitude.toFixed(6)}</div>` : ''}
          </div>
        </div>
      `).join('');
    }

    // ‚≠ê‚≠ê VERS√ÉO COM DEBOUNCE PARA EVITAR CHAMADAS DUPLICADAS ‚≠ê‚≠ê
    function carregarAcoesHojeDebounced() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => {
        console.log('‚úÖ [√öNICA] Chamando carregarAcoesHoje()');
        carregarAcoesHoje();
      }, 300);
    }

    function carregarAcoesHoje() {
      console.log('üìã carregarAcoesHoje() executando...');
      const container = document.getElementById('acoesHoje');
      if (!container) return;
      
      if (frutiferas.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <p>Nenhuma frut√≠fera cadastrada.</p>
            <p><small>Cadastre frut√≠feras para ver as a√ß√µes pendentes</small></p>
          </div>
        `;
        return;
      }
      
      const acoes = [];
      
      frutiferas.forEach(f => {
        const diasRega = f.ultima_rega ? calcularDias(f.ultima_rega) : 999;
        const intervaloRega = obterIntervaloRega(f);
        
        if (diasRega >= intervaloRega) {
          acoes.push({
            tipo: 'rega',
            urgencia: diasRega >= (intervaloRega + 2) ? 'urgent' : 'warning',
            frutifera: f,
            dias: diasRega,
            titulo: `Regar ${f.nome_popular || f.especie}`,
            descricao: `√öltima rega: ${diasRega === 999 ? 'Nunca' : diasRega + ' dias atr√°s'}`
          });
        }
        
        const diasPoda = f.ultima_poda ? calcularDias(f.ultima_poda) : 999;
        const intervaloPoda = obterIntervaloPoda(f);
        
        if (diasPoda >= intervaloPoda) {
          acoes.push({
            tipo: 'poda',
            urgencia: 'warning',
            frutifera: f,
            dias: diasPoda,
            titulo: `Podar ${f.nome_popular || f.especie}`,
            descricao: `√öltima poda: ${diasPoda === 999 ? 'Nunca' : diasPoda + ' dias atr√°s'}`
          });
        }
        
        const diasColheita = f.ultima_colheita ? calcularDias(f.ultima_colheita) : 999;
        const intervaloColheita = obterIntervaloColheita(f);
        
        if (diasColheita >= intervaloColheita) {
          acoes.push({
            tipo: 'colheita',
            urgencia: 'normal',
            frutifera: f,
            dias: diasColheita,
            titulo: `Colher ${f.nome_popular || f.especie}`,
            descricao: `√öltima colheita: ${diasColheita === 999 ? 'Nunca' : diasColheita + ' dias atr√°s'}`
          });
        }
      });
      
      if (acoes.length === 0) {
        container.innerHTML = `
          <div class="info-box success-box">
            ‚úÖ <strong>Tudo em dia!</strong><br>
            Nenhuma a√ß√£o pendente no momento.
          </div>
        `;
        document.getElementById('actionCount').textContent = 'üìã 0 a√ß√µes';
        return;
      }
      
      document.getElementById('actionCount').textContent = `üìã ${acoes.length} a√ß√µes`;
      
      let acoesFiltradas = acoes;
      if (currentFilter !== 'todas') {
        if (currentFilter === 'urgente') {
          acoesFiltradas = acoes.filter(a => a.urgencia === 'urgent');
        } else {
          acoesFiltradas = acoes.filter(a => a.tipo === currentFilter);
        }
      }
      
      container.innerHTML = acoesFiltradas.map(acao => {
        const frutiferaId = acao.frutifera.id || acao.frutifera.fid || acao.frutifera.identificacao;
        
        return `
        <div class="action-item ${acao.urgencia}">
          <div class="action-title">
            ${acao.urgencia === 'urgent' ? 'üö®' : acao.tipo === 'rega' ? 'üíß' : acao.tipo === 'poda' ? '‚úÇÔ∏è' : 'üçä'}
            ${acao.titulo}
          </div>
          <div class="action-desc">${acao.descricao}</div>
          <div class="action-meta">
            Frut√≠fera: ${acao.frutifera.identificacao || acao.frutifera.id}
          </div>
          <button class="btn btn-primary" onclick="registrarAcao('${acao.tipo}', '${frutiferaId}')">
            ‚úÖ Marcar como feito
          </button>
        </div>
      `;
      }).join('');
    }

    function atualizarStats() {
      const total = frutiferas.length;
      const especies = [...new Set(frutiferas.map(f => f.especie || f.nome_popular))].length;
      
      let pendentes = 0;
      let urgentes = 0;
      
      frutiferas.forEach(f => {
        const diasRega = f.ultima_rega ? calcularDias(f.ultima_rega) : 999;
        const intervaloRega = obterIntervaloRega(f);
        
        if (diasRega >= intervaloRega) {
          pendentes++;
          if (diasRega >= (intervaloRega + 2)) urgentes++;
        }
      });
      
      if (document.getElementById('statTotal')) {
        document.getElementById('statTotal').textContent = total;
        document.getElementById('statPend').textContent = pendentes;
        document.getElementById('statUrg').textContent = urgentes;
        document.getElementById('statEsp').textContent = especies;
      }

      const especiesCount = {};
      frutiferas.forEach(f => {
        const esp = f.especie || f.nome_popular || 'Desconhecida';
        especiesCount[esp] = (especiesCount[esp] || 0) + 1;
      });

      const summaryEl = document.getElementById('speciesSummary');
      if (summaryEl) {
        summaryEl.innerHTML = Object.entries(especiesCount)
          .map(([esp, count]) => `
            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: #f9fafb; border-radius: 6px; margin-bottom: 0.5rem;">
              <span>${esp}</span>
              <strong>${count}</strong>
            </div>
          `).join('') || '<div class="empty-state"><p>Nenhuma frut√≠fera cadastrada</p></div>';
      }
    }

    async function registrarAcao(tipo, frutiferaId) {
      console.log(`üìù [REGISTRAR A√á√ÉO] ${tipo} para ${frutiferaId}`);
      
      try {
        const dataHoje = new Date().toISOString().split('T')[0];
        
        // ========== 1. SALVAR NO localStorage ==========
        let acoesArray = JSON.parse(localStorage.getItem('acoesPendentes') || '[]');
        
        const novaAcao = {
          tipo: tipo,
          frutiferaId: String(frutiferaId),
          data: dataHoje,
          timestamp: new Date().toISOString(),
          sincronizado: false
        };
        
        acoesArray.push(novaAcao);
        localStorage.setItem('acoesPendentes', JSON.stringify(acoesArray));
        
        console.log('‚úÖ A√ß√£o salva. Total:', acoesArray.length);
        
        // ========== 2. ATUALIZAR UI LOCAL ==========
        const campo = tipo === 'rega' ? 'ultima_rega' : 
                      tipo === 'poda' ? 'ultima_poda' : 'ultima_colheita';
        
        const index = frutiferas.findIndex(f => f.id == frutiferaId);
        if (index >= 0) {
          frutiferas[index][campo] = dataHoje;
          localStorage.setItem('frutiferas', JSON.stringify(frutiferas));
        }
        
        atualizarTodasAbas();
        mostrarToast(`‚úÖ ${tipo} registrada!`);
        atualizarContadorSync();
        
        // ========== 3. SINCRONIZAR ==========
        if (navigator.onLine) {
          console.log('üåê Online - sincronizando...');
          setTimeout(() => {
            sincronizarFilaAcoes();
          }, 800);
        }
        
      } catch (error) {
        console.error('üí• ERRO em registrarAcao:', error);
        mostrarToast('‚ùå Erro ao registrar a√ß√£o');
      }
    }

    async function cadastrarFrutifera(event) {
      event.preventDefault();
      
      const especie = document.getElementById('novaEspecie').value;
      const dataPlantio = document.getElementById('dataPlantio').value;
      const coordenadas = document.getElementById('coordenadas').value;
      const responsavel = document.getElementById('responsavel').value;
      
      if (!especie) {
        mostrarToast('‚ùå Selecione uma esp√©cie');
        return;
      }
      
      let lat = null, lon = null;
      if (coordenadas) {
        const coords = coordenadas.split(',').map(c => parseFloat(c.trim()));
        lat = coords[0];
        lon = coords[1];
      }
      
      const fidTemp = `${especie.substring(0, 3).toUpperCase()}-${Date.now()}`;
      
      const novaFrutifera = {
        id: null,
        fid: fidTemp,
        especie: especie,
        nome_popular: especie,
        identificacao: fidTemp,
        data_plantio: dataPlantio,
        latitude: lat,
        longitude: lon,
        responsavel: responsavel,
        ultima_rega: null,
        ultima_poda: null,
        ultima_colheita: null,
        created_at: new Date().toISOString(),
        pendingSync: true
      };
      
      try {
        pendingSync.push(novaFrutifera);
        localStorage.setItem('pendingSync', JSON.stringify(pendingSync));
        
        frutiferas.push(novaFrutifera);
        localStorage.setItem('frutiferas', JSON.stringify(frutiferas));
        
        atualizarTodasAbas();
        mostrarToast('‚úÖ Frut√≠fera cadastrada! Clique em "Sincronizar" para enviar ao banco.');
        
        event.target.reset();
        document.getElementById('coordDisplay').style.display = 'none';
        
        if (document.getElementById('mapa').classList.contains('active') && map) {
          atualizarMapa();
          const container = document.getElementById('cadastroFormContainer');
          const icon = document.getElementById('cadastroToggleIcon');
          container.classList.add('collapsed');
          icon.textContent = '‚ñ∂';
        }
        
        atualizarContadorSync();
        
      } catch (error) {
        console.error('‚ùå Erro ao cadastrar frut√≠fera:', error);
        mostrarToast('‚ùå Erro ao cadastrar frut√≠fera');
      }
    }

    async function sincronizarComSupabase() {
      if (!navigator.onLine) {
        mostrarToast('üì° Voc√™ est√° offline. Conecte-se √† internet para sincronizar.');
        return;
      }
      
      const syncMsg = document.getElementById('syncMessage');
      const syncButton = document.querySelector('[onclick="sincronizarComSupabase()"]');
      
      if (syncButton) {
        syncButton.disabled = true;
        syncButton.innerHTML = '<span>‚è≥</span> Sincronizando...';
      }
      
      pendingSync = JSON.parse(localStorage.getItem('pendingSync') || '[]');
      
      if (pendingSync.length === 0) {
        mostrarToast('‚úÖ Nenhuma altera√ß√£o pendente');
        if (syncButton) {
          syncButton.disabled = false;
          syncButton.innerHTML = '<span>üîÑ</span> Sincronizar com Banco de Dados';
        }
        return;
      }
      
      syncMsg.textContent = `üîÑ Sincronizando ${pendingSync.length} item(ns)...`;
      mostrarToast(`üîÑ Sincronizando ${pendingSync.length} frut√≠fera(s)...`);
      
      let sucessos = 0;
      let erros = 0;
      
      for (const frutifera of pendingSync) {
        try {
          const response = await fetch(
            `${SUPABASE_URL}/rest/v1/frutiferas`,
            {
              method: 'POST',
              headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({
                nome_popular: frutifera.especie,
                data_plantio: frutifera.data_plantio,
                latitude: frutifera.latitude,
                longitude: frutifera.longitude,
                data_irrigacao_ordinaria: frutifera.ultima_rega,
                data_poda_formacao_1: frutifera.ultima_poda,
                inicio_colheita: frutifera.ultima_colheita
              })
            }
          );
          
          if (response.ok) {
            const [resultado] = await response.json();
            
            const index = frutiferas.findIndex(f => f.fid === frutifera.fid);
            if (index >= 0) {
              frutiferas[index].id = resultado.id;
              frutiferas[index].fid = resultado.fid;
              frutiferas[index].identificacao = resultado.fid;
              frutiferas[index].pendingSync = false;
            }
            
            sucessos++;
          } else {
            erros++;
          }
          
        } catch (error) {
          erros++;
        }
      }
      
      pendingSync = [];
      localStorage.setItem('pendingSync', '[]');
      localStorage.setItem('frutiferas', JSON.stringify(frutiferas));
      
      await carregarFrutiferas();
      
      if (syncButton) {
        syncButton.disabled = false;
        syncButton.innerHTML = '<span>üîÑ</span> Sincronizar com Banco de Dados';
      }
      
      if (erros === 0) {
        syncMsg.textContent = `‚úÖ ${sucessos} item(ns) sincronizado(s) com sucesso!`;
        syncMsg.style.color = '#059669';
        mostrarToast(`‚úÖ ${sucessos} frut√≠fera(s) sincronizada(s) com sucesso!`);
      } else {
        syncMsg.textContent = `‚ö†Ô∏è ${sucessos} sucesso(s), ${erros} erro(s)`;
        syncMsg.style.color = '#dc2626';
        mostrarToast(`‚ö†Ô∏è ${sucessos} sucesso(s), ${erros} erro(s)`);
      }
      
      setTimeout(() => {
        syncMsg.textContent = '';
        syncMsg.style.color = '';
      }, 5000);
      
      atualizarContadorSync();
    }

    async function sincronizarFilaAcoes() {
      if (!navigator.onLine) {
        console.log('Offline - aguardando conex√£o');
        return;
      }
      
      let acoesPendentes = JSON.parse(localStorage.getItem('acoesPendentes') || '[]');
      
      if (acoesPendentes.length === 0) {
        console.log('Nenhuma a√ß√£o pendente para sincronizar');
        return;
      }
      
      console.log(`üîÑ Sincronizando ${acoesPendentes.length} a√ß√£o(√µes)...`);
      mostrarToast(`üîÑ Sincronizando ${acoesPendentes.length} a√ß√£o(√µes)...`);
      
      const sucessos = [];
      const falhas = [];
      
      for (const acao of acoesPendentes) {
        try {
          const campoSupabase = acao.tipo === 'rega' ? 'data_irrigacao_ordinaria' : 
                                acao.tipo === 'poda' ? 'data_poda_formacao_1' : 
                                'inicio_colheita';
          
          const response = await fetch(
            `${SUPABASE_URL}/rest/v1/frutiferas?id=eq.${acao.frutiferaId}`,
            {
              method: 'PATCH',
              headers: {
                'apikey': SUPABASE_ANON_KEY,
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                'Content-Type': 'application/json'
              },
              body: JSON.stringify({ [campoSupabase]: acao.data })
            }
          );
          
          if (response.ok) {
            sucessos.push(acao);
            console.log(`‚úÖ ${acao.tipo} sincronizada para ID ${acao.frutiferaId}`);
          } else {
            falhas.push(acao);
          }
        } catch (error) {
          falhas.push(acao);
        }
      }
      
      localStorage.setItem('acoesPendentes', JSON.stringify(falhas));
      
      if (sucessos.length > 0) {
        mostrarToast(`‚úÖ ${sucessos.length} a√ß√£o(√µes) sincronizada(s)`);
        
        try {
          const edgeResponse = await fetch('https://erbefbnjxgpetbetlzya.supabase.co/functions/v1/update-geojson', {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json'
            }
          });
          
          if (edgeResponse.ok) {
            const result = await edgeResponse.json();
            console.log('‚úÖ GitHub atualizado via Edge Function:', result);
            
            const syncMsg = document.getElementById('syncMessage');
            if (syncMsg) {
              syncMsg.innerHTML = `‚úÖ GitHub atualizado! <small>Commit: ${result.commit?.substring(0, 8)}</small>`;
              syncMsg.style.color = '#059669';
              
              setTimeout(() => {
                syncMsg.innerHTML = '';
              }, 5000);
            }
            
            mostrarToast('üì± Notifica√ß√£o enviada para Telegram');
          }
        } catch (e) {
          console.log('‚ö†Ô∏è Edge Function:', e.message);
        }
      }
      
      atualizarContadorSync();
      await carregarFrutiferas();
    }

    async function sincronizarTudo() {
      if (!navigator.onLine) {
        mostrarToast('üì° Voc√™ est√° offline');
        return;
      }
      
      mostrarToast('üîÑ Sincronizando tudo...');
      
      await sincronizarComSupabase();
      await sincronizarFilaAcoes();
      
      mostrarToast('‚úÖ Sincroniza√ß√£o completa!');
    }

    function atualizarContadorSync() {
      const acoesPendentes = JSON.parse(localStorage.getItem('acoesPendentes') || '[]');
      const pendingSync = JSON.parse(localStorage.getItem('pendingSync') || '[]');
      const total = acoesPendentes.length + pendingSync.length;
      
      const statusEl = document.getElementById('syncStatus');
      if (statusEl) {
        if (total > 0) {
          statusEl.innerHTML = `
            <span style="display: flex; align-items: center; gap: 5px;">
              <span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold;">
                ${total}
              </span>
              <span>pendente(s)</span>
            </span>
          `;
          statusEl.style.color = '#f59e0b';
        } else {
          statusEl.innerHTML = '‚úÖ Sincronizado';
          statusEl.style.color = '#10b981';
        }
      }
    }

    // ‚≠ê‚≠ê FUN√á√ïES DE CONFIGURA√á√ÉO CORRIGIDAS ‚≠ê‚≠ê
    function loadConfig() {
      const defaults = {
        mang_rega: 7, mang_poda: 180, mang_colh: 90,
        caju_rega: 10, caju_poda: 365, caju_colh: 60,
        coq_rega: 5, coq_poda: 730, coq_colh: 30,
        cac_rega: 3, cac_poda: 180, cac_colh: 120
      };
      
      Object.keys(defaults).forEach(key => {
        const input = document.getElementById(key);
        if (input) {
          const valor = localStorage.getItem(key) || defaults[key];
          input.value = valor;
        }
      });
    }

    function saveConfig() {
      const config = {};
      
      ['mang', 'caju', 'coq', 'cac'].forEach(prefixo => {
        ['rega', 'poda', 'colh'].forEach(tipo => {
          const key = `${prefixo}_${tipo}`;
          const input = document.getElementById(key);
          if (input) {
            const valor = input.value;
            localStorage.setItem(key, valor);
            config[key] = valor;
          }
        });
      });
      
      localStorage.setItem('configIntervalos', JSON.stringify({
        ...config,
        timestamp: new Date().toISOString()
      }));
      
      console.log('‚úÖ Configura√ß√µes salvas:', config);
      mostrarToast('‚úÖ Configura√ß√µes salvas!');
      
      carregarAcoesHojeDebounced();
    }

    // ‚≠ê‚≠ê FUN√á√ïES DE INTERVALO OTIMIZADAS ‚≠ê‚≠ê
    function obterIntervaloRega(frutifera) {
      const especie = (frutifera.especie || frutifera.nome_popular || '').toLowerCase();
      const config = JSON.parse(localStorage.getItem('configIntervalos') || '{}');
      
      if (especie.includes('coqueiro')) return parseInt(config.coq_rega || localStorage.getItem('coq_rega') || '5');
      if (especie.includes('cacau')) return parseInt(config.cac_rega || localStorage.getItem('cac_rega') || '3');
      if (especie.includes('mangabeira')) return parseInt(config.mang_rega || localStorage.getItem('mang_rega') || '7');
      if (especie.includes('caju')) return parseInt(config.caju_rega || localStorage.getItem('caju_rega') || '10');
      return 7;
    }

    function obterIntervaloPoda(frutifera) {
      const especie = (frutifera.especie || frutifera.nome_popular || '').toLowerCase();
      const config = JSON.parse(localStorage.getItem('configIntervalos') || '{}');
      
      if (especie.includes('coqueiro')) return parseInt(config.coq_poda || localStorage.getItem('coq_poda') || '730');
      if (especie.includes('cacau')) return parseInt(config.cac_poda || localStorage.getItem('cac_poda') || '180');
      if (especie.includes('mangabeira')) return parseInt(config.mang_poda || localStorage.getItem('mang_poda') || '180');
      if (especie.includes('caju')) return parseInt(config.caju_poda || localStorage.getItem('caju_poda') || '365');
      return 180;
    }

    function obterIntervaloColheita(frutifera) {
      const especie = (frutifera.especie || frutifera.nome_popular || '').toLowerCase();
      const config = JSON.parse(localStorage.getItem('configIntervalos') || '{}');
      
      if (especie.includes('coqueiro')) return parseInt(config.coq_colh || localStorage.getItem('coq_colh') || '30');
      if (especie.includes('cacau')) return parseInt(config.cac_colh || localStorage.getItem('cac_colh') || '120');
      if (especie.includes('mangabeira')) return parseInt(config.mang_colh || localStorage.getItem('mang_colh') || '90');
      if (especie.includes('caju')) return parseInt(config.caju_colh || localStorage.getItem('caju_colh') || '60');
      return 90;
    }

    // ‚≠ê‚≠ê INICIALIZA√á√ÉO ATUALIZADA ‚≠ê‚≠ê
    async function inicializarApp() {
      console.log('üöÄ Inicializando app...');
      
      try {
        loadConfig(); // Carrega configura√ß√µes primeiro
        atualizarContadorSync();
        await carregarFrutiferas();
        
        document.getElementById('appLoader').classList.add('hidden');
        document.getElementById('mainApp').classList.add('loaded');
        
        // Status online/offline
        const statusDot = document.getElementById('statusDot');
        const statusText = document.getElementById('statusText');
        
        if (navigator.onLine) {
          if (statusDot) statusDot.className = 'status-dot';
          if (statusText) statusText.textContent = 'Online';
          
          // Sincronizar automaticamente quando online
          setTimeout(() => {
            sincronizarTudo();
          }, 3000);
        } else {
          if (statusDot) statusDot.className = 'status-dot offline';
          if (statusText) statusText.textContent = 'Offline';
        }
        
        console.log('‚úÖ App inicializado com sucesso!');
        
      } catch (error) {
        console.error('‚ùå Erro na inicializa√ß√£o:', error);
        document.getElementById('appLoader').classList.add('hidden');
        document.getElementById('mainApp').classList.add('loaded');
      }
    }

    // Event listeners otimizados
    window.addEventListener('online', () => {
      document.getElementById('statusDot').className = 'status-dot';
      document.getElementById('statusText').textContent = 'Online';
      mostrarToast('üåê Conectado! Sincronizando...');
      
      setTimeout(() => {
        sincronizarTudo();
      }, 2000);
    });

    window.addEventListener('offline', () => {
      document.getElementById('statusDot').className = 'status-dot offline';
      document.getElementById('statusText').textContent = 'Offline';
      mostrarToast('üì° Voc√™ est√° offline');
    });

    // Fun√ß√µes do mapa e auxiliares (mantidas iguais)
    function inicializarMapa() {
      if (map) return;
      
      map = L.map('mapContainer').setView([-7.1195, -34.8450], 13);
      
      baseLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
        attribution: 'Esri, Maxar',
        maxZoom: 19
      });
      
      const orthoBounds = [
        [-7.2567123407225420, -34.8508400655581880],
        [-7.2534701604245848, -34.8470106189991711]
      ];

      orthomosaicLayer = L.imageOverlay('orthomosaic.jpeg', orthoBounds, {
        opacity: 1,
        attribution: 'Ortomosaico S√≠tio Ipiranga'
      }).addTo(map);

      frutiferasLayer = L.layerGroup().addTo(map);
      map.fitBounds(orthoBounds);
      atualizarMapa();
    }

    function atualizarMapa() {
      if (!map || !frutiferasLayer) return;
      
      frutiferasLayer.clearLayers();
      markers = {};
      
      const bounds = [];
      
      frutiferas.forEach(f => {
        if (f.latitude && f.longitude) {
          const color = speciesColors[f.especie] || '#10b981';
          
          const marker = L.circleMarker([f.latitude, f.longitude], {
            radius: 8,
            fillColor: color,
            color: '#fff',
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8
          });

          const popupContent = `
            <div class="popup-content">
              <h3>${f.nome_popular || f.especie}</h3>
              <div class="info-row">
                <span class="info-label">C√≥digo:</span>
                <span class="info-value">${f.identificacao || f.id}</span>
              </div>
              <div class="info-row">
                <span class="info-label">Data Plantio:</span>
                <span class="info-value">${formatarData(f.data_plantio) || 'N√£o informado'}</span>
              </div>
              <div class="info-row">
                <span class="info-label">√öltima Rega:</span>
                <span class="info-value">${formatarData(f.ultima_rega) || 'Nunca'}</span>
              </div>
              ${f.altura_total ? `
              <div class="info-row">
                <span class="info-label">Altura:</span>
                <span class="info-value">${f.altura_total} m</span>
              </div>` : ''}
            </div>
          `;

          marker.bindPopup(popupContent);
          frutiferasLayer.addLayer(marker);
          markers[f.id] = marker;
          bounds.push([f.latitude, f.longitude]);
        }
      });

      if (bounds.length > 0) {
        map.fitBounds(bounds, { padding: [50, 50] });
      }
    }

    function changeBasemap(basemapType, event) {
      document.querySelectorAll('.map-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      
      Object.values(baseLayers).forEach(layer => {
        if (map.hasLayer(layer)) map.removeLayer(layer);
      });
      
      if (orthomosaicLayer && map.hasLayer(orthomosaicLayer)) {
        map.removeLayer(orthomosaicLayer);
      }
      
      if (basemapType === 'orthomosaic') {
        orthomosaicLayer.addTo(map);
        const orthoBounds = [
          [-7.2567123407225420, -34.8508400655581880],
          [-7.2534701604245848, -34.8470106189991711]
        ];
        map.fitBounds(orthoBounds);
      } else if (basemapType === 'satellite') {
        baseLayers.satellite.addTo(map);
        const markerBounds = Object.values(markers).map(m => m.getLatLng());
        if (markerBounds.length > 0) {
          map.fitBounds(markerBounds, { padding: [50, 50] });
        }
      }
    }

    function toggleFrutiferasLayer() {
      const isChecked = document.getElementById('toggleFrutiferas').checked;
      if (isChecked) {
        frutiferasLayer.addTo(map);
      } else {
        map.removeLayer(frutiferasLayer);
      }
    }

    function toggleCadastroForm() {
      const container = document.getElementById('cadastroFormContainer');
      const icon = document.getElementById('cadastroToggleIcon');
      
      if (container.classList.contains('collapsed')) {
        container.classList.remove('collapsed');
        icon.textContent = '‚ñº';
      } else {
        container.classList.add('collapsed');
        icon.textContent = '‚ñ∂';
      }
    }

    function calcularDias(dataString) {
      if (!dataString) return 999;
      const data = new Date(dataString);
      const hoje = new Date();
      const diff = hoje - data;
      return Math.floor(diff / (1000 * 60 * 60 * 24));
    }

    function formatarData(dataString) {
      if (!dataString) return null;
      const data = new Date(dataString);
      return data.toLocaleDateString('pt-BR');
    }

    function mostrarToast(mensagem) {
      const toast = document.getElementById('toast');
      toast.textContent = mensagem;
      toast.className = 'toast show';
      
      setTimeout(() => {
        toast.className = 'toast';
      }, 3000);
    }

    function switchTab(event, tabName) {
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      
      event.target.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      if (tabName === 'mapa') {
        setTimeout(() => {
          if (!map) {
            inicializarMapa();
          } else {
            map.invalidateSize();
            atualizarMapa();
          }
        }, 100);
      }
    }

    function filterAcoes(event, filtro) {
      document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
      currentFilter = filtro;
      carregarAcoesHojeDebounced(); // Usa debounce
    }

    function filtrarFrutiferas() {
      const query = document.getElementById('searchFrutifera').value.toLowerCase();
      const cards = document.querySelectorAll('.frutifera-card');
      
      cards.forEach(card => {
        const text = card.textContent.toLowerCase();
        card.style.display = text.includes(query) ? 'block' : 'none';
      });
    }

    function filterHistorico(event, periodo) {
      document.querySelectorAll('#historico .filter-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');
    }

    function obterLocalizacao() {
      if (!navigator.geolocation) {
        mostrarToast('‚ùå Geolocaliza√ß√£o n√£o suportada');
        return;
      }
      
      mostrarToast('üìç Obtendo localiza√ß√£o...');
      
      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude.toFixed(6);
          const lon = position.coords.longitude.toFixed(6);
          document.getElementById('coordenadas').value = `${lat}, ${lon}`;
          document.getElementById('coordDisplay').style.display = 'block';
          document.getElementById('coordDisplay').textContent = `‚úÖ Localiza√ß√£o obtida: ${lat}, ${lon}`;
          mostrarToast('‚úÖ Localiza√ß√£o obtida!');
        },
        (error) => {
          console.error('Erro ao obter localiza√ß√£o:', error);
          mostrarToast('‚ùå Erro ao obter localiza√ß√£o');
        }
      );
    }

    // Inicializa√ß√£o
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializarApp);
    } else {
      inicializarApp();
    }
  </script>
</body>
</html>
