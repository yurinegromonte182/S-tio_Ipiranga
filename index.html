<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="App para gestÃ£o e monitoramento das frutÃ­feras do SÃ­tio Ipiranga">
  <meta name="theme-color" content="#10b981">
  <title>SÃ­tio Ipiranga - GestÃ£o de FrutÃ­feras</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SÃ­tio Ipiranga">
  
  <!-- ğŸš€ CRITICAL CSS APENAS -->
  <style>
    /* Reset mÃ­nimo */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f3f4f6;
      overflow-x: hidden;
      min-height: 100vh;
    }

    /* ğŸ¯ LOADING SCREEN ULTRA RÃPIDO */
    #appLoader {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
    }

    .loader-icon {
      font-size: 4rem;
      animation: bounce 1s infinite;
      margin-bottom: 1rem;
    }

    .loader-text {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    #mainApp {
      opacity: 0;
      transition: opacity 0.2s;
    }

    #mainApp.visible {
      opacity: 1;
    }
  </style>
  
  <!-- ğŸ¨ CSS COMPLETO CARREGA APÃ“S -->
  <link rel="stylesheet" href="app.css" media="print" onload="this.media='all'">
  <noscript><link rel="stylesheet" href="app.css"></noscript>
</head>
<body>
  <!-- ğŸ¯ LOADING SCREEN -->
  <div id="appLoader">
    <div class="loader-icon">ğŸŒ¿</div>
    <div class="loader-text">SÃ­tio Ipiranga</div>
    <div style="font-size: 0.85rem; opacity: 0.8;">Inicializando...</div>
  </div>

  <!-- ğŸ“± APP PRINCIPAL -->
  <div id="mainApp">
    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-indicator">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Online</span>
      </div>
      <div id="syncStatus">SÃ­tio Ipiranga</div>
    </div>

    <!-- Header -->
    <header class="header">
      <h1>ğŸŒ¿ SÃ­tio Ipiranga</h1>
      <div class="header-stats">
        <span id="plantCount">ğŸ“Š 0 plantas</span>
        <span id="actionCount">ğŸ“‹ 0 aÃ§Ãµes</span>
        <span class="badge-supabase">âœ… Supabase</span>
      </div>
    </header>
    
    <!-- Tabs Navigation -->
    <nav class="tabs">
      <button class="tab active" data-tab="acoes">ğŸ“‹ AÃ§Ãµes</button>
      <button class="tab" data-tab="cadastro">â• Cadastro</button>
      <button class="tab" data-tab="plantas">ğŸŒ± Plantas</button>
      <button class="tab" data-tab="historico">ğŸ“œ HistÃ³rico</button>
      <button class="tab" data-tab="stats">ğŸ“Š Stats</button>
      <button class="tab" data-tab="config">âš™ï¸ Config</button>
    </nav>
    
    <!-- Tab Content: AÃ§Ãµes -->
    <section id="acoes" class="tab-content active">
      <div class="section">
        <h2 class="section-title">ğŸ“‹ AÃ§Ãµes NecessÃ¡rias Hoje</h2>
        
        <div class="info-box">
          <span>ğŸ“¡ Enviando aÃ§Ãµes para Supabase</span><br>
          <small>Funciona offline e sincroniza quando possÃ­vel</small>
        </div>
        
        <div class="filter-group">
          <button class="filter-btn active" data-filter="todas">Todas</button>
          <button class="filter-btn" data-filter="urgente">ğŸš¨ Urgentes</button>
          <button class="filter-btn" data-filter="rega">ğŸ’§ Rega</button>
          <button class="filter-btn" data-filter="poda">âœ‚ï¸ Poda</button>
          <button class="filter-btn" data-filter="colheita">ğŸŠ Colheita</button>
        </div>
        
        <div id="acoesHoje">
          <div class="loading">Carregando aÃ§Ãµes...</div>
        </div>
      </div>
    </section>

    <!-- Tab Content: Cadastro -->
    <section id="cadastro" class="tab-content">
      <div class="section">
        <h2 class="section-title">â• Cadastrar Nova Planta</h2>
        
        <div class="info-box">
          ğŸŒ± Plantas sÃ£o salvas localmente e enviadas ao Supabase
        </div>

        <form id="formCadastro">
          <div class="form-group">
            <label>ğŸŒ¿ EspÃ©cie *</label>
            <select id="novaEspecie" required>
              <option value="">Selecione...</option>
              <option value="Mangabeira">ğŸ¥­ Mangabeira</option>
              <option value="Cajueiro">ğŸŒ° Cajueiro</option>
              <option value="Coqueiro">ğŸ¥¥ Coqueiro</option>
              <option value="Cacau">ğŸ« Cacau</option>
              <option value="Outra">ğŸŒ³ Outra espÃ©cie</option>
            </select>
          </div>

          <div class="form-group" id="outraEspecieGroup" style="display:none;">
            <label>Nome da espÃ©cie</label>
            <input type="text" id="outraEspecieNome" placeholder="Ex: Goiabeira, Mangueira...">
          </div>

          <div class="form-group">
            <label>ğŸ·ï¸ IdentificaÃ§Ã£o/CÃ³digo *</label>
            <input type="text" id="novoId" placeholder="Ex: MG-001, COQ-15..." required>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>ğŸ“… Data do Plantio *</label>
              <input type="date" id="dataPlantio" required>
            </div>
            <div class="form-group">
              <label>ğŸŒ± Idade (meses)</label>
              <input type="number" id="idadePlanta" min="0" placeholder="0">
            </div>
          </div>

          <div class="form-group">
            <label>ğŸ“ LocalizaÃ§Ã£o GPS</label>
            <div class="gps-container">
              <input type="text" id="coordenadas" placeholder="Latitude, Longitude" readonly>
              <button type="button" id="btnGPS">ğŸ“ Obter GPS</button>
            </div>
            <div id="coordDisplay"></div>
          </div>

          <div class="form-group">
            <label>ğŸ‘¤ ResponsÃ¡vel pelo plantio</label>
            <input type="text" id="responsavel" placeholder="Nome" value="">
          </div>

          <button type="submit" class="btn btn-primary">
            âœ… Cadastrar Planta
          </button>
        </form>
      </div>
    </section>
    
    <!-- Tab Content: Plantas -->
    <section id="plantas" class="tab-content">
      <div class="section">
        <h2 class="section-title">ğŸŒ± Minhas Plantas</h2>
        
        <div class="info-box">
          ğŸ’¾ Dados salvos localmente + Supabase
        </div>
        
        <div class="action-buttons">
          <button class="btn btn-secondary" id="btnImportar">
            ğŸ“¤ Importar QField
          </button>
          <button class="btn btn-secondary" id="btnExportar">
            ğŸ“¥ Exportar QField
          </button>
        </div>
        
        <input type="file" id="fileInput" accept=".geojson,.json" style="display: none;">
        
        <input type="search" class="search-box" id="searchPlanta" placeholder="ğŸ” Buscar planta..." autocomplete="off">
        
        <div id="plantasContainer">
          <div class="plantas-list" id="plantasList"></div>
        </div>
      </div>
    </section>

    <!-- Tab Content: HistÃ³rico -->
    <section id="historico" class="tab-content">
      <div class="section">
        <h2 class="section-title">ğŸ“œ HistÃ³rico de AÃ§Ãµes</h2>
        <div class="filter-group">
          <button class="filter-btn active" data-historico="7">Ãšltimos 7 dias</button>
          <button class="filter-btn" data-historico="30">Ãšltimos 30 dias</button>
          <button class="filter-btn" data-historico="todos">Tudo</button>
        </div>
        <div id="historicoList">
          <div class="loading">Carregando histÃ³rico...</div>
        </div>
      </div>
    </section>

    <!-- Tab Content: Stats -->
    <section id="stats" class="tab-content">
      <div class="section">
        <h2 class="section-title">ğŸ“Š EstatÃ­sticas Gerais</h2>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">Total Plantas</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statPend">0</div>
            <div class="stat-label">PendÃªncias</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statUrg">0</div>
            <div class="stat-label">Urgentes</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statEsp">0</div>
            <div class="stat-label">EspÃ©cies</div>
          </div>
        </div>

        <div class="section" style="margin-top: 1rem;">
          <h3 class="section-title">ğŸŒ³ Resumo por EspÃ©cie</h3>
          <div id="speciesSummary">
            <div class="loading">Calculando...</div>
          </div>
        </div>
      </div>
    </section>
    
    <!-- Tab Content: Config -->
    <section id="config" class="tab-content">
      <div class="section">
        <h2 class="section-title">ğŸ‘¤ Perfil de UsuÃ¡rio</h2>
        <div class="info-box">
          Selecione quem estÃ¡ fazendo as aÃ§Ãµes
        </div>
        <div id="profileSelector"></div>
        <button class="btn btn-primary" id="btnAddProfile">â• Adicionar Perfil</button>
      </div>

      <div class="section">
        <h2 class="section-title">ğŸ“‹ Intervalos por Esppecie (dias)</h2>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">
          Ajuste os intervalos de manutenÃ§Ã£o
        </p>
        
        <!-- ConfiguraÃ§Ãµes de intervalos -->
        <div id="intervalosConfig">
          <!-- SerÃ¡ preenchido dinamicamente -->
        </div>

        <button class="btn btn-primary" id="btnSaveConfig">ğŸ’¾ Salvar ConfiguraÃ§Ãµes</button>
      </div>
    </section>

    <!-- Modais -->
    <div id="profileModal" class="modal">
      <div class="modal-content">
        <h3 class="modal-title">Novo Perfil</h3>
        <input type="text" id="newProfileName" placeholder="Nome do perfil" class="search-box">
        <div class="modal-actions">
          <button class="btn btn-primary" id="btnCreateProfile">Criar</button>
          <button class="btn btn-secondary" id="btnCancelProfile">Cancelar</button>
        </div>
      </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast" class="toast" role="alert" aria-live="polite"></div>

    <!-- EspaÃ§o para footer -->
    <div class="footer-space"></div>
  </div>

  <!-- âœ… TODO JAVASCRIPT NO FINAL DO BODY -->
  <script>
    // ==============================================
    // ğŸš€ APP SÃTIO IPIRANGA - JavaScript Otimizado
    // ==============================================
    
    // ğŸ“¦ VARIÃVEIS GLOBAIS (Minimalistas)
    let plantas = [];
    let historico = [];
    let perfis = [];
    let perfilAtual = null;
    let config = {
      Mangabeira: { rega: 7, poda: 180, colheita: 90 },
      Cajueiro: { rega: 10, poda: 365, colheita: 60 },
      Coqueiro: { rega: 5, poda: 730, colheita: 30 },
      Cacau: { rega: 3, poda: 180, colheita: 120 }
    };
    
    let proximoId = 1;
    let calculoCache = new Map(); // ğŸš€ Cache de cÃ¡lculos
    let syncQueue = []; // ğŸš€ Fila de sincronizaÃ§Ã£o
    let syncInProgress = false;
    let debounceTimer;
    
    // ğŸ“‹ ESTADOS DE CARREGAMENTO LAZY
    const lazyLoaded = {
      historico: false,
      stats: false,
      config: false
    };

    // ğŸ¯ FUNÃ‡ÃƒO PRINCIPAL DE INICIALIZAÃ‡ÃƒO
    async function inicializarApp() {
      console.time('ğŸ“Š App Inicializado');
      
      try {
        // 1. Carregar dados ESSENCIAIS do localStorage (rÃ¡pido)
        await carregarDadosEssenciais();
        
        // 2. Aguardar prÃ³ximo frame para nÃ£o travar UI
        await new Promise(resolve => requestAnimationFrame(resolve));
        
        // 3. Esconder loading e mostrar app
        document.getElementById('appLoader').style.display = 'none';
        document.getElementById('mainApp').classList.add('visible');
        
        // 4. Configurar listeners bÃ¡sicos
        configurarListenersBasicos();
        
        // 5. Renderizar conteÃºdo inicial
        renderAcoes();
        
        // 6. Carregar dados secundÃ¡rios EM BACKGROUND
        setTimeout(() => carregarDadosSecundarios(), 100);
        
        console.timeEnd('ğŸ“Š App Inicializado');
        showToast('âœ… App carregado!', 2000);
        
      } catch (error) {
        console.error('âŒ Erro inicializaÃ§Ã£o:', error);
        // Fallback: mostrar app mesmo com erro
        document.getElementById('appLoader').style.display = 'none';
        document.getElementById('mainApp').classList.add('visible');
        showToast('âš ï¸ Usando dados locais', 3000);
      }
    }

    // ğŸ“¦ CARREGAMENTO ESSENCIAL (RÃPIDO)
    async function carregarDadosEssenciais() {
      // 1. Plantas (essencial)
      const saved = localStorage.getItem('sitio-plantas');
      if (saved) {
        plantas = JSON.parse(saved);
        proximoId = Math.max(...plantas.map(p => p.id), 0) + 1;
        document.getElementById('plantCount').textContent = `ğŸ“Š ${plantas.length} plantas`;
      }
      
      // 2. Perfis
      const savedPerfis = localStorage.getItem('sitio-perfis');
      perfis = savedPerfis ? JSON.parse(savedPerfis) : [{ id: 1, nome: 'Sistema', cor: '#10b981' }];
      
      // 3. Perfil atual
      const perfilSalvo = localStorage.getItem('sitio-perfil-atual');
      if (perfilSalvo) {
        const id = parseInt(perfilSalvo);
        perfilAtual = perfis.find(p => p.id === id);
      }
      
      // 4. Config
      const savedConfig = localStorage.getItem('sitio-config');
      if (savedConfig) {
        config = JSON.parse(savedConfig);
      }
      
      console.log(`âœ… ${plantas.length} plantas carregadas`);
    }

    // ğŸ“¦ CARREGAMENTO SECUNDÃRIO (BACKGROUND)
    async function carregarDadosSecundarios() {
      try {
        // HistÃ³rico (se nÃ£o muito grande)
        const savedHist = localStorage.getItem('sitio-historico');
        if (savedHist) {
          historico = JSON.parse(savedHist);
        }
        
        // Verificar conexÃ£o com Supabase em background
        if (navigator.onLine) {
          testarConexaoSupabase();
        }
        
      } catch (error) {
        // Silencioso - nÃ£o afeta UX
        console.log('Background load:', error.message);
      }
    }

    // ğŸ”§ CONFIGURAR LISTENERS
    function configurarListenersBasicos() {
      // Tabs
      document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
          const tabName = e.target.dataset.tab;
          switchTab(tabName);
        });
      });
      
      // Filtros aÃ§Ãµes
      document.querySelectorAll('.filter-btn[data-filter]').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const filtro = e.target.dataset.filter;
          filterAcoes(filtro);
        });
      });
      
      // Busca com DEBOUNCE ğŸš€
      const searchInput = document.getElementById('searchPlanta');
      searchInput.addEventListener('input', () => {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
          filtrarPlantas();
        }, 300);
      });
      
      // FormulÃ¡rio cadastro
      document.getElementById('formCadastro').addEventListener('submit', cadastrarPlanta);
      
      // BotÃ£o GPS
      document.getElementById('btnGPS').addEventListener('click', obterLocalizacao);
      
      // BotÃµes QField
      document.getElementById('btnImportar').addEventListener('click', () => {
        document.getElementById('fileInput').click();
      });
      document.getElementById('btnExportar').addEventListener('click', exportarParaQField);
      
      // ConfiguraÃ§Ãµes
      document.getElementById('btnSaveConfig').addEventListener('click', saveConfig);
      
      // SeleÃ§Ã£o espÃ©cie
      document.getElementById('novaEspecie').addEventListener('change', function() {
        document.getElementById('outraEspecieGroup').style.display = 
          this.value === 'Outra' ? 'block' : 'none';
      });
      
      // File import
      document.getElementById('fileInput').addEventListener('change', importGeoJSON);
      
      // Data atual
      document.getElementById('dataPlantio').value = new Date().toISOString().split('T')[0];
    }

    // ğŸš€ FUNÃ‡ÃƒO MARCAÃ‡ÃƒO FEITO OTIMIZADA
    async function marcarFeito(pid, tipo) {
      const p = plantas.find(pl => pl.id === pid);
      if (!p) return showToast('âŒ Planta nÃ£o encontrada');
      
      if (!perfilAtual) {
        showToast('âš ï¸ Selecione um perfil na Config');
        return;
      }
      
      try {
        // Atualizar localmente PRIMEIRO (instantÃ¢neo)
        const hoje = new Date().toISOString().split('T')[0];
        if (tipo === 'rega') p.ultRega = hoje;
        if (tipo === 'poda') p.ultPoda = hoje;
        if (tipo === 'colheita') p.ultColh = hoje;
        
        // Adicionar ao histÃ³rico local
        historico.push({
          id: Date.now(),
          tipo,
          planta: p.nome,
          plantaId: p.nomeId,
          perfil: perfilAtual.nome,
          data: new Date().toISOString()
        });
        
        // Salvar dados locais
        salvarDados();
        
        // Renderizar atualizaÃ§Ã£o IMEDIATA
        renderAcoes();
        renderStats();
        
        // Enviar para Supabase EM BACKGROUND (nÃ£o bloqueia)
        agendarSyncSupabase({
          planta_id: p.nomeId,
          acao_tipo: tipo,
          perfil: perfilAtual.nome,
          data: hoje
        });
        
        showToast(`âœ… ${tipo} registrada por ${perfilAtual.nome}`);
        
      } catch (error) {
        console.error('Erro marcarFeito:', error);
        showToast('âš ï¸ Salvo localmente (erro rede)');
      }
    }

    // ğŸš€ FILA DE SINCRONIZAÃ‡ÃƒO SUPABASE
    async function agendarSyncSupabase(dados) {
      syncQueue.push({ ...dados, timestamp: Date.now() });
      
      if (!syncInProgress && navigator.onLine) {
        processarFilaSync();
      }
    }

    async function processarFilaSync() {
      if (syncQueue.length === 0) {
        syncInProgress = false;
        return;
      }
      
      syncInProgress = true;
      const item = syncQueue.shift();
      
      try {
        // Timeout de 5 segundos
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 5000);
        
        const response = await fetch(
          'https://erbefbnjxgpetbetlzya.supabase.co/functions/v1/insertPonto',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(item),
            signal: controller.signal
          }
        );
        
        clearTimeout(timeoutId);
        
        if (!response.ok) throw new Error('Supabase error');
        
        console.log('âœ… Sync enviado:', item.planta_id);
        
      } catch (error) {
        console.warn('âŒ Sync falhou, recolocando na fila:', error.message);
        // Recoloca no inÃ­cio da fila para tentar depois
        syncQueue.unshift(item);
      }
      
      // Processar prÃ³ximo item apÃ³s delay
      setTimeout(() => processarFilaSync(), 1000);
    }

    // ğŸš€ RENDERIZAÃ‡ÃƒO OTIMIZADA
    function renderAcoes() {
      const container = document.getElementById('acoesHoje');
      if (!container) return;
      
      // Usar DocumentFragment para performance
      const fragment = document.createDocumentFragment();
      
      if (plantas.length === 0) {
        fragment.appendChild(createEmptyState('ğŸŒ±', 'Nenhuma planta cadastrada'));
      } else {
        const acoes = calcularAcoesPendentes();
        if (acoes.length === 0) {
          fragment.appendChild(createEmptyState('âœ…', 'Tudo em dia!'));
        } else {
          acoes.forEach(acao => {
            fragment.appendChild(createActionItem(acao));
          });
        }
      }
      
      container.innerHTML = '';
      container.appendChild(fragment);
      
      // Atualizar contador
      document.getElementById('actionCount').textContent = `ğŸ“‹ ${calcularTotalAcoes()} aÃ§Ãµes`;
    }

    // ğŸš€ CACHE DE CÃLCULOS
    function calcularAcoesPendentes() {
      const cacheKey = `acoes-${plantas.length}-${Date.now() - (Date.now() % 60000)}`; // Cache por minuto
      
      if (calculoCache.has(cacheKey)) {
        return calculoCache.get(cacheKey);
      }
      
      const acoes = [];
      plantas.forEach(p => {
        const int = getIntervalos(p.nome);
        const hoje = new Date();
        
        // Rega
        const diasRega = p.ultRega ? Math.floor((hoje - new Date(p.ultRega)) / 86400000) : 999;
        if (diasRega >= int.rega) {
          acoes.push({
            planta: `${p.nome} #${p.nomeId}`,
            tipo: 'rega',
            icon: 'ğŸ’§',
            urgente: diasRega >= int.rega + 2,
            dias: diasRega,
            pid: p.id
          });
        }
        
        // Poda
        const diasPoda = p.ultPoda ? Math.floor((hoje - new Date(p.ultPoda)) / 86400000) : 999;
        if (diasPoda >= int.poda) {
          acoes.push({
            planta: `${p.nome} #${p.nomeId}`,
            tipo: 'poda',
            icon: 'âœ‚ï¸',
            urgente: false,
            dias: diasPoda,
            pid: p.id
          });
        }
      });
      
      calculoCache.set(cacheKey, acoes);
      return acoes;
    }

    function calcularTotalAcoes() {
      const cacheKey = `total-${plantas.length}`;
      if (calculoCache.has(cacheKey)) {
        return calculoCache.get(cacheKey);
      }
      
      let total = 0;
      plantas.forEach(p => {
        const int = getIntervalos(p.nome);
        const hoje = new Date();
        
        const diasRega = p.ultRega ? Math.floor((hoje - new Date(p.ultRega)) / 86400000) : 999;
        if (diasRega >= int.rega) total++;
        
        const diasPoda = p.ultPoda ? Math.floor((hoje - new Date(p.ultPoda)) / 86400000) : 999;
        if (diasPoda >= int.poda) total++;
      });
      
      calculoCache.set(cacheKey, total);
      return total;
    }

    // ğŸš€ HELPERS DE RENDERIZAÃ‡ÃƒO
    function createEmptyState(icon, text) {
      const div = document.createElement('div');
      div.className = 'empty-state';
      div.innerHTML = `
        <div class="empty-state-icon">${icon}</div>
        <p>${text}</p>
      `;
      return div;
    }

    function createActionItem(acao) {
      const div = document.createElement('div');
      div.className = `action-item ${acao.urgente ? 'urgent' : ''}`;
      div.innerHTML = `
        <div class="action-title">
          ${acao.icon} ${acao.planta}
          ${acao.urgente ? '<span class="badge urgent">URGENTE</span>' : ''}
        </div>
        <div class="action-desc">${acao.dias === 999 ? 'Nunca realizada' : `HÃ¡ ${acao.dias} dias`}</div>
        <div class="action-meta">Por: ${perfilAtual?.nome || 'Selecione perfil'}</div>
        <button class="btn btn-primary" onclick="marcarFeito(${acao.pid}, '${acao.tipo}')">
          âœ“ Marcar como feito
        </button>
      `;
      return div;
    }

    // ğŸ“Š FUNÃ‡Ã•ES RESTANTES (Simplificadas)
    function getIntervalos(nome) {
      const n = nome.toLowerCase();
      if (n.includes('mangabeira')) return config.Mangabeira;
      if (n.includes('caju')) return config.Cajueiro;
      if (n.includes('coq')) return config.Coqueiro;
      if (n.includes('cacau')) return config.Cacau;
      return { rega: 7, poda: 180, colheita: 90 };
    }

    function switchTab(tabName) {
      // Atualizar tabs
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      
      document.querySelector(`.tab[data-tab="${tabName}"]`).classList.add('active');
      document.getElementById(tabName).classList.add('active');
      
      // ğŸš€ LAZY LOADING DE CONTEÃšDO
      if (tabName === 'historico' && !lazyLoaded.historico) {
        renderHistorico();
        lazyLoaded.historico = true;
      }
      if (tabName === 'stats' && !lazyLoaded.stats) {
        renderStats();
        lazyLoaded.stats = true;
      }
      if (tabName === 'plantas') {
        renderPlantas();
      }
    }

    function filterAcoes(filtro) {
      document.querySelectorAll('#acoes .filter-btn').forEach(b => b.classList.remove('active'));
      event.target.classList.add('active');
      // Renderizar filtrado
      renderAcoes();
    }

    function filtrarPlantas() {
      renderPlantas();
    }

    function renderPlantas() {
      const container = document.getElementById('plantasList');
      const searchTerm = document.getElementById('searchPlanta').value.toLowerCase();
      
      if (plantas.length === 0) {
        container.innerHTML = '<div class="empty-state"><div>ğŸŒ±</div><p>Nenhuma planta</p></div>';
        return;
      }
      
      const fragment = document.createDocumentFragment();
      const pFilt = plantas.filter(p => 
        p.nome.toLowerCase().includes(searchTerm) || 
        (p.nomeId && p.nomeId.toLowerCase().includes(searchTerm))
      );
      
      pFilt.forEach(p => {
        const card = document.createElement('div');
        card.className = 'plant-card';
        card.innerHTML = `
          <div class="plant-header">
            <div class="plant-name">ğŸŒ¿ ${p.nome}</div>
            <div style="color: #10b981; font-weight: 600;">#${p.nomeId || p.id}</div>
          </div>
          <div class="plant-info">
            <div>ğŸ’§ Rega: ${p.ultRega || 'NÃ£o registrada'}</div>
            <div>âœ‚ï¸ Poda: ${p.ultPoda || 'NÃ£o registrada'}</div>
            ${p.dataPlantio ? `<div>ğŸŒ± Plantio: ${p.dataPlantio}</div>` : ''}
          </div>
        `;
        fragment.appendChild(card);
      });
      
      container.innerHTML = '';
      container.appendChild(fragment);
      document.getElementById('plantCount').textContent = `ğŸ“Š ${plantas.length} plantas`;
    }

    function renderHistorico() {
      const container = document.getElementById('historicoList');
      if (historico.length === 0) {
        container.innerHTML = '<div class="empty-state"><div>ğŸ“œ</div><p>Nenhum registro</p></div>';
        return;
      }
      
      const fragment = document.createDocumentFragment();
      historico.slice(-20).reverse().forEach(h => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `
          <div style="font-weight: 600;">${getTipoIcon(h.tipo)} ${h.planta} #${h.plantaId}</div>
          <div style="font-size: 0.8rem; color: #666;">ğŸ‘¤ ${h.perfil} â€¢ ğŸ“… ${new Date(h.data).toLocaleDateString('pt-BR')}</div>
        `;
        fragment.appendChild(div);
      });
      
      container.innerHTML = '';
      container.appendChild(fragment);
    }

    function renderStats() {
      document.getElementById('statTotal').textContent = plantas.length;
      document.getElementById('statPend').textContent = calcularTotalAcoes();
      
      // Calcular espÃ©cies Ãºnicas
      const especies = [...new Set(plantas.map(p => p.nome))];
      document.getElementById('statEsp').textContent = especies.length;
      
      // Resumo por espÃ©cie
      const summary = document.getElementById('speciesSummary');
      if (especies.length === 0) {
        summary.innerHTML = '<div class="info-box">Nenhuma planta</div>';
      } else {
        const lista = especies.map(e => {
          const count = plantas.filter(p => p.nome === e).length;
          return `<div><strong>${e}</strong> <span>${count}</span></div>`;
        }).join('');
        summary.innerHTML = `<div class="species-list">${lista}</div>`;
      }
    }

    // ğŸ’¾ FUNÃ‡Ã•ES DE SALVAMENTO
    function salvarDados() {
      try {
        localStorage.setItem('sitio-plantas', JSON.stringify(plantas));
        localStorage.setItem('sitio-historico', JSON.stringify(historico.slice(-100))); // Limitar histÃ³rico
        localStorage.setItem('sitio-perfis', JSON.stringify(perfis));
        localStorage.setItem('sitio-config', JSON.stringify(config));
        localStorage.setItem('sitio-proximo-id', proximoId.toString());
        if (perfilAtual) {
          localStorage.setItem('sitio-perfil-atual', perfilAtual.id.toString());
        }
      } catch (error) {
        console.error('Erro ao salvar:', error);
      }
    }

    // ğŸ“¤ FUNÃ‡Ã•ES SUPABASE
    async function testarConexaoSupabase() {
      try {
        const response = await fetch(
          'https://erbefbnjxgpetbetlzya.supabase.co/functions/v1/insertPonto',
          {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              planta_id: 'TESTE',
              acao_tipo: 'teste',
              perfil: 'Sistema',
              observacao: 'Teste de conexÃ£o'
            })
          }
        );
        
        if (response.ok) {
          console.log('âœ… Supabase conectado');
        }
      } catch (error) {
        console.log('â„¹ï¸ Supabase offline ou nÃ£o configurado');
      }
    }

    // ğŸ› ï¸ FUNÃ‡Ã•ES UTILITÃRIAS
    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    function getTipoIcon(tipo) {
      const icons = { rega: 'ğŸ’§', poda: 'âœ‚ï¸', colheita: 'ğŸŠ', cadastro: 'ğŸŒ±' };
      return icons[tipo] || 'ğŸ“Œ';
    }

    // ğŸ“‹ FUNÃ‡Ã•ES RESTANTES (mantenha as que jÃ¡ funcionam)
    async function cadastrarPlanta(event) {
      event.preventDefault();
      // ... implementaÃ§Ã£o existente ...
      showToast('âœ… Planta cadastrada!');
    }

    function obterLocalizacao() {
      // ... implementaÃ§Ã£o existente ...
    }

    function exportarParaQField() {
      // ... implementaÃ§Ã£o existente ...
    }

    function importGeoJSON(event) {
      // ... implementaÃ§Ã£o existente ...
    }

    function saveConfig() {
      // ... implementaÃ§Ã£o existente ...
    }

    function renderPerfis() {
      // ... implementaÃ§Ã£o existente ...
    }

    // ğŸš€ INICIAR APP QUANDO DOM PRONTO
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', inicializarApp);
    } else {
      inicializarApp();
    }

    // ğŸŒ DETECÃ‡ÃƒO ONLINE/OFFLINE
    window.addEventListener('online', () => {
      document.getElementById('statusDot').classList.remove('offline');
      document.getElementById('statusText').textContent = 'Online';
      showToast('âœ… Conectado');
      // Processar fila de sync quando online
      if (syncQueue.length > 0) {
        processarFilaSync();
      }
    });

    window.addEventListener('offline', () => {
      document.getElementById('statusDot').classList.add('offline');
      document.getElementById('statusText').textContent = 'Offline';
      showToast('âš ï¸ Modo offline ativado');
    });
  </script>

  <!-- ğŸ¨ CSS COMPLETO EM ARQUIVO SEPARADO -->
  <style>
    /* Coloque aqui todo o resto do CSS do seu app */
    /* Status bar, header, tabs, cards, etc */
    /* Ou mantenha em arquivo app.css externo */
    
    .status-bar { background: #1f2937; color: white; padding: 0.5rem 1rem; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
    .status-indicator { display: flex; align-items: center; gap: 0.5rem; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #10b981; animation: pulse 2s infinite; }
    .status-dot.offline { background: #ef4444; animation: none; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .header { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.5rem 1rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); position: sticky; top: 0; z-index: 100; }
    .header h1 { font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    .header-stats { font-size: 0.9rem; opacity: 0.95; display: flex; gap: 1rem; flex-wrap: wrap; }
    
    .tabs { display: flex; background: white; border-bottom: 2px solid #e5e7eb; overflow-x: auto; position: sticky; top: 100px; z-index: 99; }
    .tab { flex: 1; padding: 1rem; border: none; background: white; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; white-space: nowrap; border-bottom: 3px solid transparent; min-width: 100px; }
    .tab.active { border-bottom-color: #10b981; color: #10b981; font-weight: 600; }
    
    .tab-content { display: none; padding: 1rem; }
    .tab-content.active { display: block; animation: fadeIn 0.3s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    
    .section { background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .section-title { font-size: 1.1rem; font-weight: 600; margin-bottom: 1rem; color: #1f2937; display: flex; align-items: center; gap: 0.5rem; }
    
    .action-item { padding: 1rem; border-left: 4px solid #10b981; background: #f0fdf4; border-radius: 8px; margin-bottom: 0.75rem; }
    .action-item.urgent { border-left-color: #ef4444; background: #fef2f2; }
    .action-item.warning { border-left-color: #f59e0b; background: #fffbeb; }
    .action-title { font-weight: 600; font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; }
    .action-meta { font-size: 0.75rem; color: #6b7280; margin-top: 0.25rem; }
    .badge { display: inline-block; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600; }
    .badge.urgent { background: #fee2e2; color: #dc2626; }
    .badge.warning { background: #fef3c7; color: #d97706; }
    .action-desc { color: #4b5563; font-size: 0.9rem; margin-bottom: 0.5rem; }
    
    .btn { padding: 0.75rem 1.25rem; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; width: 100%; margin-top: 0.75rem; font-size: 0.9rem; transition: all 0.2s; }
    .btn-primary { background: #10b981; color: white; }
    .btn-primary:active { background: #059669; transform: scale(0.98); }
    .btn-secondary { background: white; color: #10b981; border: 2px solid #10b981; }
    
    .filter-group { display: flex; gap: 0.5rem; margin-bottom: 1rem; overflow-x: auto; padding-bottom: 0.25rem; }
    .filter-btn { padding: 0.5rem 1rem; border: 1px solid #d1d5db; background: white; border-radius: 6px; cursor: pointer; font-size: 0.85rem; white-space: nowrap; transition: all 0.2s; }
    .filter-btn.active { background: #10b981; color: white; border-color: #10b981; }
    
    .search-box, .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 6px; font-size: 0.9rem; margin-bottom: 1rem; font-family: inherit; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; font-weight: 600; margin-bottom: 0.5rem; color: #374151; font-size: 0.9rem; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
    
    .plant-card { background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; margin-bottom: 0.75rem; cursor: pointer; transition: all 0.2s; }
    .plant-card:active { transform: scale(0.98); }
    .plant-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; }
    .plant-name { font-weight: 600; font-size: 1rem; }
    .plant-info { display: grid; gap: 0.5rem; font-size: 0.85rem; color: #6b7280; }
    
    .info-box { background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; font-size: 0.9rem; color: #0c4a6e; }
    .success-box { background: #f0fdf4; border: 1px solid #86efac; color: #166534; }
    .warning-box { background: #fffbeb; border: 1px solid #fde68a; color: #92400e; }
    .error-box { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; }
    
    .toast { position: fixed; bottom: 2rem; left: 50%; transform: translateX(-50%); background: #1f2937; color: white; padding: 1rem 1.5rem; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 2000; display: none; max-width: 90%; }
    .toast.show { display: block; animation: slideUp 0.3s; }
    
    .loading { text-align: center; padding: 2rem; color: #6b7280; }
    .empty-state { text-align: center; padding: 3rem 1rem; color: #9ca3af; }
    .empty-state-icon { font-size: 3rem; margin-bottom: 1rem; }
    
    .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem; }
    .stat-card { background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; padding: 1.25rem; border-radius: 12px; text-align: center; }
    .stat-value { font-size: 2rem; font-weight: 700; margin-bottom: 0.25rem; }
    .stat-label { font-size: 0.85rem; opacity: 0.9; }
    
    .profile-item { padding: 0.75rem 1rem; border: 2px solid #d1d5db; background: white; border-radius: 8px; cursor: pointer; font-weight: 500; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; transition: all 0.2s; }
    .profile-item.active { border-color: #10b981; background: #f0fdf4; color: #10b981; }
    .profile-delete { background: #ef4444; color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-weight: bold; font-size: 0.9rem; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; padding: 1rem; }
    .modal.active { display: flex; }
    .modal-content { background: white; padding: 2rem; border-radius: 12px; max-width: 90%; max-height: 90vh; overflow-y: auto; animation: slideUp 0.3s; }
    .modal-title { font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem; }
    
    .footer-space { height: 2rem; }
  </style>
</body>
</html>
