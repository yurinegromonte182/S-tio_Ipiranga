
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="App para gest√£o e monitoramento das frut√≠feras do S√≠tio Ipiranga">
  <meta name="theme-color" content="#10b981">
  <title>S√≠tio Ipiranga - Gest√£o de Frut√≠feras</title>
  
  <link rel="manifest" href="manifest.json">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="S√≠tio Ipiranga">
  
  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f3f4f6;
      overflow-x: hidden;
      min-height: 100vh;
    }

    #appLoader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      color: white;
      transition: opacity 0.3s;
    }

    #appLoader.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loader-icon {
      font-size: 4rem;
      animation: bounce 1s infinite;
      margin-bottom: 1rem;
    }

    .loader-text {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .loader-progress {
      width: 200px;
      height: 4px;
      background: rgba(255,255,255,0.3);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 1rem;
    }

    .loader-bar {
      height: 100%;
      background: white;
      width: 0%;
      animation: progressBar 2s ease-in-out infinite;
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-20px); }
    }

    @keyframes progressBar {
      0% { width: 0%; }
      50% { width: 70%; }
      100% { width: 100%; }
    }

    #mainApp {
      opacity: 0;
      transition: opacity 0.3s;
      min-height: 100vh;
    }

    #mainApp.loaded {
      opacity: 1;
    }

    .status-bar {
      background: #1f2937;
      color: white;
      padding: 0.5rem 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.85rem;
    }

    .status-indicator {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #10b981;
      animation: pulse 2s infinite;
    }

    .status-dot.offline {
      background: #ef4444;
      animation: none;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .header {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 1.5rem 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header h1 {
      font-size: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    
    .header-stats {
      font-size: 0.9rem;
      opacity: 0.95;
      display: flex;
      gap: 1rem;
      flex-wrap: wrap;
    }
    
    .tabs {
      display: flex;
      background: white;
      border-bottom: 2px solid #e5e7eb;
      overflow-x: auto;
      position: sticky;
      top: 100px;
      z-index: 99;
    }
    
    .tab {
      flex: 1;
      padding: 1rem;
      border: none;
      background: white;
      cursor: pointer;
      font-size: 0.85rem;
      transition: all 0.2s;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      min-width: 100px;
    }
    
    .tab.active {
      border-bottom-color: #10b981;
      color: #10b981;
      font-weight: 600;
    }
    
    .tab-content {
      display: none;
      padding: 1rem;
      animation: fadeIn 0.3s;
    }
    
    .tab-content.active {
      display: block;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .section {
      background: white;
      border-radius: 12px;
      padding: 1rem;
      margin-bottom: 1rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 1rem;
      color: #1f2937;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s;
    }

    .section-title.clickable {
      cursor: pointer;
      user-select: none;
    }

    .section-title.clickable:hover {
      color: #10b981;
    }

    #cadastroFormContainer {
      transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
      overflow: hidden;
      max-height: 2000px;
      opacity: 1;
    }

    #cadastroFormContainer.collapsed {
      max-height: 0;
      opacity: 0;
      margin-bottom: 0;
    }
    
    .action-item {
      padding: 1rem;
      border-left: 4px solid #10b981;
      background: #f0fdf4;
      border-radius: 8px;
      margin-bottom: 0.75rem;
    }
    
    .action-item.urgent {
      border-left-color: #ef4444;
      background: #fef2f2;
    }
    
    .action-item.warning {
      border-left-color: #f59e0b;
      background: #fffbeb;
    }

    .action-title {
      font-weight: 600;
      font-size: 1rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }

    .action-meta {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 0.25rem;
    }
    
    .badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge.urgent {
      background: #fee2e2;
      color: #dc2626;
    }
    
    .badge.warning {
      background: #fef3c7;
      color: #d97706;
    }
    
    .action-desc {
      color: #4b5563;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    
    .btn {
      padding: 0.75rem 1.25rem;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      width: 100%;
      margin-top: 0.75rem;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: #10b981;
      color: white;
    }
    
    .btn-primary:active {
      background: #059669;
      transform: scale(0.98);
    }

    .btn-secondary {
      background: white;
      color: #10b981;
      border: 2px solid #10b981;
    }

    .filter-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
      overflow-x: auto;
      padding-bottom: 0.25rem;
    }
    
    .filter-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #d1d5db;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
      white-space: nowrap;
      transition: all 0.2s;
    }
    
    .filter-btn.active {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .search-box, .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #d1d5db;
      border-radius: 6px;
      font-size: 0.9rem;
      margin-bottom: 1rem;
      font-family: inherit;
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.5rem;
      color: #374151;
      font-size: 0.9rem;
    }

    .form-group textarea {
      min-height: 80px;
      resize: vertical;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 1rem;
    }

    .frutifera-card {
      background: white;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .frutifera-card:active {
      transform: scale(0.98);
    }
    
    .frutifera-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.75rem;
    }
    
    .frutifera-name {
      font-weight: 600;
      font-size: 1rem;
    }
    
    .frutifera-info {
      display: grid;
      gap: 0.5rem;
      font-size: 0.85rem;
      color: #6b7280;
    }

    .info-box {
      background: #f0f9ff;
      border: 1px solid #bae6fd;
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: #0c4a6e;
    }

    .success-box {
      background: #f0fdf4;
      border: 1px solid #86efac;
      color: #166534;
    }

    .warning-box {
      background: #fffbeb;
      border: 1px solid #fde68a;
      color: #92400e;
    }

    .error-box {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #991b1b;
    }

    .toast {
      position: fixed;
      bottom: 2rem;
      left: 50%;
      transform: translateX(-50%);
      background: #1f2937;
      color: white;
      padding: 1rem 1.5rem;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      z-index: 2000;
      display: none;
      max-width: 90%;
    }

    .toast.show {
      display: block;
      animation: slideUp 0.3s;
    }

    @keyframes slideUp {
      from { transform: translateY(20px) translateX(-50%); opacity: 0; }
      to { transform: translateY(0) translateX(-50%); opacity: 1; }
    }

    .loading {
      text-align: center;
      padding: 2rem;
      color: #6b7280;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: #9ca3af;
    }
    
    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 1rem;
      margin-bottom: 1rem;
    }
    
    .stat-card {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 1.25rem;
      border-radius: 12px;
      text-align: center;
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
    }
    
    .stat-label {
      font-size: 0.85rem;
      opacity: 0.9;
    }

    .footer-space {
      height: 2rem;
    }

    /* ESTILOS DO MAPA */
    #mapContainer {
      width: 100%;
      height: calc(100vh - 180px);
      min-height: 400px;
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .map-controls {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    .map-btn {
      padding: 0.75rem;
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
      text-align: center;
    }

    .map-btn:hover {
      border-color: #10b981;
      color: #10b981;
    }

    .map-btn.active {
      background: #10b981;
      color: white;
      border-color: #10b981;
    }

    .layer-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      margin-bottom: 0.5rem;
    }

    .layer-label {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .layer-badge {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 3px solid currentColor;
    }

    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #d1d5db;
      border-radius: 24px;
      transition: all 0.2s;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: all 0.2s;
    }

    input:checked + .toggle-slider {
      background-color: #10b981;
    }

    input:checked + .toggle-slider:before {
      transform: translateX(20px);
    }

    .leaflet-popup-content-wrapper {
      border-radius: 8px !important;
    }

    .leaflet-popup-content {
      font-family: inherit !important;
      line-height: 1.6 !important;
      margin: 0.75rem !important;
    }

    .popup-content h3 {
      margin: 0 0 0.75rem 0;
      color: #10b981;
      border-bottom: 2px solid #10b981;
      padding-bottom: 0.5rem;
      font-size: 1.1rem;
    }

    .popup-content .info-row {
      margin: 0.5rem 0;
      display: flex;
      justify-content: space-between;
      gap: 1rem;
      font-size: 0.85rem;
    }

    .popup-content .info-label {
      font-weight: 600;
      color: #6b7280;
    }

    .popup-content .info-value {
      color: #1f2937;
      text-align: right;
    }

    @media (max-width: 768px) {
      #mapContainer {
        height: calc(100vh - 220px);
      }
      
      .map-controls {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <div id="appLoader">
    <div class="loader-icon">üåø</div>
    <div class="loader-text">S√≠tio Ipiranga</div>
    <div style="font-size: 0.9rem; opacity: 0.9;">Carregando frut√≠feras...</div>
    <div class="loader-progress">
      <div class="loader-bar"></div>
    </div>
  </div>

  <div id="mainApp">
    <div class="status-bar">
      <div class="status-indicator">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Online</span>
      </div>
      <div id="syncStatus" style="font-size: 0.75rem;">S√≠tio Ipiranga</div>
    </div>

    <div class="header">
      <h1>üåø S√≠tio Ipiranga</h1>
      <div class="header-stats">
        <span id="frutiferaCount">üìä 0 frut√≠feras</span>
        <span id="actionCount">üìã 0 a√ß√µes</span>
        <span style="background: rgba(255,255,255,0.2); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.8rem;">‚úÖ Supabase</span>
      </div>
    </div>
    
    <div class="tabs">
      <button class="tab active" onclick="switchTab(event, 'acoes')">üìã A√ß√µes</button>
      <button class="tab" onclick="switchTab(event, 'mapa')">üó∫Ô∏è Mapa</button>
      <button class="tab" onclick="switchTab(event, 'frutiferas')">üå± Frut√≠feras</button>
      <button class="tab" onclick="switchTab(event, 'historico')">üìú Hist√≥rico</button>
      <button class="tab" onclick="switchTab(event, 'stats')">üìä Stats</button>
      <button class="tab" onclick="switchTab(event, 'config')">‚öôÔ∏è Config</button>
    </div>
    
    <!-- Tab: A√ß√µes -->
    <div id="acoes" class="tab-content active">
      <div class="section">
        <div class="section-title">üìã A√ß√µes Necess√°rias Hoje</div>
        
        <div id="autoSyncInfo" class="info-box">
          <span>üì° Dados sincronizados com Supabase</span><br>
          <small>As a√ß√µes s√£o salvas localmente e sincronizadas com o banco de dados</small>
        </div>
        
        <div class="filter-group">
          <button class="filter-btn active" onclick="filterAcoes(event, 'todas')">Todas</button>
          <button class="filter-btn" onclick="filterAcoes(event, 'urgente')">üö® Urgentes</button>
          <button class="filter-btn" onclick="filterAcoes(event, 'rega')">üíß Rega</button>
          <button class="filter-btn" onclick="filterAcoes(event, 'poda')">‚úÇÔ∏è Poda</button>
          <button class="filter-btn" onclick="filterAcoes(event, 'colheita')">üçä Colheita</button>
        </div>
        <div id="acoesHoje">
          <div class="loading">Carregando dados...</div>
        </div>
      </div>
    </div>

    <!-- Tab: Mapa -->
    <div id="mapa" class="tab-content">
      <div class="section">
        <div class="section-title">üó∫Ô∏è Visualiza√ß√£o do Mapa</div>
        
        <!-- Bot√£o de Sincronizar (EM CIMA DO MAPA) -->
        <button class="btn btn-secondary" onclick="sincronizarComSupabase()" 
                style="margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; width: 100%; position: relative; padding: 0.75rem; border: 2px solid #10b981; background: white; color: #10b981; font-weight: 600; border-radius: 8px; cursor: pointer;">
          <span>üîÑ</span>
          <span id="syncButtonText">Sincronizar com Banco de Dados</span>
        </button>
        
        <div id="syncMessage" style="font-size: 0.85rem; color: #6b7280; margin-bottom: 1rem; text-align: center; min-height: 1.2rem;"></div>
        
        <div class="info-box" style="margin-bottom: 1rem;">
          <strong>üìç Visualize todas as frut√≠feras georeferenciadas no mapa</strong><br>
          <small>Clique nos pontos para ver detalhes. Use o bot√£o acima para sincronizar novas frut√≠feras.</small>
        </div>

        <!-- Controles do Mapa -->
        <div class="map-controls" style="margin-bottom: 1rem;">
          <button class="map-btn" data-basemap="satellite" onclick="changeBasemap('satellite', event)">
            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">üõ∞Ô∏è</div>
            <div style="font-size: 0.75rem; font-weight: 600;">Sat√©lite</div>
          </button>
          <button class="map-btn active" data-basemap="orthomosaic" onclick="changeBasemap('orthomosaic', event)">
            <div style="font-size: 1.5rem; margin-bottom: 0.25rem;">üì∏</div>
            <div style="font-size: 0.75rem; font-weight: 600;">Ortomosaico</div>
          </button>
        </div>

        <!-- Toggle da camada de frut√≠feras -->
        <div class="layer-toggle" style="margin-bottom: 1rem;">
          <div class="layer-label">
            <div class="layer-badge" style="color: #10b981; background-color: #10b981;"></div>
            <span style="font-weight: 500;">Frut√≠feras no mapa</span>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="toggleFrutiferas" checked onchange="toggleFrutiferasLayer()">
            <span class="toggle-slider"></span>
          </label>
        </div>

        <!-- Legenda de Esp√©cies -->
        <div style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); border: 1px solid #e5e7eb; border-radius: 10px; padding: 1rem; margin-bottom: 1.5rem; box-shadow: 0 1px 3px rgba(0,0,0,0.05);">
          <div style="font-size: 0.8rem; font-weight: 700; color: #374151; margin-bottom: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">üåø Legenda por Esp√©cie</div>
          <div id="mapLegend" style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
              <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #10b981; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div>
              <span style="font-size: 0.8rem; font-weight: 500;">ü•≠ Mangabeira</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
              <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #f59e0b; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div>
              <span style="font-size: 0.8rem; font-weight: 500;">üå∞ Cajueiro</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
              <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #ef4444; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div>
              <span style="font-size: 0.8rem; font-weight: 500;">ü•• Coqueiro</span>
            </div>
            <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 6px; border: 1px solid #e5e7eb;">
              <div style="width: 16px; height: 16px; border-radius: 50%; background-color: #8b5cf6; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.1);"></div>
              <span style="font-size: 0.8rem; font-weight: 500;">üç´ Cacau</span>
            </div>
          </div>
        </div>

        <!-- Container do Mapa -->
        <div id="mapContainer" style="width: 100%; height: 50vh; min-height: 400px; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.1); border: 1px solid #e5e7eb; margin-bottom: 2rem;"></div>

        <!-- Se√ß√£o de Cadastro (EMBAIXO DO MAPA) -->
        <div style="background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%); border-radius: 12px; padding: 1.5rem; border: 1px solid #bbf7d0; margin-top: 1rem;">
          <div class="section-title clickable" onclick="toggleCadastroForm()" 
               style="cursor: pointer; display: flex; align-items: center; justify-content: space-between; padding: 1rem; background: white; border-radius: 8px; margin-bottom: 1rem; border-left: 4px solid #10b981; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <span style="font-size: 1.5rem; color: #10b981;">‚ûï</span>
              <div>
                <div style="font-weight: 700; color: #1f2937; font-size: 1.1rem;">Cadastrar Nova Frut√≠fera</div>
                <div style="font-size: 0.8rem; color: #6b7280; margin-top: 0.25rem;">Clique para expandir/recolher</div>
              </div>
            </div>
            <span id="cadastroToggleIcon" style="font-size: 1.5rem; color: #10b981; transition: transform 0.3s ease;">‚ñº</span>
          </div>
          
          <div id="cadastroFormContainer" class="cadastro-form-container">
            <div class="info-box" style="background: white; border: 1px solid #bbf7d0; color: #065f46; margin-bottom: 1.5rem;">
              <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="font-size: 1.2rem;">üå±</span>
                <strong>Como funciona:</strong>
              </div>
              <div style="font-size: 0.9rem; line-height: 1.5;">
                1. Preencha os dados da frut√≠fera<br>
                2. Clique em "Cadastrar Frut√≠fera"<br>
                3. A frut√≠fera aparecer√° no mapa<br>
                4. Use o bot√£o "Sincronizar" acima para enviar ao banco de dados
              </div>
            </div>

            <form onsubmit="cadastrarFrutifera(event)" id="formCadastroFrutifera" style="background: white; padding: 1.5rem; border-radius: 10px; border: 1px solid #e5e7eb; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
              <!-- Esp√©cie -->
              <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.2rem;">üåø</span>
                  <span style="font-weight: 600; color: #374151;">Esp√©cie *</span>
                </label>
                <select id="novaEspecie" required style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem; background: white; transition: all 0.2s;" 
                        onfocus="this.style.borderColor='#10b981'" onblur="this.style.borderColor='#d1d5db'">
                  <option value="">Selecione uma esp√©cie...</option>
                  <option value="Mangabeira">ü•≠ Mangabeira</option>
                  <option value="Cajueiro">üå∞ Cajueiro</option>
                  <option value="Coqueiro">ü•• Coqueiro</option>
                  <option value="Cacau">üç´ Cacau</option>
                </select>
              </div>

              <!-- Data do Plantio e Idade -->
              <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin: 1.5rem 0;">
                <div class="form-group">
                  <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.2rem;">üìÖ</span>
                    <span style="font-weight: 600; color: #374151;">Data do Plantio *</span>
                  </label>
                  <input type="date" id="dataPlantio" required style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;">
                </div>
                <div class="form-group">
                  <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                    <span style="font-size: 1.2rem;">üå±</span>
                    <span style="font-weight: 600; color: #374151;">Idade (meses)</span>
                  </label>
                  <input type="number" id="idadeFrutifera" min="0" placeholder="Ex: 12" style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;">
                </div>
              </div>

              <!-- Localiza√ß√£o GPS -->
              <div class="form-group" style="margin: 1.5rem 0;">
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.2rem;">üìç</span>
                  <span style="font-weight: 600; color: #374151;">Localiza√ß√£o GPS</span>
                </label>
                <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.75rem; align-items: end;">
                  <input type="text" id="coordenadas" placeholder="Latitude, Longitude" readonly 
                         style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem; background: #f9fafb;">
                  <button type="button" onclick="obterLocalizacao()" 
                          style="padding: 0.75rem 1.25rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; white-space: nowrap; transition: all 0.2s;"
                          onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'"
                          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <span style="font-size: 1.2rem; margin-right: 0.5rem;">üìç</span>
                    Obter GPS
                  </button>
                </div>
                <div id="coordDisplay" style="background: #f0f9ff; padding: 0.75rem; border-radius: 6px; font-size: 0.9rem; color: #0c4a6e; margin-top: 0.75rem; display: none; border: 1px solid #bae6fd;"></div>
              </div>

              <!-- Respons√°vel -->
              <div class="form-group" style="margin: 1.5rem 0;">
                <label style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                  <span style="font-size: 1.2rem;">üë§</span>
                  <span style="font-weight: 600; color: #374151;">Respons√°vel pelo plantio</span>
                </label>
                <input type="text" id="responsavel" placeholder="Digite o nome do respons√°vel" 
                       style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 8px; font-size: 1rem;">
              </div>

              <!-- Bot√£o de Cadastro -->
              <button type="submit" class="btn btn-primary" 
                      style="width: 100%; padding: 1rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 10px; font-size: 1.1rem; font-weight: 700; cursor: pointer; margin-top: 1rem; transition: all 0.3s; display: flex; align-items: center; justify-content: center; gap: 0.75rem;"
                      onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.4)'"
                      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                <span style="font-size: 1.5rem;">‚úÖ</span>
                <span>Cadastrar Frut√≠fera</span>
              </button>
              
              <div style="text-align: center; margin-top: 1rem; color: #6b7280; font-size: 0.85rem;">
                <span style="display: inline-flex; align-items: center; gap: 0.25rem;">
                  <span>üí°</span> 
                  A frut√≠fera ser√° salva localmente e aparecer√° no mapa imediatamente
                </span>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Tab: Frut√≠feras -->
    <div id="frutiferas" class="tab-content">
      <div class="section">
        <div class="section-title">üå± Minhas Frut√≠feras</div>
        
        <div class="info-box">
          üíæ Dados sincronizados com Supabase
        </div>
        
        <input type="text" class="search-box" id="searchFrutifera" placeholder="üîé Buscar frut√≠fera..." onkeyup="filtrarFrutiferas()">
        
        <div style="margin-top: 1rem;" id="frutiferasList"></div>
      </div>
    </div>

    <!-- Tab: Hist√≥rico -->
    <div id="historico" class="tab-content">
      <div class="section">
        <div class="section-title">üìú Hist√≥rico de A√ß√µes</div>
        <div class="filter-group">
          <button class="filter-btn active" onclick="filterHistorico(event, '7')">√öltimos 7 dias</button>
          <button class="filter-btn" onclick="filterHistorico(event, '30')">√öltimos 30 dias</button>
          <button class="filter-btn" onclick="filterHistorico(event, 'todos')">Tudo</button>
        </div>
        <div id="historicoList">
          <div class="loading">Carregando hist√≥rico</div>
        </div>
      </div>
    </div>

    <!-- Tab: Stats -->
    <div id="stats" class="tab-content">
      <div class="section">
        <div class="section-title">üìä Estat√≠sticas Gerais</div>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-value" id="statTotal">0</div>
            <div class="stat-label">Total Frut√≠feras</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statPend">0</div>
            <div class="stat-label">Pend√™ncias</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statUrg">0</div>
            <div class="stat-label">Urgentes</div>
          </div>
          <div class="stat-card">
            <div class="stat-value" id="statEsp">0</div>
            <div class="stat-label">Esp√©cies</div>
          </div>
        </div>

        <div class="section" style="margin-top: 1rem;">
          <div class="section-title">üå≥ Resumo por Esp√©cie</div>
          <div id="speciesSummary"></div>
        </div>
      </div>
    </div>

    <!-- Tab: Config -->
    <div id="config" class="tab-content">
      <div class="section">
        <div class="section-title">üìã Intervalos por Esp√©cie (dias)</div>
        <p style="color: #666; font-size: 0.9rem; margin-bottom: 1.5rem;">
          Ajuste os intervalos de manuten√ß√£o para cada tipo de frut√≠fera
        </p>
        
        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <h3 style="margin: 0 0 1rem 0; font-size: 1rem;">ü•≠ Mangabeira</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">üíß Rega</label>
              <input type="number" id="mang_rega" value="7" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">‚úÇÔ∏è Poda</label>
              <input type="number" id="mang_poda" value="180" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">üçä Colheita</label>
              <input type="number" id="mang_colh" value="90" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
        </div>

        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <h3 style="margin: 0 0 1rem 0; font-size: 1rem;">üå∞ Cajueiro</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">üíß Rega</label>
              <input type="number" id="caju_rega" value="10" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">‚úÇÔ∏è Poda</label>
              <input type="number" id="caju_poda" value="365" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">üçä Colheita</label>
              <input type="number" id="caju_colh" value="60" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
        </div>

        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <h3 style="margin: 0 0 1rem 0; font-size: 1rem;">ü•• Coqueiro</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">üíß Rega</label>
              <input type="number" id="coq_rega" value="5" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">‚úÇÔ∏è Poda</label>
              <input type="number" id="coq_poda" value="730" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">üçä Colheita</label>
              <input type="number" id="coq_colh" value="30" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
        </div>

        <div style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <h3 style="margin: 0 0 1rem 0; font-size: 1rem;">üç´ Cacau</h3>
          <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">üíß Rega</label>
              <input type="number" id="cac_rega" value="3" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">‚úÇÔ∏è Poda</label>
              <input type="number" id="cac_poda" value="180" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div>
              <label style="font-size: 0.75rem; display: block; margin-bottom: 0.25rem;">üçä Colheita</label>
              <input type="number" id="cac_colh" value="120" style="width: 100%; padding: 0.5rem; border: 1px solid #ddd; border-radius: 4px;">
            </div>
          </div>
        </div>

        <button class="btn btn-primary" onclick="saveConfig()">üíæ Salvar Intervalos</button>
      </div>
    </div>

    <div class="toast" id="toast"></div>
    <div class="footer-space"></div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
  <script>

    // ============================================
// SISTEMA DE SINCRONIZA√á√ÉO OTIMIZADO
// ============================================

class SyncManager {
  constructor() {
    this.syncQueue = [];
    this.isSyncing = false;
    this.lastSync = null;
    this.syncInterval = 5 * 60 * 1000; // 5 minutos
    this.batchSize = 10; // Agrupar at√© 10 a√ß√µes
  }

  // Adicionar a√ß√£o √† fila
  addToQueue(action) {
    this.syncQueue.push({
      ...action,
      timestamp: Date.now()
    });
    
    // Salvar fila no localStorage
    localStorage.setItem('syncQueue', JSON.stringify(this.syncQueue));
    
    // Se atingiu batch size, sincronizar
    if (this.syncQueue.length >= this.batchSize) {
      this.syncNow();
    } else {
      // Agendar sync para daqui 30 segundos
      this.scheduleBatchSync();
    }
  }

  // Sincroniza√ß√£o em lote
  async syncBatch() {
    if (this.isSyncing || this.syncQueue.length === 0) return;
    
    this.isSyncing = true;
    const batch = [...this.syncQueue];
    
    try {
      // Agrupar a√ß√µes por frut√≠fera
      const grouped = this.groupByFrutifera(batch);
      
      // Enviar em lote para Supabase
      const promises = Object.entries(grouped).map(([frutiferaId, actions]) => 
        this.updateFrutifera(frutiferaId, actions)
      );
      
      await Promise.all(promises);
      
      // Limpar fila de sucesso
      this.syncQueue = [];
      localStorage.setItem('syncQueue', '[]');
      this.lastSync = Date.now();
      
      // Disparar Edge Function apenas UMA vez
      await this.triggerEdgeFunction();
      
      return { success: true, synced: batch.length };
      
    } catch (error) {
      console.error('Erro no batch sync:', error);
      return { success: false, error };
    } finally {
      this.isSyncing = false;
    }
  }

  // Agrupar a√ß√µes por frut√≠fera
  groupByFrutifera(actions) {
    return actions.reduce((acc, action) => {
      if (!acc[action.frutiferaId]) {
        acc[action.frutiferaId] = {};
      }
      
      // Pegar apenas a a√ß√£o mais recente de cada tipo
      if (!acc[action.frutiferaId][action.tipo] || 
          action.timestamp > acc[action.frutiferaId][action.tipo].timestamp) {
        acc[action.frutiferaId][action.tipo] = action;
      }
      
      return acc;
    }, {});
  }

  // Atualizar frut√≠fera no Supabase
  async updateFrutifera(frutiferaId, actions) {
    const updates = {};
    
    Object.entries(actions).forEach(([tipo, action]) => {
      if (tipo === 'rega') updates.data_irrigacao_ordinaria = action.data;
      if (tipo === 'poda') updates.data_poda_formacao_1 = action.data;
      if (tipo === 'colheita') updates.inicio_colheita = action.data;
    });
    
    const response = await fetch(
      `${SUPABASE_URL}/rest/v1/frutiferas?id=eq.${frutiferaId}`,
      {
        method: 'PATCH',
        headers: {
          'apikey': SUPABASE_ANON_KEY,
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(updates)
      }
    );
    
    if (!response.ok) throw new Error(`Erro ao atualizar ${frutiferaId}`);
    return response.json();
  }

  // Disparar Edge Function apenas uma vez por batch
  async triggerEdgeFunction() {
    try {
      const response = await fetch(
        'https://erbefbnjxgpetbetlzya.supabase.co/functions/v1/update-geojson',
        {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ 
            trigger: 'batch_sync',
            timestamp: Date.now()
          })
        }
      );
      
      if (response.ok) {
        console.log('‚úÖ Edge Function disparada com sucesso');
        return await response.json();
      }
    } catch (error) {
      console.error('‚ö†Ô∏è Erro ao disparar Edge Function:', error);
    }
  }

  // Agendar sincroniza√ß√£o em lote
  scheduleBatchSync() {
    if (this.syncTimer) clearTimeout(this.syncTimer);
    
    this.syncTimer = setTimeout(() => {
      if (this.syncQueue.length > 0 && navigator.onLine) {
        this.syncBatch();
      }
    }, 30000); // 30 segundos
  }

  // Sincronizar imediatamente
  async syncNow() {
    if (this.syncTimer) clearTimeout(this.syncTimer);
    return await this.syncBatch();
  }

  // Sincroniza√ß√£o inteligente baseada em prioridade
  async smartSync() {
    const now = Date.now();
    const timeSinceLastSync = now - (this.lastSync || 0);
    
    // Se passou muito tempo ou tem muitas a√ß√µes, sincronizar
    if (timeSinceLastSync > this.syncInterval || this.syncQueue.length >= this.batchSize) {
      return await this.syncNow();
    }
    
    // Caso contr√°rio, agendar
    this.scheduleBatchSync();
  }

  // Carregar fila do localStorage na inicializa√ß√£o
  loadQueue() {
    const stored = localStorage.getItem('syncQueue');
    if (stored) {
      this.syncQueue = JSON.parse(stored);
      console.log(`üì¶ ${this.syncQueue.length} a√ß√µes na fila`);
    }
  }
}

// ============================================
// SISTEMA DE CACHE INTELIGENTE
// ============================================

class CacheStrategy {
  constructor() {
    this.CACHE_NAME = 'sitio-ipiranga-v9';
    this.strategies = {
      'orthomosaic': 'cache-first-long',  // Cache por 7 dias
      'supabase': 'network-first-short',   // Rede primeiro, cache 1h
      'static': 'cache-first-medium'       // Cache por 1 dia
    };
  }

  // Estrat√©gia para ortomosaico
  async cacheFirstLong(request) {
    const cache = await caches.open(this.CACHE_NAME);
    const cached = await cache.match(request);
    
    if (cached) {
      const cacheTime = this.getCacheTime(cached);
      const age = Date.now() - cacheTime;
      
      // Cache v√°lido por 7 dias
      if (age < 7 * 24 * 60 * 60 * 1000) {
        console.log('üéØ Cache hit (long):', request.url);
        return cached;
      }
    }
    
    // Buscar da rede com timeout longo
    try {
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 30000); // 30s
      
      const response = await fetch(request, { signal: controller.signal });
      clearTimeout(timeout);
      
      if (response.ok) {
        const cloned = response.clone();
        await cache.put(request, this.addCacheTime(cloned));
        return response;
      }
    } catch (error) {
      console.warn('Usando cache antigo:', error);
    }
    
    // Fallback para cache antigo
    return cached || this.createOfflinePlaceholder(request);
  }

  // Adicionar timestamp ao cache
  addCacheTime(response) {
    const headers = new Headers(response.headers);
    headers.set('X-Cache-Time', Date.now().toString());
    return new Response(response.body, {
      status: response.status,
      statusText: response.statusText,
      headers
    });
  }

  // Obter tempo do cache
  getCacheTime(response) {
    const time = response.headers.get('X-Cache-Time');
    return time ? parseInt(time) : 0;
  }

  // Placeholder offline
  createOfflinePlaceholder(request) {
    if (request.url.includes('orthomosaic')) {
      return new Response(
        `<svg xmlns="http://www.w3.org/2000/svg" width="800" height="600">
          <rect fill="#f0fdf4" width="800" height="600"/>
          <text x="400" y="280" text-anchor="middle" font-size="32" fill="#10b981">
            üåø Mapa Offline
          </text>
          <text x="400" y="320" text-anchor="middle" font-size="16" fill="#6b7280">
            Conecte-se para carregar o ortomosaico
          </text>
        </svg>`,
        { headers: { 'Content-Type': 'image/svg+xml' } }
      );
    }
    
    return new Response('Offline', { status: 503 });
  }
}

// ============================================
// INICIALIZA√á√ÉO OTIMIZADA
// ============================================

const syncManager = new SyncManager();
const cacheStrategy = new CacheStrategy();

// Carregar fila ao iniciar
syncManager.loadQueue();

// Registrar a√ß√£o otimizada
function registrarAcaoOtimizada(tipo, frutiferaId) {
  // Adicionar √† fila
  syncManager.addToQueue({
    tipo,
    frutiferaId,
    data: new Date().toISOString()
  });
  
  // Atualizar UI local imediatamente
  const index = frutiferas.findIndex(f => 
    f.id === frutiferaId || f.fid === frutiferaId
  );
  
  if (index >= 0) {
    if (tipo === 'rega') frutiferas[index].ultima_rega = new Date().toISOString();
    if (tipo === 'poda') frutiferas[index].ultima_poda = new Date().toISOString();
    if (tipo === 'colheita') frutiferas[index].ultima_colheita = new Date().toISOString();
    
    localStorage.setItem('frutiferas', JSON.stringify(frutiferas));
  }
  
  // Feedback imediato
  mostrarToast(`‚úÖ ${tipo} registrada! Sincronizando em lote...`);
  
  // Atualizar contador
  atualizarContadorSync();
}

// Sincroniza√ß√£o peri√≥dica inteligente
setInterval(() => {
  if (navigator.onLine && syncManager.syncQueue.length > 0) {
    syncManager.smartSync();
  }
}, 2 * 60 * 1000); // A cada 2 minutos

// Sincronizar ao voltar online
window.addEventListener('online', () => {
  setTimeout(() => syncManager.syncNow(), 2000);
});

// Sincronizar antes de fechar (se poss√≠vel)
window.addEventListener('beforeunload', () => {
  if (syncManager.syncQueue.length > 0) {
    syncManager.syncNow();
  }
});

// ============================================
// EXPORTAR PARA USO GLOBAL
// ============================================

window.syncManager = syncManager;
window.cacheStrategy = cacheStrategy;

console.log('‚úÖ Sistema de sincroniza√ß√£o otimizado carregado');
 
  const SUPABASE_URL = 'https://erbefbnjxgpetbetlzya.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyYmVmYm5qeGdwZXRiZXRsenlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMzI4ODcsImV4cCI6MjA3NjYwODg4N30.d09pjgddZpNY3Z4cVZ3V4h77aAf_GVGF0sOBTZkZf2A';

  let frutiferas = [];
  let historico = [];
  let perfilAtual = localStorage.getItem('perfilAtual') || 'Default';
  let currentFilter = 'todas';
  let pendingSync = [];
  
  // Vari√°veis do mapa
  let map;
  let baseLayers = {};
  let orthomosaicLayer;
  let frutiferasLayer;
  let markers = {};
  let speciesColors = {
    'Mangabeira': '#10b981',
    'Cajueiro': '#f59e0b',
    'Coqueiro': '#ef4444',
    'Cacau': '#8b5cf6'
  };

  // ‚≠ê‚≠ê DEBOUNCE PARA EVITAR CHAMADAS DUPLICADAS ‚≠ê‚≠ê
  let debounceTimer;
  function debounce(func, wait) {
    return function executedFunction(...args) {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(() => func.apply(this, args), wait);
    };
  }

  async function carregarFrutiferas() {
    console.log('üî• Carregando frut√≠feras do Supabase...');
    
    try {
      if (navigator.onLine) {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/frutiferas?select=*&nome_popular=in.(Mangabeira,Cajueiro,Coqueiro,Cacau)`,
          {
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            }
          }
        );
        
        if (response.ok) {
          const dados = await response.json();
          
          frutiferas = dados.map(f => ({
            id: f.id,
            fid: f.fid,
            especie: f.nome_popular,
            nome_popular: f.nome_popular,
            identificacao: f.fid,
            data_plantio: f.data_plantio || null,
            ultima_rega: f.data_irrigacao_ordinaria || null,
            ultima_poda: f.data_poda_formacao_1 || null,
            ultima_colheita: f.inicio_colheita || null,
            latitude: f.latitude || null,
            longitude: f.longitude || null,
            altura_total: f.altura_total || null,
            diametro_copa: f.diametro_copa || null,
            created_at: f.created_at || new Date().toISOString()
          }));
          
          localStorage.setItem('frutiferas', JSON.stringify(frutiferas));
          console.log(`‚úÖ ${frutiferas.length} frut√≠feras carregadas do Supabase`);
          atualizarTodasAbas();
          
          if (document.getElementById('mapa').classList.contains('active')) {
            atualizarMapa();
          }
        } else {
          console.error('Erro na resposta do Supabase:', response.status);
          carregarDoCache();
        }
      } else {
        console.log('üì° Modo offline - carregando do cache');
        carregarDoCache();
      }
      
    } catch (error) {
      console.error('‚ùå Erro ao carregar frut√≠feras:', error);
      mostrarToast('‚ö†Ô∏è Erro ao carregar. Usando dados locais.');
      carregarDoCache();
    }
  }

  function carregarDoCache() {
    const frutiferasLocal = JSON.parse(localStorage.getItem('frutiferas') || '[]');
    if (frutiferasLocal.length > 0) {
      frutiferas = frutiferasLocal;
      console.log(`üì¶ ${frutiferas.length} frut√≠feras do cache local`);
      atualizarTodasAbas();
    }
  }

  function atualizarTodasAbas() {
    console.log('üîÑ Atualizando UI com', frutiferas.length, 'frut√≠feras');
    
    document.getElementById('frutiferaCount').textContent = `üìä ${frutiferas.length} frut√≠feras`;
    
    atualizarListaFrutiferas();
    atualizarStats();
    carregarAcoesHojeDebounced();
  }

  function atualizarListaFrutiferas() {
    const lista = document.getElementById('frutiferasList');
    if (!lista) return;
    
    if (frutiferas.length === 0) {
      lista.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üå±</div>
          <p>Nenhuma frut√≠fera cadastrada ainda.</p>
          <p><small>V√° para a aba "Mapa" para adicionar sua primeira frut√≠fera!</small></p>
        </div>
      `;
      return;
    }
    
    lista.innerHTML = frutiferas.map(f => `
      <div class="frutifera-card" onclick="mostrarDetalhesFrutifera('${f.id || f.fid}')">
        <div class="frutifera-header">
          <div class="frutifera-name">${f.nome_popular || f.especie}</div>
          <span class="badge">${f.identificacao || f.id || f.fid}</span>
        </div>
        <div class="frutifera-info">
          <div>üìÖ Plantio: ${formatarData(f.data_plantio) || 'Sem data'}</div>
          <div>üíß √öltima rega: ${formatarData(f.ultima_rega) || 'Nunca'}</div>
          <div>‚úÇÔ∏è √öltima poda: ${formatarData(f.ultima_poda) || 'Nunca'}</div>
          ${f.latitude && f.longitude ? `<div>üìç GPS: ${f.latitude.toFixed(6)}, ${f.longitude.toFixed(6)}</div>` : ''}
        </div>
      </div>
    `).join('');
  }

  function mostrarDetalhesFrutifera(id) {
    const frutifera = frutiferas.find(f => f.id === id || f.fid === id);
    if (!frutifera) return;
    
    const modalHTML = `
      <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; display: flex; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 12px; padding: 1.5rem; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
            <h3 style="margin: 0; color: #10b981;">${frutifera.nome_popular || frutifera.especie}</h3>
            <button onclick="this.parentElement.parentElement.parentElement.remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #6b7280;">√ó</button>
          </div>
          
          <div style="margin-bottom: 1rem;">
            <div style="display: grid; gap: 0.75rem;">
              <div>
                <strong style="color: #6b7280; font-size: 0.85rem;">C√≥digo:</strong>
                <div style="margin-top: 0.25rem;">${frutifera.identificacao || frutifera.id || frutifera.fid}</div>
              </div>
              
              ${frutifera.data_plantio ? `
              <div>
                <strong style="color: #6b7280; font-size: 0.85rem;">Data do Plantio:</strong>
                <div style="margin-top: 0.25rem;">${formatarData(frutifera.data_plantio)}</div>
              </div>` : ''}
              
              ${frutifera.ultima_rega ? `
              <div>
                <strong style="color: #6b7280; font-size: 0.85rem;">√öltima Rega:</strong>
                <div style="margin-top: 0.25rem;">${formatarData(frutifera.ultima_rega)} (${calcularDias(frutifera.ultima_rega)} dias atr√°s)</div>
              </div>` : ''}
              
              ${frutifera.ultima_poda ? `
              <div>
                <strong style="color: #6b7280; font-size: 0.85rem;">√öltima Poda:</strong>
                <div style="margin-top: 0.25rem;">${formatarData(frutifera.ultima_poda)} (${calcularDias(frutifera.ultima_poda)} dias atr√°s)</div>
              </div>` : ''}
              
              ${frutifera.latitude && frutifera.longitude ? `
              <div>
                <strong style="color: #6b7280; font-size: 0.85rem;">Localiza√ß√£o:</strong>
                <div style="margin-top: 0.25rem;">${frutifera.latitude.toFixed(6)}, ${frutifera.longitude.toFixed(6)}</div>
              </div>` : ''}
            </div>
          </div>
          
          <button onclick="this.parentElement.parentElement.remove()" style="width: 100%; padding: 0.75rem; background: #10b981; color: white; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">
            Fechar
          </button>
        </div>
      </div>
    `;
    
    const modal = document.createElement('div');
    modal.innerHTML = modalHTML;
    document.body.appendChild(modal.firstElementChild);
  }

  // ‚≠ê‚≠ê VERS√ÉO COM DEBOUNCE PARA EVITAR CHAMADAS DUPLICADAS ‚≠ê‚≠ê
  function carregarAcoesHojeDebounced() {
    clearTimeout(debounceTimer);
    debounceTimer = setTimeout(() => {
      console.log('‚úÖ [√öNICA] Chamando carregarAcoesHoje()');
      carregarAcoesHoje();
    }, 300);
  }

  function carregarAcoesHoje() {
    console.log('üìã carregarAcoesHoje() executando...');
    const container = document.getElementById('acoesHoje');
    if (!container) return;
    
    if (frutiferas.length === 0) {
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üìã</div>
          <p>Nenhuma frut√≠fera cadastrada.</p>
          <p><small>Cadastre frut√≠feras para ver as a√ß√µes pendentes</small></p>
        </div>
      `;
      return;
    }
    
    // Agrupar a√ß√µes por esp√©cie
    const acoesPorEspecie = {
      'Mangabeira': { rega: [], poda: [], colheita: [], icone: 'ü•≠' },
      'Cajueiro': { rega: [], poda: [], colheita: [], icone: 'üå∞' },
      'Coqueiro': { rega: [], poda: [], colheita: [], icone: 'ü••' },
      'Cacau': { rega: [], poda: [], colheita: [], icone: 'üç´' }
    };
    
    // Organizar a√ß√µes por esp√©cie
    frutiferas.forEach(f => {
      const especie = f.especie || f.nome_popular || 'Desconhecida';
      if (!acoesPorEspecie[especie]) return;
      
      const diasRega = f.ultima_rega ? calcularDias(f.ultima_rega) : 999;
      const intervaloRega = obterIntervaloRega(f);
      
      if (diasRega >= intervaloRega) {
        acoesPorEspecie[especie].rega.push({
          tipo: 'rega',
          urgencia: diasRega >= (intervaloRega + 2) ? 'urgent' : 'warning',
          frutifera: f,
          dias: diasRega,
          titulo: `Regar ${f.nome_popular || f.especie}`,
          descricao: `√öltima rega: ${diasRega === 999 ? 'Nunca' : diasRega + ' dias atr√°s'}`
        });
      }
      
      const diasPoda = f.ultima_poda ? calcularDias(f.ultima_poda) : 999;
      const intervaloPoda = obterIntervaloPoda(f);
      
      if (diasPoda >= intervaloPoda) {
        acoesPorEspecie[especie].poda.push({
          tipo: 'poda',
          urgencia: 'warning',
          frutifera: f,
          dias: diasPoda,
          titulo: `Podar ${f.nome_popular || f.especie}`,
          descricao: `√öltima poda: ${diasPoda === 999 ? 'Nunca' : diasPoda + ' dias atr√°s'}`
        });
      }
      
      const diasColheita = f.ultima_colheita ? calcularDias(f.ultima_colheita) : 999;
      const intervaloColheita = obterIntervaloColheita(f);
      
      if (diasColheita >= intervaloColheita) {
        acoesPorEspecie[especie].colheita.push({
          tipo: 'colheita',
          urgencia: 'normal',
          frutifera: f,
          dias: diasColheita,
          titulo: `Colher ${f.nome_popular || f.especie}`,
          descricao: `√öltima colheita: ${diasColheita === 999 ? 'Nunca' : diasColheita + ' dias atr√°s'}`
        });
      }
    });
    
    // Contar total de a√ß√µes
    let totalAcoes = 0;
    Object.values(acoesPorEspecie).forEach(especie => {
      totalAcoes += especie.rega.length + especie.poda.length + especie.colheita.length;
    });
    
    if (totalAcoes === 0) {
      container.innerHTML = `
        <div class="info-box success-box">
          ‚úÖ <strong>Tudo em dia!</strong><br>
          Nenhuma a√ß√£o pendente no momento.
        </div>
      `;
      document.getElementById('actionCount').textContent = 'üìã 0 a√ß√µes';
      return;
    }
    
    document.getElementById('actionCount').textContent = `üìã ${totalAcoes} a√ß√µes`;
    
    // Gerar HTML com se√ß√µes por esp√©cie (acorde√£o)
    let html = '';
    
    Object.entries(acoesPorEspecie).forEach(([especie, dados]) => {
      const totalEspecie = dados.rega.length + dados.poda.length + dados.colheita.length;
      
      if (totalEspecie === 0) return;
      
      // Filtrar a√ß√µes de acordo com o filtro atual
      let acoesFiltradas = [];
      if (currentFilter === 'todas') {
        acoesFiltradas = [...dados.rega, ...dados.poda, ...dados.colheita];
      } else if (currentFilter === 'urgente') {
        acoesFiltradas = [...dados.rega.filter(a => a.urgencia === 'urgent'), 
                         ...dados.poda.filter(a => a.urgencia === 'urgent'),
                         ...dados.colheita.filter(a => a.urgencia === 'urgent')];
      } else if (currentFilter === 'rega') {
        acoesFiltradas = dados.rega;
      } else if (currentFilter === 'poda') {
        acoesFiltradas = dados.poda;
      } else if (currentFilter === 'colheita') {
        acoesFiltradas = dados.colheita;
      }
      
      if (acoesFiltradas.length === 0) return;
      
      // Gerar se√ß√£o da esp√©cie (acorde√£o)
      const especieId = especie.toLowerCase().replace(/\s+/g, '-');
      html += `
        <div class="especie-section" style="margin-bottom: 1.5rem;">
          <div class="especie-header" onclick="toggleEspecieSection('${especieId}')" 
               style="background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%); 
                      border: 1px solid #e5e7eb; 
                      border-radius: 10px; 
                      padding: 1rem; 
                      cursor: pointer;
                      display: flex;
                      align-items: center;
                      justify-content: space-between;
                      transition: all 0.3s;
                      margin-bottom: 0.5rem;">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              <span style="font-size: 1.5rem;">${dados.icone}</span>
              <div>
                <div style="font-weight: 700; color: #1f2937; font-size: 1.1rem;">${especie}</div>
                <div style="font-size: 0.85rem; color: #6b7280; margin-top: 0.25rem;">
                  ${acoesFiltradas.length} a√ß√£o(√µes) pendente(s)
                </div>
              </div>
            </div>
            <span id="toggle-${especieId}" style="font-size: 1.2rem; color: #10b981; transition: transform 0.3s;">‚ñº</span>
          </div>
          
          <div id="content-${especieId}" class="especie-content" 
               style="max-height: 2000px; overflow: hidden; transition: max-height 0.5s ease-in-out;">
            ${acoesFiltradas.map(acao => {
              const frutiferaId = acao.frutifera.id || acao.frutifera.fid || acao.frutifera.identificacao;
              const actionId = `action-${frutiferaId}-${acao.tipo}`;
              const isDone = localStorage.getItem(actionId) === 'true';
              
              return `
              <div class="action-item ${acao.urgencia} ${isDone ? 'completed' : ''}" 
                   style="position: relative; 
                          border-left: 4px solid ${isDone ? '#10b981' : (acao.urgencia === 'urgent' ? '#ef4444' : acao.urgencia === 'warning' ? '#f59e0b' : '#10b981')}; 
                          background: ${isDone ? '#f0fdf4' : (acao.urgencia === 'urgent' ? '#fef2f2' : acao.urgencia === 'warning' ? '#fffbeb' : '#f0fdf4')}; 
                          border-radius: 8px; 
                          padding: 1rem; 
                          margin-bottom: 0.75rem;
                          transition: all 0.3s;
                          transform: ${isDone ? 'translateY(-2px)' : 'none'};
                          box-shadow: ${isDone ? '0 4px 12px rgba(16, 185, 129, 0.2)' : '0 1px 3px rgba(0,0,0,0.1)'}">
                
                ${isDone ? `
                  <div style="position: absolute; top: -8px; right: -8px; background: #10b981; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.7rem; font-weight: bold; z-index: 1;">
                    ‚úÖ Feito
                  </div>
                ` : ''}
                
                <div class="action-title">
                  ${acao.urgencia === 'urgent' ? 'üö®' : acao.tipo === 'rega' ? 'üíß' : acao.tipo === 'poda' ? '‚úÇÔ∏è' : 'üçä'}
                  ${acao.titulo}
                </div>
                <div class="action-desc">${acao.descricao}</div>
                <div class="action-meta">
                  C√≥digo: ${acao.frutifera.identificacao || acao.frutifera.id}
                  ${acao.frutifera.latitude && acao.frutifera.longitude ? 
                    `‚Ä¢ üìç ${acao.frutifera.latitude.toFixed(4)}, ${acao.frutifera.longitude.toFixed(4)}` : ''}
                </div>
                
                <button class="action-button ${isDone ? 'btn-undo' : 'btn-do'}" 
                        onclick="toggleAction('${acao.tipo}', '${frutiferaId}', '${actionId}', event)"
                        style="width: 100%; 
                               padding: 0.75rem; 
                               border: none; 
                               border-radius: 8px; 
                               font-weight: 600; 
                               cursor: pointer; 
                               margin-top: 0.75rem;
                               transition: all 0.3s;
                               ${isDone ? 
                                 'background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white;' : 
                                 'background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;'}
                               transform: ${isDone ? 'scale(0.98)' : 'none'};
                               box-shadow: ${isDone ? '0 2px 4px rgba(239, 68, 68, 0.3)' : '0 2px 4px rgba(16, 185, 129, 0.3)'}">
                  <span style="font-size: 1.1rem; margin-right: 0.5rem;">
                    ${isDone ? '‚Ü∂' : '‚úÖ'}
                  </span>
                  ${isDone ? 'Desmarcar' : 'Marcar como feito'}
                </button>
              </div>
            `;
            }).join('')}
          </div>
        </div>
      `;
    });
    
    if (html === '') {
      html = `
        <div class="info-box">
          ‚ÑπÔ∏è <strong>Nenhuma a√ß√£o encontrada</strong><br>
          Com o filtro atual, n√£o h√° a√ß√µes para exibir.
        </div>
      `;
    }
    
    container.innerHTML = html;
    
    // Inicializar todas as se√ß√µes abertas
    Object.keys(acoesPorEspecie).forEach(especie => {
      const especieId = especie.toLowerCase().replace(/\s+/g, '-');
      const content = document.getElementById(`content-${especieId}`);
      const toggle = document.getElementById(`toggle-${especieId}`);
      if (content && toggle) {
        content.style.maxHeight = '2000px';
        toggle.style.transform = 'rotate(180deg)';
      }
    });
  }

  function toggleEspecieSection(especieId) {
    const content = document.getElementById(`content-${especieId}`);
    const toggle = document.getElementById(`toggle-${especieId}`);
    
    if (content.style.maxHeight === '0px' || content.style.maxHeight === '') {
      content.style.maxHeight = '2000px';
      toggle.style.transform = 'rotate(180deg)';
    } else {
      content.style.maxHeight = '0px';
      toggle.style.transform = 'rotate(0deg)';
    }
  }

  function toggleAction(tipo, frutiferaId, actionId, event) {
  event.stopPropagation();
  
  const button = event.target;
  const actionItem = button.closest('.action-item');
  const isDone = localStorage.getItem(actionId) === 'true';
  
  if (!isDone) {
    // Marcar como feito
    localStorage.setItem(actionId, 'true');
    actionItem.classList.add('completed');
    
    // Mudar apar√™ncia do bot√£o
    button.innerHTML = '<span style="font-size: 1.1rem; margin-right: 0.5rem;">‚Ü∂</span> Desmarcar';
    button.className = 'action-button btn-undo';
    button.style.background = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
    button.style.boxShadow = '0 2px 4px rgba(239, 68, 68, 0.3)';
    
    // Registrar a a√ß√£o para sincroniza√ß√£o
    setTimeout(() => registrarAcao(tipo, frutiferaId), 300);
    
    // Mensagem imediata
    const statusDot = document.getElementById('statusDot');
    if (navigator.onLine && statusDot && !statusDot.classList.contains('offline')) {
      mostrarToast('‚úÖ A√ß√£o registrada! Sincronizando...');
    } else {
      mostrarToast('‚úÖ A√ß√£o registrada! Sincronizar√° quando online.');
    }
    
  } else {
    // Desmarcar
    localStorage.removeItem(actionId);
    actionItem.classList.remove('completed');
    
    // Restaurar bot√£o original
    button.innerHTML = '<span style="font-size: 1.1rem; margin-right: 0.5rem;">‚úÖ</span> Marcar como feito';
    button.className = 'action-button btn-do';
    button.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
    button.style.boxShadow = '0 2px 4px rgba(16, 185, 129, 0.3)';
    
    mostrarToast('‚Ü∂ A√ß√£o desmarcada');
  }
  
  // Efeito visual
  button.style.transform = 'scale(0.95)';
  setTimeout(() => {
    button.style.transform = 'scale(1)';
  }, 150);
}

  function registrarAcao(tipo, frutiferaId) {
  const acoesPendentes = JSON.parse(localStorage.getItem('acoesPendentes') || '[]');
  
  acoesPendentes.push({
    tipo: tipo,
    frutiferaId: frutiferaId,
    data: new Date().toISOString(),
    timestamp: Date.now()
  });
  
  localStorage.setItem('acoesPendentes', JSON.stringify(acoesPendentes));
  
  // Atualizar localmente na lista de frut√≠feras
  const index = frutiferas.findIndex(f => 
    f.id === frutiferaId || f.fid === frutiferaId || f.identificacao === frutiferaId
  );
  
  if (index >= 0) {
    if (tipo === 'rega') {
      frutiferas[index].ultima_rega = new Date().toISOString();
    } else if (tipo === 'poda') {
      frutiferas[index].ultima_poda = new Date().toISOString();
    } else if (tipo === 'colheita') {
      frutiferas[index].ultima_colheita = new Date().toISOString();
    }
    
    localStorage.setItem('frutiferas', JSON.stringify(frutiferas));
  }
  
  atualizarContadorSync();
  
  // VERIFICAR SE EST√Å ONLINE ANTES DE MOSTRAR MENSAGEM
  if (navigator.onLine) {
    mostrarToast('‚úÖ A√ß√£o registrada! Sincronizando...');
    // Tentar sincronizar imediatamente se estiver online
    setTimeout(() => {
      sincronizarFilaAcoes();
    }, 500);
  } else {
    mostrarToast('‚úÖ A√ß√£o registrada! Sincronizar√° quando online.');
  }
  
  // Recarregar a√ß√µes para atualizar a interface
  carregarAcoesHojeDebounced();
}

  function atualizarStats() {
    const totalFrutiferas = frutiferas.length;
    
    // Calcular estat√≠sticas
    let totalPendencias = 0;
    let totalUrgentes = 0;
    const especiesUnicas = new Set();
    
    frutiferas.forEach(f => {
      // Contar esp√©cies √∫nicas
      especiesUnicas.add(f.especie || f.nome_popular);
      
      // Calcular pendencias para esta frut√≠fera
      const diasRega = f.ultima_rega ? calcularDias(f.ultima_rega) : 999;
      const intervaloRega = obterIntervaloRega(f);
      
      if (diasRega >= intervaloRega) {
        totalPendencias++;
        if (diasRega >= (intervaloRega + 2)) {
          totalUrgentes++;
        }
      }
      
      const diasPoda = f.ultima_poda ? calcularDias(f.ultima_poda) : 999;
      const intervaloPoda = obterIntervaloPoda(f);
      
      if (diasPoda >= intervaloPoda) {
        totalPendencias++;
        if (diasPoda >= (intervaloPoda + 30)) { // Poda mais tolerante
          totalUrgentes++;
        }
      }
    });
    
    // Atualizar os elementos HTML
    if (document.getElementById('statTotal')) {
      document.getElementById('statTotal').textContent = totalFrutiferas;
    }
    
    if (document.getElementById('statPend')) {
      document.getElementById('statPend').textContent = totalPendencias;
    }
    
    if (document.getElementById('statUrg')) {
      document.getElementById('statUrg').textContent = totalUrgentes;
    }
    
    if (document.getElementById('statEsp')) {
      document.getElementById('statEsp').textContent = especiesUnicas.size;
    }
    
    // Atualizar resumo por esp√©cie
    const speciesSummary = document.getElementById('speciesSummary');
    if (speciesSummary) {
      // Contar por esp√©cie
      const especiesContagem = {};
      frutiferas.forEach(f => {
        const especie = f.especie || f.nome_popular || 'Desconhecida';
        especiesContagem[especie] = (especiesContagem[especie] || 0) + 1;
      });
      
      // Gerar HTML do resumo
      if (Object.keys(especiesContagem).length === 0) {
        speciesSummary.innerHTML = '<div class="empty-state">Nenhuma esp√©cie cadastrada</div>';
      } else {
        let html = '';
        Object.entries(especiesContagem).forEach(([especie, quantidade]) => {
          const percentual = ((quantidade / totalFrutiferas) * 100).toFixed(1);
          html += `
            <div style="margin-bottom: 0.75rem; padding: 0.75rem; background: #f9fafb; border-radius: 8px; border-left: 4px solid #10b981;">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.25rem;">
                <span style="font-weight: 600; font-size: 0.95rem;">${especie}</span>
                <span style="font-weight: 700; color: #059669;">${quantidade}</span>
              </div>
              <div style="display: flex; align-items: center; gap: 0.5rem;">
                <div style="flex: 1; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden;">
                  <div style="height: 100%; background: #10b981; width: ${percentual}%;"></div>
                </div>
                <span style="font-size: 0.8rem; color: #6b7280;">${percentual}%</span>
              </div>
            </div>
          `;
        });
        speciesSummary.innerHTML = html;
      }
    }
  }

  async function cadastrarFrutifera(event) {
    event.preventDefault();
    
    const especie = document.getElementById('novaEspecie').value;
    const dataPlantio = document.getElementById('dataPlantio').value;
    const coordenadas = document.getElementById('coordenadas').value;
    const responsavel = document.getElementById('responsavel').value;
    
    if (!especie) {
      mostrarToast('‚ùå Selecione uma esp√©cie');
      return;
    }
    
    let lat = null, lon = null;
    if (coordenadas) {
      const coords = coordenadas.split(',').map(c => parseFloat(c.trim()));
      lat = coords[0];
      lon = coords[1];
    }
    
    const fidTemp = `${especie.substring(0, 3).toUpperCase()}-${Date.now()}`;
    
    const novaFrutifera = {
      id: null,
      fid: fidTemp,
      especie: especie,
      nome_popular: especie,
      identificacao: fidTemp,
      data_plantio: dataPlantio,
      latitude: lat,
      longitude: lon,
      responsavel: responsavel,
      ultima_rega: null,
      ultima_poda: null,
      ultima_colheita: null,
      created_at: new Date().toISOString(),
      pendingSync: true
    };
    
    try {
      pendingSync.push(novaFrutifera);
      localStorage.setItem('pendingSync', JSON.stringify(pendingSync));
      
      frutiferas.push(novaFrutifera);
      localStorage.setItem('frutiferas', JSON.stringify(frutiferas));
      
      atualizarTodasAbas();
      mostrarToast('‚úÖ Frut√≠fera cadastrada! Clique em "Sincronizar" para enviar ao banco.');
      
      event.target.reset();
      document.getElementById('coordDisplay').style.display = 'none';
      
      if (document.getElementById('mapa').classList.contains('active') && map) {
        atualizarMapa();
        const container = document.getElementById('cadastroFormContainer');
        const icon = document.getElementById('cadastroToggleIcon');
        container.classList.add('collapsed');
        icon.textContent = '‚ñ∂';
      }
      
      atualizarContadorSync();
      
    } catch (error) {
      console.error('‚ùå Erro ao cadastrar frut√≠fera:', error);
      mostrarToast('‚ùå Erro ao cadastrar frut√≠fera');
    }
  }

  async function sincronizarComSupabase() {
    if (!navigator.onLine) {
      mostrarToast('üì° Voc√™ est√° offline. Conecte-se √† internet para sincronizar.');
      return;
    }
    
    const syncMsg = document.getElementById('syncMessage');
    const syncButton = document.querySelector('[onclick="sincronizarComSupabase()"]');
    
    if (syncButton) {
      syncButton.disabled = true;
      syncButton.innerHTML = '<span>‚è≥</span> Sincronizando...';
    }
    
    pendingSync = JSON.parse(localStorage.getItem('pendingSync') || '[]');
    
    if (pendingSync.length === 0) {
      mostrarToast('‚úÖ Nenhuma altera√ß√£o pendente');
      if (syncButton) {
        syncButton.disabled = false;
        syncButton.innerHTML = '<span>üîÑ</span> Sincronizar com Banco de Dados';
      }
      return;
    }
    
    syncMsg.textContent = `üîÑ Sincronizando ${pendingSync.length} item(ns)...`;
    mostrarToast(`üîÑ Sincronizando ${pendingSync.length} frut√≠fera(s)...`);
    
    let sucessos = 0;
    let erros = 0;
    
    for (const frutifera of pendingSync) {
      try {
        const response = await fetch(
          `${SUPABASE_URL}/rest/v1/frutiferas`,
          {
            method: 'POST',
            headers: {
              'apikey': SUPABASE_ANON_KEY,
              'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
              'Content-Type': 'application/json'
            },
            body: JSON.stringify({
              nome_popular: frutifera.especie,
              data_plantio: frutifera.data_plantio,
              latitude: frutifera.latitude,
              longitude: frutifera.longitude,
              data_irrigacao_ordinaria: frutifera.ultima_rega,
              data_poda_formacao_1: frutifera.ultima_poda,
              inicio_colheita: frutifera.ultima_colheita
            })
          }
        );
        
        if (response.ok) {
          const [resultado] = await response.json();
          
          const index = frutiferas.findIndex(f => f.fid === frutifera.fid);
          if (index >= 0) {
            frutiferas[index].id = resultado.id;
            frutiferas[index].fid = resultado.fid;
            frutiferas[index].identificacao = resultado.fid;
            frutiferas[index].pendingSync = false;
          }
          
          sucessos++;
        } else {
          erros++;
        }
        
      } catch (error) {
        erros++;
      }
    }
    
    pendingSync = [];
    localStorage.setItem('pendingSync', '[]');
    localStorage.setItem('frutiferas', JSON.stringify(frutiferas));
    
    await carregarFrutiferas();
    
    if (syncButton) {
      syncButton.disabled = false;
      syncButton.innerHTML = '<span>üîÑ</span> Sincronizar com Banco de Dados';
    }
    
    if (erros === 0) {
      syncMsg.textContent = `‚úÖ ${sucessos} item(ns) sincronizado(s) com sucesso!`;
      syncMsg.style.color = '#059669';
      mostrarToast(`‚úÖ ${sucessos} frut√≠fera(s) sincronizada(s) com sucesso!`);
    } else {
      syncMsg.textContent = `‚ö†Ô∏è ${sucessos} sucesso(s), ${erros} erro(s)`;
      syncMsg.style.color = '#dc2626';
      mostrarToast(`‚ö†Ô∏è ${sucessos} sucesso(s), ${erros} erro(s)`);
    }
    
    setTimeout(() => {
      syncMsg.textContent = '';
      syncMsg.style.color = '';
    }, 5000);
    
    atualizarContadorSync();
  }

  async function sincronizarFilaAcoes() {
  if (!navigator.onLine) {
    console.log('Offline - aguardando conex√£o');
    mostrarToast('üì° Voc√™ est√° offline. A√ß√£o ser√° sincronizada quando conectar.');
    return;
  }
  
  let acoesPendentes = JSON.parse(localStorage.getItem('acoesPendentes') || '[]');
  
  if (acoesPendentes.length === 0) {
    console.log('Nenhuma a√ß√£o pendente para sincronizar');
    return;
  }
  
  console.log(`üîÑ Sincronizando ${acoesPendentes.length} a√ß√£o(√µes)...`);
  
  // Mostrar mensagem espec√≠fica para a√ß√µes
  const toast = document.getElementById('toast');
  toast.innerHTML = `
    <div style="display: flex; align-items: center; gap: 0.5rem;">
      <span>üîÑ</span>
      <div>
        Sincronizando ${acoesPendentes.length} a√ß√£o(√µes)...
        <div style="font-size: 0.8rem; opacity: 0.8;">Por favor, aguarde</div>
      </div>
    </div>
  `;
  toast.className = 'toast show';
  
  const sucessos = [];
  const falhas = [];
  
  for (const acao of acoesPendentes) {
    try {
      const campoSupabase = acao.tipo === 'rega' ? 'data_irrigacao_ordinaria' : 
                            acao.tipo === 'poda' ? 'data_poda_formacao_1' : 
                            'inicio_colheita';
      
      const response = await fetch(
        `${SUPABASE_URL}/rest/v1/frutiferas?id=eq.${acao.frutiferaId}`,
        {
          method: 'PATCH',
          headers: {
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ [campoSupabase]: acao.data })
        }
      );
      
      if (response.ok) {
        sucessos.push(acao);
        console.log(`‚úÖ ${acao.tipo} sincronizada para ID ${acao.frutiferaId}`);
      } else {
        falhas.push(acao);
      }
    } catch (error) {
      falhas.push(acao);
    }
  }
  
  localStorage.setItem('acoesPendentes', JSON.stringify(falhas));
  
  if (sucessos.length > 0) {
    mostrarToast(`‚úÖ ${sucessos.length} a√ß√£o(√µes) sincronizada(s) com sucesso!`);
    
    try {
      const edgeResponse = await fetch('https://erbefbnjxgpetbetlzya.supabase.co/functions/v1/update-geojson', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
          'Content-Type': 'application/json'
        }
      });
      
      if (edgeResponse.ok) {
        const result = await edgeResponse.json();
        console.log('‚úÖ GitHub atualizado via Edge Function:', result);
        
        const syncMsg = document.getElementById('syncMessage');
        if (syncMsg) {
          syncMsg.innerHTML = `‚úÖ GitHub atualizado! <small>Commit: ${result.commit?.substring(0, 8)}</small>`;
          syncMsg.style.color = '#059669';
          
          setTimeout(() => {
            syncMsg.innerHTML = '';
          }, 5000);
        }
        
        mostrarToast('üì± Notifica√ß√£o enviada para Telegram');
      }
    } catch (e) {
      console.log('‚ö†Ô∏è Edge Function:', e.message);
    }
  } else if (falhas.length > 0) {
    mostrarToast(`‚ö†Ô∏è Erro ao sincronizar ${falhas.length} a√ß√£o(√µes)`);
  }
  
  atualizarContadorSync();
  await carregarFrutiferas();
}

  async function sincronizarTudo() {
    if (!navigator.onLine) {
      mostrarToast('üì° Voc√™ est√° offline');
      return;
    }
    
    mostrarToast('üîÑ Sincronizando tudo...');
    
    await sincronizarComSupabase();
    await sincronizarFilaAcoes();
    
    mostrarToast('‚úÖ Sincroniza√ß√£o completa!');
  }

  function atualizarContadorSync() {
    const acoesPendentes = JSON.parse(localStorage.getItem('acoesPendentes') || '[]');
    const pendingSync = JSON.parse(localStorage.getItem('pendingSync') || '[]');
    const total = acoesPendentes.length + pendingSync.length;
    
    const statusEl = document.getElementById('syncStatus');
    if (statusEl) {
      if (total > 0) {
        statusEl.innerHTML = `
          <span style="display: flex; align-items: center; gap: 5px;">
            <span style="background: #ef4444; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.8rem; font-weight: bold;">
              ${total}
            </span>
            <span>pendente(s)</span>
          </span>
        `;
        statusEl.style.color = '#f59e0b';
      } else {
        statusEl.innerHTML = '‚úÖ Sincronizado';
        statusEl.style.color = '#10b981';
      }
    }
  }

  // ‚≠ê‚≠ê FUN√á√ïES DE CONFIGURA√á√ÉO CORRIGIDAS ‚≠ê‚≠ê
  function loadConfig() {
    const defaults = {
      mang_rega: 7, mang_poda: 180, mang_colh: 90,
      caju_rega: 10, caju_poda: 365, caju_colh: 60,
      coq_rega: 5, coq_poda: 730, coq_colh: 30,
      cac_rega: 3, cac_poda: 180, cac_colh: 120
    };
    
    Object.keys(defaults).forEach(key => {
      const input = document.getElementById(key);
      if (input) {
        const valor = localStorage.getItem(key) || defaults[key];
        input.value = valor;
      }
    });
  }

  function saveConfig() {
    const config = {};
    
    ['mang', 'caju', 'coq', 'cac'].forEach(prefixo => {
      ['rega', 'poda', 'colh'].forEach(tipo => {
        const key = `${prefixo}_${tipo}`;
        const input = document.getElementById(key);
        if (input) {
          const valor = input.value;
          localStorage.setItem(key, valor);
          config[key] = valor;
        }
      });
    });
    
    localStorage.setItem('configIntervalos', JSON.stringify({
      ...config,
      timestamp: new Date().toISOString()
    }));
    
    console.log('‚úÖ Configura√ß√µes salvas:', config);
    mostrarToast('‚úÖ Configura√ß√µes salvas!');
    
    carregarAcoesHojeDebounced();
  }

  // ‚≠ê‚≠ê FUN√á√ïES DE INTERVALO OTIMIZADAS ‚≠ê‚≠ê
  function obterIntervaloRega(frutifera) {
    const especie = (frutifera.especie || frutifera.nome_popular || '').toLowerCase();
    const config = JSON.parse(localStorage.getItem('configIntervalos') || '{}');
    
    if (especie.includes('coqueiro')) return parseInt(config.coq_rega || localStorage.getItem('coq_rega') || '5');
    if (especie.includes('cacau')) return parseInt(config.cac_rega || localStorage.getItem('cac_rega') || '3');
    if (especie.includes('mangabeira')) return parseInt(config.mang_rega || localStorage.getItem('mang_rega') || '7');
    if (especie.includes('caju')) return parseInt(config.caju_rega || localStorage.getItem('caju_rega') || '10');
    return 7;
  }

  function obterIntervaloPoda(frutifera) {
    const especie = (frutifera.especie || frutifera.nome_popular || '').toLowerCase();
    const config = JSON.parse(localStorage.getItem('configIntervalos') || '{}');
    
    if (especie.includes('coqueiro')) return parseInt(config.coq_poda || localStorage.getItem('coq_poda') || '730');
    if (especie.includes('cacau')) return parseInt(config.cac_poda || localStorage.getItem('cac_poda') || '180');
    if (especie.includes('mangabeira')) return parseInt(config.mang_poda || localStorage.getItem('mang_poda') || '180');
    if (especie.includes('caju')) return parseInt(config.caju_poda || localStorage.getItem('caju_poda') || '365');
    return 180;
  }

  function obterIntervaloColheita(frutifera) {
    const especie = (frutifera.especie || frutifera.nome_popular || '').toLowerCase();
    const config = JSON.parse(localStorage.getItem('configIntervalos') || '{}');
    
    if (especie.includes('coqueiro')) return parseInt(config.coq_colh || localStorage.getItem('coq_colh') || '30');
    if (especie.includes('cacau')) return parseInt(config.cac_colh || localStorage.getItem('cac_colh') || '120');
    if (especie.includes('mangabeira')) return parseInt(config.mang_colh || localStorage.getItem('mang_colh') || '90');
    if (especie.includes('caju')) return parseInt(config.caju_colh || localStorage.getItem('caju_colh') || '60');
    return 90;
  }

  // ‚≠ê‚≠ê INICIALIZA√á√ÉO ATUALIZADA ‚≠ê‚≠ê
  async function inicializarApp() {
    console.log('üöÄ Inicializando app...');
    
    try {
      loadConfig(); // Carrega configura√ß√µes primeiro
      atualizarContadorSync();
      await carregarFrutiferas();
      
      document.getElementById('appLoader').classList.add('hidden');
      document.getElementById('mainApp').classList.add('loaded');
      
      // Status online/offline
      const statusDot = document.getElementById('statusDot');
      const statusText = document.getElementById('statusText');
      
      if (navigator.onLine) {
        if (statusDot) statusDot.className = 'status-dot';
        if (statusText) statusText.textContent = 'Online';
        
        // Sincronizar automaticamente quando online
        setTimeout(() => {
          sincronizarTudo();
        }, 3000);
      } else {
        if (statusDot) statusDot.className = 'status-dot offline';
        if (statusText) statusText.textContent = 'Offline';
      }
      
      console.log('‚úÖ App inicializado com sucesso!');
      
    } catch (error) {
      console.error('‚ùå Erro na inicializa√ß√£o:', error);
      document.getElementById('appLoader').classList.add('hidden');
      document.getElementById('mainApp').classList.add('loaded');
    }
  }

  // Event listeners otimizados
  window.addEventListener('online', () => {
    document.getElementById('statusDot').className = 'status-dot';
    document.getElementById('statusText').textContent = 'Online';
    mostrarToast('üåê Conectado! Sincronizando...');
    
    setTimeout(() => {
      sincronizarTudo();
    }, 2000);
  });

  window.addEventListener('offline', () => {
    document.getElementById('statusDot').className = 'status-dot offline';
    document.getElementById('statusText').textContent = 'Offline';
    mostrarToast('üì° Voc√™ est√° offline');
  });

  // Fun√ß√µes do mapa e auxiliares (mantidas iguais)
  function inicializarMapa() {
    if (map) return;
    
    map = L.map('mapContainer').setView([-7.1195, -34.8450], 13);
    
    baseLayers.satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
      attribution: 'Esri, Maxar',
      maxZoom: 19
    });
    
    const orthoBounds = [
      [-7.2567123407225420, -34.8508400655581880],
      [-7.2534701604245848, -34.8470106189991711]
    ];

    orthomosaicLayer = L.imageOverlay('orthomosaic.jpeg', orthoBounds, {
      opacity: 1,
      attribution: 'Ortomosaico S√≠tio Ipiranga'
    }).addTo(map);

    frutiferasLayer = L.layerGroup().addTo(map);
    map.fitBounds(orthoBounds);
    atualizarMapa();
  }

  function atualizarMapa() {
    if (!map || !frutiferasLayer) return;
    
    frutiferasLayer.clearLayers();
    markers = {};
    
    const bounds = [];
    
    frutiferas.forEach(f => {
      if (f.latitude && f.longitude) {
        const color = speciesColors[f.especie] || '#10b981';
        
        const marker = L.circleMarker([f.latitude, f.longitude], {
          radius: 8,
          fillColor: color,
          color: '#fff',
          weight: 2,
          opacity: 1,
          fillOpacity: 0.8
        });

        const popupContent = `
          <div class="popup-content">
            <h3>${f.nome_popular || f.especie}</h3>
            <div class="info-row">
              <span class="info-label">C√≥digo:</span>
              <span class="info-value">${f.identificacao || f.id}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Data Plantio:</span>
              <span class="info-value">${formatarData(f.data_plantio) || 'N√£o informado'}</span>
            </div>
            <div class="info-row">
              <span class="info-label">√öltima Rega:</span>
              <span class="info-value">${formatarData(f.ultima_rega) || 'Nunca'}</span>
            </div>
            ${f.altura_total ? `
            <div class="info-row">
              <span class="info-label">Altura:</span>
              <span class="info-value">${f.altura_total} m</span>
            </div>` : ''}
          </div>
        `;

        marker.bindPopup(popupContent);
        frutiferasLayer.addLayer(marker);
        markers[f.id] = marker;
        bounds.push([f.latitude, f.longitude]);
      }
    });

    if (bounds.length > 0) {
      map.fitBounds(bounds, { padding: [50, 50] });
    }
  }

  function changeBasemap(basemapType, event) {
    document.querySelectorAll('.map-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    
    Object.values(baseLayers).forEach(layer => {
      if (map.hasLayer(layer)) map.removeLayer(layer);
    });
    
    if (orthomosaicLayer && map.hasLayer(orthomosaicLayer)) {
      map.removeLayer(orthomosaicLayer);
    }
    
    if (basemapType === 'orthomosaic') {
      orthomosaicLayer.addTo(map);
      const orthoBounds = [
        [-7.2567123407225420, -34.8508400655581880],
        [-7.2534701604245848, -34.8470106189991711]
      ];
      map.fitBounds(orthoBounds);
    } else if (basemapType === 'satellite') {
      baseLayers.satellite.addTo(map);
      const markerBounds = Object.values(markers).map(m => m.getLatLng());
      if (markerBounds.length > 0) {
        map.fitBounds(markerBounds, { padding: [50, 50] });
      }
    }
  }

  function toggleFrutiferasLayer() {
    const isChecked = document.getElementById('toggleFrutiferas').checked;
    if (isChecked) {
      frutiferasLayer.addTo(map);
    } else {
      map.removeLayer(frutiferasLayer);
    }
  }

  function toggleCadastroForm() {
    const container = document.getElementById('cadastroFormContainer');
    const icon = document.getElementById('cadastroToggleIcon');
    
    if (container.classList.contains('collapsed')) {
      container.classList.remove('collapsed');
      icon.textContent = '‚ñº';
    } else {
      container.classList.add('collapsed');
      icon.textContent = '‚ñ∂';
    }
  }

  function calcularDias(dataString) {
    if (!dataString) return 999;
    const data = new Date(dataString);
    const hoje = new Date();
    const diff = hoje - data;
    return Math.floor(diff / (1000 * 60 * 60 * 24));
  }

  function formatarData(dataString) {
    if (!dataString) return null;
    const data = new Date(dataString);
    return data.toLocaleDateString('pt-BR');
  }

  function mostrarToast(mensagem) {
    const toast = document.getElementById('toast');
    toast.textContent = mensagem;
    toast.className = 'toast show';
    
    setTimeout(() => {
      toast.className = 'toast';
    }, 3000);
  }

  function switchTab(event, tabName) {
    document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
    
    event.target.classList.add('active');
    document.getElementById(tabName).classList.add('active');
    
    if (tabName === 'mapa') {
      setTimeout(() => {
        if (!map) {
          inicializarMapa();
        } else {
          map.invalidateSize();
          atualizarMapa();
        }
      }, 100);
    }
  }

  function filterAcoes(event, filtro) {
    document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
    currentFilter = filtro;
    carregarAcoesHojeDebounced();
  }

  function filtrarFrutiferas() {
    const query = document.getElementById('searchFrutifera').value.toLowerCase();
    const cards = document.querySelectorAll('.frutifera-card');
    
    cards.forEach(card => {
      const text = card.textContent.toLowerCase();
      card.style.display = text.includes(query) ? 'block' : 'none';
    });
  }

  function filterHistorico(event, periodo) {
    document.querySelectorAll('#historico .filter-btn').forEach(btn => btn.classList.remove('active'));
    event.target.classList.add('active');
  }

  function obterLocalizacao() {
    if (!navigator.geolocation) {
      mostrarToast('‚ùå Geolocaliza√ß√£o n√£o suportada');
      return;
    }
    
    mostrarToast('üìç Obtendo localiza√ß√£o...');
    
    navigator.geolocation.getCurrentPosition(
      (position) => {
        const lat = position.coords.latitude.toFixed(6);
        const lon = position.coords.longitude.toFixed(6);
        document.getElementById('coordenadas').value = `${lat}, ${lon}`;
        document.getElementById('coordDisplay').style.display = 'block';
        document.getElementById('coordDisplay').textContent = `‚úÖ Localiza√ß√£o obtida: ${lat}, ${lon}`;
        mostrarToast('‚úÖ Localiza√ß√£o obtida!');
      },
      (error) => {
        console.error('Erro ao obter localiza√ß√£o:', error);
        mostrarToast('‚ùå Erro ao obter localiza√ß√£o');
      }
    );
  }

  // Inicializa√ß√£o
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', inicializarApp);
  } else {
    inicializarApp();
  }
 </script>

</body>
</html>
