name: Notifica√ß√µes Telegram - Supabase

on:
  schedule:
    # 06:00 BR = 09:00 UTC
    - cron: '0 9 * * *'
    # 12:00 BR = 15:00 UTC  
    - cron: '0 15 * * *'
    # 18:00 BR = 21:00 UTC
    - cron: '0 21 * * *'
  workflow_dispatch:

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: https://erbefbnjxgpetbetlzya.supabase.co
      SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyYmVmYm5qeGdwZXRiZXRsenlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMzI4ODcsImV4cCI6MjA3NjYwODg4N30.d09pjgddZpNY3Z4cVZ3V4h77aAf_GVGF0sOBTZkZf2A
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq bc
      
      - name: Buscar dados e processar notifica√ß√£o
        run: |
          # Configurar fuso hor√°rio
          export TZ='America/Sao_Paulo'
          
          # Data atual
          HOJE=$(date +%Y-%m-%d)
          DATA_EXIBICAO=$(date +%d/%m/%Y)
          HORA_EXIBICAO=$(date +%H:%M)
          HORA_NUM=$(date +%H)
          
          # Fun√ß√£o para calcular dias (melhorada)
          dias_desde() {
            local data="$1"
            
            # Se a data for nula ou vazia
            if [ -z "$data" ] || [ "$data" = "null" ] || [ "$data" = "" ]; then
              echo "999"
              return
            fi
            
            # Remover as aspas se houver
            data=$(echo "$data" | sed 's/^"//' | sed 's/"$//')
            
            # Converter para timestamp
            # Tentar formato YYYY-MM-DD
            if [[ "$data" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
              data_epoch=$(date -d "$data" +%s 2>/dev/null || echo "0")
            # Tentar formato YYYY-MM-DD HH:MM:SS
            elif [[ "$data" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}[T\s] ]]; then
              # Extrair apenas a data
              data_pura=$(echo "$data" | cut -d'T' -f1 | cut -d' ' -f1)
              data_epoch=$(date -d "$data_pura" +%s 2>/dev/null || echo "0")
            else
              echo "999"
              return
            fi
            
            hoje_epoch=$(date -d "$HOJE" +%s)
            
            if [ "$data_epoch" = "0" ]; then
              echo "999"
            else
              echo $(( (hoje_epoch - data_epoch) / 86400 ))
            fi
          }
          
          echo "üîÑ Buscando dados do Supabase..."
          
          # URL para a fun√ß√£o RPC
          RPC_URL="${SUPABASE_URL}/rest/v1/rpc/get_plantas_para_telegram"
          
          # Buscar dados da fun√ß√£o RPC
          RESPONSE=$(curl -s -X POST \
            "$RPC_URL" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d '{}')
          
          # Verificar se a resposta √© v√°lida JSON
          if echo "$RESPONSE" | jq -e . >/dev/null 2>&1; then
            TOTAL=$(echo "$RESPONSE" | jq '. | length')
            echo "‚úÖ $TOTAL frut√≠feras encontradas na tabela frutiferas do Supabase"
            echo "$RESPONSE" > dados.json
            
            # Debug: Ver primeira frut√≠fera
            echo "üìÑ Amostra da primeira frut√≠fera:"
            jq '.[0]' dados.json
            
          else
            echo "‚ùå ERRO: Resposta n√£o √© JSON v√°lido"
            echo "Resposta: ${RESPONSE:0:500}..."
            
            # Usar backup local se existir
            if [ -f "dados.json" ]; then
              echo "‚ö†Ô∏è Usando dados.json local..."
              TOTAL=$(jq '. | length' dados.json 2>/dev/null || echo "0")
              echo "‚úÖ $TOTAL frut√≠feras no dados.json local"
              
            else
              TOTAL=0
              echo '[]' > dados.json
            fi
          fi
          
          # Sauda√ß√£o
          if [ "$HORA_NUM" -lt 12 ]; then
            SAUDACAO="‚òÄÔ∏è Bom dia"
          elif [ "$HORA_NUM" -lt 18 ]; then
            SAUDACAO="‚õÖ Boa tarde"
          else
            SAUDACAO="üåô Boa noite"
          fi
          
          # Iniciar mensagem
          MESSAGE="${SAUDACAO}!%0A"
          MESSAGE="${MESSAGE}üåø *S√≠tio Ipiranga*%0A"
          MESSAGE="${MESSAGE}üìÖ ${DATA_EXIBICAO} √†s ${HORA_EXIBICAO}%0A"
          MESSAGE="${MESSAGE}üå≥ *${TOTAL} frut√≠feras* cadastradas%0A%0A"
          
          if [ "$TOTAL" -eq "0" ]; then
            MESSAGE="${MESSAGE}‚ö†Ô∏è *Nenhuma frut√≠fera encontrada*%0A"
          else
            # Arrays para a√ß√µes
            REGA_URG=""
            REGA_NORM=""
            PODA_PEND=""
            COLHEITA_PEND=""
            TOTAL_ACOES=0
            
            # Processar cada frut√≠fera
            while IFS= read -r item; do
              ID=$(echo "$item" | jq -r '.id // "S/N"')
              NOME=$(echo "$item" | jq -r '.nome // "Frut√≠fera"')
              ULT_REGA=$(echo "$item" | jq -r '.ultRega // "null"')
              ULT_PODA=$(echo "$item" | jq -r '.ultPoda // "null"')
              ULT_COLH=$(echo "$item" | jq -r '.ultColh // "null"')
              
              # Debug individual (apenas para as primeiras 3)
              if [ "$TOTAL_ACOES" -lt 3 ]; then
                echo "Processando: ID=$ID, NOME=$NOME"
                echo "  ultRega: $ULT_REGA"
                echo "  ultPoda: $ULT_PODA"
                echo "  ultColh: $ULT_COLH"
              fi
              
              # Normalizar nome para min√∫sculas
              NOME_NORM=$(echo "$NOME" | tr '[:upper:]' '[:lower:]' | tr '√°√†√£√¢' 'a' | tr '√©√™' 'e' | tr '√≠' 'i' | tr '√≥√¥√µ' 'o' | tr '√∫' 'u' | tr '√ß' 'c')
              
              # Determinar intervalos baseados no tipo
              REGA_INT=7
              PODA_INT=180
              COLHEITA_INT=90
              EMOJI="üåø"
              
              if echo "$NOME_NORM" | grep -q "mangabeira\|mangaba"; then
                REGA_INT=7; PODA_INT=180; COLHEITA_INT=90; EMOJI="ü•≠"
              elif echo "$NOME_NORM" | grep -q "caju\|cajueiro"; then
                REGA_INT=10; PODA_INT=365; COLHEITA_INT=60; EMOJI="üå∞"
              elif echo "$NOME_NORM" | grep -q "coq\|coqueiro\|coco"; then
                REGA_INT=5; PODA_INT=730; COLHEITA_INT=30; EMOJI="ü••"
              elif echo "$NOME_NORM" | grep -q "cacau"; then
                REGA_INT=3; PODA_INT=180; COLHEITA_INT=120; EMOJI="üç´"
              elif echo "$NOME_NORM" | grep -q "banana\|bananeira"; then
                REGA_INT=2; PODA_INT=60; COLHEITA_INT=45; EMOJI="üçå"
              fi
              
              # Verificar rega
              DIAS_R=$(dias_desde "$ULT_REGA")
              
              if [ "$DIAS_R" -eq "999" ]; then
                # Nunca foi regada
                REGA_URG="${REGA_URG}‚Ä¢ üö® ${EMOJI} ${NOME} #${ID} - NUNCA REGADA%0A"
                TOTAL_ACOES=$((TOTAL_ACOES + 1))
              elif [ "$DIAS_R" -ge $((REGA_INT + 2)) ]; then
                REGA_URG="${REGA_URG}‚Ä¢ üö® ${EMOJI} ${NOME} #${ID} - ${DIAS_R} dias%0A"
                TOTAL_ACOES=$((TOTAL_ACOES + 1))
              elif [ "$DIAS_R" -ge "$REGA_INT" ]; then
                REGA_NORM="${REGA_NORM}‚Ä¢ üíß ${EMOJI} ${NOME} #${ID} - ${DIAS_R} dias%0A"
                TOTAL_ACOES=$((TOTAL_ACOES + 1))
              fi
              
              # Verificar poda
              DIAS_P=$(dias_desde "$ULT_PODA")
              if [ "$DIAS_P" -ne "999" ] && [ "$DIAS_P" -ge "$PODA_INT" ]; then
                PODA_PEND="${PODA_PEND}‚Ä¢ ‚úÇÔ∏è ${EMOJI} ${NOME} #${ID} - ${DIAS_P} dias%0A"
                TOTAL_ACOES=$((TOTAL_ACOES + 1))
              fi
              
              # Verificar colheita
              DIAS_C=$(dias_desde "$ULT_COLH")
              if [ "$DIAS_C" -ne "999" ] && [ "$DIAS_C" -ge "$COLHEITA_INT" ]; then
                COLHEITA_PEND="${COLHEITA_PEND}‚Ä¢ üçé ${EMOJI} ${NOME} #${ID} - ${DIAS_C} dias%0A"
                TOTAL_ACOES=$((TOTAL_ACOES + 1))
              fi
              
            done < <(jq -c '.[]' dados.json)
            
            # Montar mensagem final
            if [ "$TOTAL_ACOES" -eq 0 ]; then
              MESSAGE="${MESSAGE}‚úÖ *Tudo em dia!*%0ANenhuma a√ß√£o pendente.%0A"
            else
              MESSAGE="${MESSAGE}üìã *${TOTAL_ACOES} a√ß√£o(√µes) pendente(s):*%0A%0A"
              [ -n "$REGA_URG" ] && MESSAGE="${MESSAGE}üö® *URGENTE:*%0A${REGA_URG}%0A"
              [ -n "$REGA_NORM" ] && MESSAGE="${MESSAGE}üíß *Rega:*%0A${REGA_NORM}%0A"
              [ -n "$PODA_PEND" ] && MESSAGE="${MESSAGE}‚úÇÔ∏è *Poda:*%0A${PODA_PEND}%0A"
              [ -n "$COLHEITA_PEND" ] && MESSAGE="${MESSAGE}üçé *Colheita:*%0A${COLHEITA_PEND}%0A"
            fi
          fi
          
          MESSAGE="${MESSAGE}%0Aüì± *Acesse o app:*%0A"
          MESSAGE="${MESSAGE}https://yurimegromonte182.github.io/S-tio_Jintanga/"
          
          # Salvar mensagem para debug
          echo "=== MENSAGEM GERADA ==="
          echo -e "$MESSAGE" | sed 's/%0A/\n/g'
          echo "======================"
          
          # Enviar para Telegram
          echo "üì§ Enviando para Telegram..."
          TELEGRAM_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown")
          
          HTTP_CODE=$(echo "$TELEGRAM_RESPONSE" | tail -n1)
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Notifica√ß√£o enviada com sucesso!"
          else
            echo "‚ùå Erro ao enviar: HTTP $HTTP_CODE"
            echo "Resposta: $(echo "$TELEGRAM_RESPONSE" | head -n -1)"
          fi
          
          # Estat√≠sticas di√°rias (06h BR = 09:00 UTC)
          # Verificar pelo hor√°rio UTC (9 = 06h BR)
          HORA_UTC=$(date -u +%H)
          if [ "$HORA_UTC" -eq "9" ]; then
            if [ "$TOTAL" -gt "0" ]; then
              echo "üåÖ Enviando estat√≠sticas di√°rias (06h BR)..."
              
              # Contar por tipo
              COQUEIROS=0
              CAJUEIROS=0
              CACAU=0
              MANGABEIRA=0
              BANANEIRAS=0
              OUTRAS=0
              
              while IFS= read -r item; do
                NOME=$(echo "$item" | jq -r '.nome // ""' | tr '[:upper:]' '[:lower:]' | tr '√°√†√£√¢' 'a' | tr '√©√™' 'e' | tr '√≠' 'i' | tr '√≥√¥√µ' 'o' | tr '√∫' 'u' | tr '√ß' 'c')
                
                if echo "$NOME" | grep -q "coq\|coqueiro\|coco"; then
                  COQUEIROS=$((COQUEIROS + 1))
                elif echo "$NOME" | grep -q "caju\|cajueiro"; then
                  CAJUEIROS=$((CAJUEIROS + 1))
                elif echo "$NOME" | grep -q "cacau"; then
                  CACAU=$((CACAU + 1))
                elif echo "$NOME" | grep -q "mangabeira\|mangaba"; then
                  MANGABEIRA=$((MANGABEIRA + 1))
                elif echo "$NOME" | grep -q "banana\|bananeira"; then
                  BANANEIRAS=$((BANANEIRAS + 1))
                else
                  OUTRAS=$((OUTRAS + 1))
                fi
              done < <(jq -c '.[]' dados.json)
              
              STATS="üìä *Resumo do S√≠tio:*%0A"
              STATS="${STATS}üå≥ Total: ${TOTAL} frut√≠feras%0A"
              [ "$COQUEIROS" -gt 0 ] && STATS="${STATS}ü•• Coqueiros: ${COQUEIROS}%0A"
              [ "$CAJUEIROS" -gt 0 ] && STATS="${STATS}üå∞ Cajueiros: ${CAJUEIROS}%0A"
              [ "$CACAU" -gt 0 ] && STATS="${STATS}üç´ Cacau: ${CACAU}%0A"
              [ "$MANGABEIRA" -gt 0 ] && STATS="${STATS}ü•≠ Mangabeiras: ${MANGABEIRA}%0A"
              [ "$BANANEIRAS" -gt 0 ] && STATS="${STATS}üçå Bananeiras: ${BANANEIRAS}%0A"
              [ "$OUTRAS" -gt 0 ] && STATS="${STATS}üåø Outras: ${OUTRAS}%0A"
              
              TELEGRAM_STATS_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
                -d chat_id="$TELEGRAM_CHAT_ID" \
                -d text="$STATS" \
                -d parse_mode="Markdown")
              
              STATS_HTTP_CODE=$(echo "$TELEGRAM_STATS_RESPONSE" | tail -n1)
              if [ "$STATS_HTTP_CODE" = "200" ]; then
                echo "‚úÖ Estat√≠sticas enviadas!"
              else
                echo "‚ö†Ô∏è N√£o foi poss√≠vel enviar estat√≠sticas"
              fi
            fi
          fi
