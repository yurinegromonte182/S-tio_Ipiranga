name: Notifica√ß√µes Telegram - Sincroniza√ß√£o com Supabase

on:
  schedule:
    # 06:00 BR = 09:00 UTC
    - cron: '0 9 * * *'
    # 12:00 BR = 15:00 UTC
    - cron: '0 15 * * *'
    # 18:00 BR = 21:00 UTC
    - cron: '0 21 * * *'
  workflow_dispatch:

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    
    steps:
      - name: Configurar ambiente
        run: |
          apt-get update
          apt-get install -y curl jq
          
          # Criar arquivo de configura√ß√£o do Supabase
          cat > /tmp/supabase_config.json << EOF
          {
            "url": "${{ secrets.SUPABASE_URL }}",
            "key": "${{ secrets.SUPABASE_ANON_KEY }}"
          }
          EOF
      
      - name: Buscar dados do Supabase
        id: get-data
        run: |
          # Configurar fuso hor√°rio
          export TZ='America/Sao_Paulo'
          
          # Data atual
          HOJE=$(date +%Y-%m-%d)
          DATA_EXIBICAO=$(date +%d/%m/%Y)
          HORA_EXIBICAO=$(date +%H:%M)
          HORA_NUM=$(date +%H)
          
          echo "HOJE=$HOJE" >> $GITHUB_OUTPUT
          echo "DATA_EXIBICAO=$DATA_EXIBICAO" >> $GITHUB_OUTPUT
          echo "HORA_EXIBICAO=$HORA_EXIBICAO" >> $GITHUB_OUTPUT
          echo "HORA_NUM=$HORA_NUM" >> $GITHUB_OUTPUT
          
          # Fun√ß√£o para calcular dias
          dias_desde() {
            if [ -z "$1" ] || [ "$1" = "null" ] || [ "$1" = "" ]; then
              echo "999"
            else
              data_epoch=$(date -d "$1" +%s 2>/dev/null || echo "0")
              hoje_epoch=$(date -d "$HOJE" +%s)
              if [ "$data_epoch" = "0" ]; then
                echo "999"
              else
                echo $(( (hoje_epoch - data_epoch) / 86400 ))
              fi
            fi
          }
          
          # Fun√ß√£o para normalizar texto
          normalizar_texto() {
            echo "$1" | tr '[:upper:]' '[:lower:]' | sed 's/^ *//;s/ *$//'
          }
          
          # Buscar dados de plantas do Supabase (plantas_mestre)
          echo "üîÑ Buscando plantas do Supabase..."
          
          # Primeiro, buscar plantas mestras
          PLANTAS_RESPONSE=$(curl -s -X POST \
            "${SUPABASE_URL}/rest/v1/rpc/get_plantas_info" \
            -H "apikey: ${SUPABASE_ANON_KEY}" \
            -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
            -H "Content-Type: application/json" \
            -d '{}')
          
          echo "Plantas encontradas: $(echo "$PLANTAS_RESPONSE" | jq -r 'length')"
          
          # Se n√£o conseguir dados do Supabase, usar backup do GitHub
          if [ -z "$PLANTAS_RESPONSE" ] || [ "$(echo "$PLANTAS_RESPONSE" | jq -r 'length')" -eq 0 ]; then
            echo "‚ö†Ô∏è Nenhuma planta no Supabase, verificando GitHub..."
            
            # Verificar se tem arquivo no GitHub
            if [ -f "dados.geojson" ]; then
              echo "‚úÖ Usando dados do GitHub como fallback"
              
              # Contar total de plantas
              TOTAL=$(jq '.features | length' dados.geojson 2>/dev/null || echo "0")
              echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT
              
              # Processar cada planta do arquivo local
              jq -c '.features[]' dados.geojson 2>/dev/null | while read -r feature; do
                ID=$(echo "$feature" | jq -r '.properties.id // .properties.fid // "S/N"')
                NOME=$(echo "$feature" | jq -r '.properties.nome_popular // "Planta"')
                ULT_REGA=$(echo "$feature" | jq -r '.properties.ultima_rega // "null"')
                ULT_PODA=$(echo "$feature" | jq -r '.properties.ultima_poda // "null"')
                ULT_COLH=$(echo "$feature" | jq -r '.properties.ultima_colheita // "null"')
                
                echo "PLANTA|$ID|$NOME|$ULT_REGA|$ULT_PODA|$ULT_COLH"
              done > /tmp/plantas.txt
              
            else
              echo "TOTAL=0" >> $GITHUB_OUTPUT
              echo "‚ùå Sem dados dispon√≠veis"
            fi
            
          else
            # Processar dados do Supabase
            TOTAL=$(echo "$PLANTAS_RESPONSE" | jq -r 'length')
            echo "TOTAL=$TOTAL" >> $GITHUB_OUTPUT
            
            echo "‚úÖ Processando $TOTAL plantas do Supabase"
            
            # Para cada planta, buscar a √∫ltima a√ß√£o de cada tipo
            echo "$PLANTAS_RESPONSE" | jq -c '.[]' | while read -r planta; do
              PLANTA_ID=$(echo "$planta" | jq -r '.planta_id')
              NOME=$(echo "$planta" | jq -r '.nome_popular // "Planta"')
              
              # Buscar √∫ltima rega para esta planta
              ULT_REGA=$(curl -s -X POST \
                "${SUPABASE_URL}/rest/v1/rpc/get_ultima_acao" \
                -H "apikey: ${SUPABASE_ANON_KEY}" \
                -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
                -H "Content-Type: application/json" \
                -d "{\"p_planta_id\": \"$PLANTA_ID\", \"p_acao_tipo\": \"rega\"}" | \
                jq -r '.data_execucao // "null"')
                
              # Buscar √∫ltima poda
              ULT_PODA=$(curl -s -X POST \
                "${SUPABASE_URL}/rest/v1/rpc/get_ultima_acao" \
                -H "apikey: ${SUPABASE_ANON_KEY}" \
                -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
                -H "Content-Type: application/json" \
                -d "{\"p_planta_id\": \"$PLANTA_ID\", \"p_acao_tipo\": \"poda\"}" | \
                jq -r '.data_execucao // "null"')
                
              # Buscar √∫ltima colheita
              ULT_COLH=$(curl -s -X POST \
                "${SUPABASE_URL}/rest/v1/rpc/get_ultima_acao" \
                -H "apikey: ${SUPABASE_ANON_KEY}" \
                -H "Authorization: Bearer ${SUPABASE_ANON_KEY}" \
                -H "Content-Type: application/json" \
                -d "{\"p_planta_id\": \"$PLANTA_ID\", \"p_acao_tipo\": \"colheita\"}" | \
                jq -r '.data_execucao // "null"')
              
              echo "PLANTA|$PLANTA_ID|$NOME|$ULT_REGA|$ULT_PODA|$ULT_COLH"
            done > /tmp/plantas.txt
          fi
      
      - name: Gerar notifica√ß√£o
        run: |
          # Recuperar vari√°veis
          HOJE="${{ steps.get-data.outputs.HOJE }}"
          DATA_EXIBICAO="${{ steps.get-data.outputs.DATA_EXIBICAO }}"
          HORA_EXIBICAO="${{ steps.get-data.outputs.HORA_EXIBICAO }}"
          HORA_NUM="${{ steps.get-data.outputs.HORA_NUM }}"
          TOTAL="${{ steps.get-data.outputs.TOTAL }}"
          
          # Fun√ß√£o para calcular dias
          dias_desde() {
            if [ -z "$1" ] || [ "$1" = "null" ] || [ "$1" = "" ]; then
              echo "999"
            else
              data_epoch=$(date -d "$1" +%s 2>/dev/null || echo "0")
              hoje_epoch=$(date -d "$HOJE" +%s)
              if [ "$data_epoch" = "0" ]; then
                echo "999"
              else
                echo $(( (hoje_epoch - data_epoch) / 86400 ))
              fi
            fi
          }
          
          # Fun√ß√£o para normalizar texto
          normalizar_texto() {
            echo "$1" | tr '[:upper:]' '[:lower:]' | sed 's/^ *//;s/ *$//'
          }
          
          # Sauda√ß√£o
          if [ "$HORA_NUM" -lt 12 ]; then
            SAUDACAO="‚òÄÔ∏è Bom dia"
          elif [ "$HORA_NUM" -lt 18 ]; then
            SAUDACAO="‚õÖ Boa tarde"
          else
            SAUDACAO="üåô Boa noite"
          fi
          
          # Iniciar mensagem
          MESSAGE="${SAUDACAO}!%0A"
          MESSAGE="${MESSAGE}üåø *S√≠tio Ipiranga*%0A"
          MESSAGE="${MESSAGE}üìÖ ${DATA_EXIBICAO} √†s ${HORA_EXIBICAO}%0A"
          MESSAGE="${MESSAGE}üå≥ *${TOTAL} plantas* cadastradas%0A%0A"
          MESSAGE="${MESSAGE}üì° *Fonte:* Supabase%0A%0A"
          
          # Processar a√ß√µes se tiver plantas
          if [ "$TOTAL" -gt "0" ] && [ -f "/tmp/plantas.txt" ]; then
            # Arrays para a√ß√µes
            REGA_URG=""
            REGA_NORM=""
            PODA_PEND=""
            COLHEITA_PEND=""
            TOTAL_ACOES=0
            
            # Ler plantas do arquivo tempor√°rio
            while IFS='|' read -r TAG ID NOME ULT_REGA ULT_PODA ULT_COLH; do
              if [ "$TAG" = "PLANTA" ]; then
                # Normalizar nome
                NOME_NORM=$(normalizar_texto "$NOME")
                
                # Determinar intervalos
                if echo "$NOME_NORM" | grep -q "mangabeira"; then
                  REGA_INT=7; PODA_INT=180; COLHEITA_INT=90
                elif echo "$NOME_NORM" | grep -q "caju"; then
                  REGA_INT=10; PODA_INT=365; COLHEITA_INT=60
                elif echo "$NOME_NORM" | grep -q "coq"; then
                  REGA_INT=5; PODA_INT=730; COLHEITA_INT=30
                elif echo "$NOME_NORM" | grep -q "cacau"; then
                  REGA_INT=3; PODA_INT=180; COLHEITA_INT=120
                else
                  REGA_INT=7; PODA_INT=180; COLHEITA_INT=90
                fi
                
                # Verificar rega
                DIAS_R=$(dias_desde "$ULT_REGA")
                if [ "$DIAS_R" -ge $((REGA_INT + 2)) ]; then
                  REGA_URG="${REGA_URG}‚Ä¢ üö® ${NOME} #${ID} - ${DIAS_R} dias%0A"
                  TOTAL_ACOES=$((TOTAL_ACOES + 1))
                elif [ "$DIAS_R" -ge "$REGA_INT" ]; then
                  REGA_NORM="${REGA_NORM}‚Ä¢ üíß ${NOME} #${ID} - ${DIAS_R} dias%0A"
                  TOTAL_ACOES=$((TOTAL_ACOES + 1))
                fi
                
                # Verificar poda
                DIAS_P=$(dias_desde "$ULT_PODA")
                if [ "$DIAS_P" -ge "$PODA_INT" ]; then
                  PODA_PEND="${PODA_PEND}‚Ä¢ ‚úÇÔ∏è ${NOME} #${ID} - ${DIAS_P} dias%0A"
                  TOTAL_ACOES=$((TOTAL_ACOES + 1))
                fi
                
                # Verificar colheita
                DIAS_C=$(dias_desde "$ULT_COLH")
                if [ "$DIAS_C" -ge "$COLHEITA_INT" ]; then
                  COLHEITA_PEND="${COLHEITA_PEND}‚Ä¢ üçé ${NOME} #${ID} - ${DIAS_C} dias%0A"
                  TOTAL_ACOES=$((TOTAL_ACOES + 1))
                fi
              fi
            done < /tmp/plantas.txt
            
            # Montar mensagem final
            if [ "$TOTAL_ACOES" -eq 0 ]; then
              MESSAGE="${MESSAGE}‚úÖ *Tudo em dia!*%0ANenhuma a√ß√£o pendente.%0A"
            else
              MESSAGE="${MESSAGE}üìã *${TOTAL_ACOES} a√ß√£o(√µes) pendente(s):*%0A%0A"
              [ -n "$REGA_URG" ] && MESSAGE="${MESSAGE}üö® *URGENTE:*%0A${REGA_URG}%0A"
              [ -n "$REGA_NORM" ] && MESSAGE="${MESSAGE}üíß *Rega:*%0A${REGA_NORM}%0A"
              [ -n "$PODA_PEND" ] && MESSAGE="${MESSAGE}‚úÇÔ∏è *Poda:*%0A${PODA_PEND}%0A"
              [ -n "$COLHEITA_PEND" ] && MESSAGE="${MESSAGE}üçé *Colheita:*%0A${COLHEITA_PEND}%0A"
            fi
          else
            MESSAGE="${MESSAGE}‚ö†Ô∏è *Nenhuma planta encontrada*%0A"
          fi
          
          MESSAGE="${MESSAGE}%0Aüì± *Acesse o app:*%0A"
          MESSAGE="${MESSAGE}https://yurimegromonte182.github.io/S-tio_Jintanga/"
          
          # Salvar mensagem em arquivo para uso posterior
          echo "$MESSAGE" > /tmp/mensagem.txt
      
      - name: Enviar para Telegram
        run: |
          MESSAGE=$(cat /tmp/mensagem.txt)
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"
          
          echo "‚úÖ Notifica√ß√£o enviada!"
      
      - name: Estat√≠sticas di√°rias (06h)
        if: github.event.schedule == '0 9 * * *'
        run: |
          if [ -f "/tmp/plantas.txt" ] && [ "${{ steps.get-data.outputs.TOTAL }}" -gt "0" ]; then
            TOTAL="${{ steps.get-data.outputs.TOTAL }}"
            
            # Contar por tipo
            COQUEIROS=0
            CAJUEIROS=0
            CACAU=0
            MANGABEIRA=0
            
            while IFS='|' read -r TAG ID NOME ULT_REGA ULT_PODA ULT_COLH; do
              if [ "$TAG" = "PLANTA" ]; then
                NOME_NORM=$(echo "$NOME" | tr '[:upper:]' '[:lower:]')
                
                if echo "$NOME_NORM" | grep -q "coq"; then
                  COQUEIROS=$((COQUEIROS + 1))
                elif echo "$NOME_NORM" | grep -q "caju"; then
                  CAJUEIROS=$((CAJUEIROS + 1))
                elif echo "$NOME_NORM" | grep -q "cacau"; then
                  CACAU=$((CACAU + 1))
                elif echo "$NOME_NORM" | grep -q "mangabeira"; then
                  MANGABEIRA=$((MANGABEIRA + 1))
                fi
              fi
            done < /tmp/plantas.txt
            
            STATS="üìä *Resumo do S√≠tio:*%0A"
            STATS="${STATS}üå≥ Total: ${TOTAL} plantas%0A"
            [ "$COQUEIROS" -gt 0 ] && STATS="${STATS}ü•• Coqueiros: ${COQUEIROS}%0A"
            [ "$CAJUEIROS" -gt 0 ] && STATS="${STATS}üå∞ Cajueiros: ${CAJUEIROS}%0A"
            [ "$CACAU" -gt 0 ] && STATS="${STATS}üç´ Cacau: ${CACAU}%0A"
            [ "$MANGABEIRA" -gt 0 ] && STATS="${STATS}ü•≠ Mangabeira: ${MANGABEIRA}%0A"
            STATS="${STATS}%0Aüì° *Fonte:* Supabase"
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="${STATS}" \
              -d parse_mode="Markdown"
          fi
