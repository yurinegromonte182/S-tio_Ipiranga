name: Telegram Notifications - Supabase

on:
  schedule:
    # 06:00 BR = 09:00 UTC
    - cron: '0 9 * * *'
    # 12:00 BR = 15:00 UTC
    - cron: '0 15 * * *'
    # 18:00 BR = 21:00 UTC
    - cron: '0 21 * * *'
  workflow_dispatch:
    inputs:
      tipo_relatorio:
        description: 'Tipo de relat√≥rio'
        required: true
        default: 'diario'
        type: choice
        options:
        - diario
        - completo
        - urgente

jobs:
  fetch-supabase-data:
    runs-on: ubuntu-latest
    outputs:
      total_frutiferas: ${{ steps.count-data.outputs.total_frutiferas }}
      total_species: ${{ steps.count-data.outputs.total_species }}
      pending_actions: ${{ steps.count-data.outputs.pending_actions }}
    steps:
      - name: Buscar dados do Supabase
        id: count-data
        env:
          SUPABASE_URL: "https://erbefbnjxgpetbetlzya.supabase.co"
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
          
        run: |
          # 1. Contar total de frut√≠feras
          TOTAL_FRUTIFERAS=$(curl -s "$SUPABASE_URL/rest/v1/frutiferas?select=id" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" | jq '. | length')
          
          # 2. Contar esp√©cies √∫nicas
          TOTAL_SPECIES=$(curl -s "$SUPABASE_URL/rest/v1/frutiferas?select=nome_popular" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" | jq 'map(.nome_popular) | unique | length')
          
          # 3. Verificar a√ß√µes pendentes (ultima_rega antiga)
          DAYS_AGO=$(date -u -d "7 days ago" +%Y-%m-%d)
          
          PENDING_ACTIONS=$(curl -s "$SUPABASE_URL/rest/v1/frutiferas?select=id&ultima_rega=lt.$DAYS_AGO" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" | jq '. | length')
          
          # Garantir que os valores n√£o estejam vazios
          TOTAL_FRUTIFERAS=${TOTAL_FRUTIFERAS:-0}
          TOTAL_SPECIES=${TOTAL_SPECIES:-0}
          PENDING_ACTIONS=${PENDING_ACTIONS:-0}
          
          echo "total_frutiferas=$TOTAL_FRUTIFERAS" >> $GITHUB_OUTPUT
          echo "total_species=$TOTAL_SPECIES" >> $GITHUB_OUTPUT
          echo "pending_actions=$PENDING_ACTIONS" >> $GITHUB_OUTPUT
          
          echo "üìä Dados obtidos do Supabase:"
          echo "  Frut√≠feras: $TOTAL_FRUTIFERAS"
          echo "  Esp√©cies: $TOTAL_SPECIES"
          echo "  A√ß√µes pendentes: $PENDING_ACTIONS"

  send-telegram-report:
    runs-on: ubuntu-latest
    needs: fetch-supabase-data
    steps:
      - name: Enviar relat√≥rio para Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Formatar mensagem com dados do Supabase
          TIPO_RELATORIO="${{ github.event.inputs.tipo_relatorio }}"
          if [ -z "$TIPO_RELATORIO" ]; then
            TIPO_RELATORIO="Autom√°tico"
          fi
          
          TEXT="üåø *RELAT√ìRIO S√çTIO IPIRANGA* üåø

üìä *Dados do Sistema:*
üå≥ *Frut√≠feras:* ${{ needs.fetch-supabase-data.outputs.total_frutiferas }}
üè∑Ô∏è *Esp√©cies:* ${{ needs.fetch-supabase-data.outputs.total_species }}
‚ö†Ô∏è *A√ß√µes Pendentes:* ${{ needs.fetch-supabase-data.outputs.pending_actions }}

‚è∞ *Hor√°rio:* $(TZ='America/Fortaleza' date '+%d/%m/%Y %H:%M')
üîÑ *Tipo:* $TIPO_RELATORIO

üì° *Status:* ‚úÖ Conectado ao Supabase
üó∫Ô∏è *SIGWEB:* Operacional"
          
          # Enviar para Telegram
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$TEXT" \
            -d parse_mode="Markdown"
          
          echo "‚úÖ Relat√≥rio enviado para Telegram!"

  log-to-supabase:
    runs-on: ubuntu-latest
    needs: [fetch-supabase-data, send-telegram-report]
    steps:
      - name: Registrar execu√ß√£o no Supabase
        env:
          SUPABASE_URL: "https://erbefbnjxgpetbetlzya.supabase.co"
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          # Preparar dados para o log
          TIPO_RELATORIO="${{ github.event.inputs.tipo_relatorio }}"
          if [ -z "$TIPO_RELATORIO" ]; then
            TIPO_RELATORIO="autom√°tico"
          fi
          
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          
          # Criar log da execu√ß√£o
          JSON_DATA=$(jq -n \
            --arg tipo "$TIPO_RELATORIO" \
            --arg total "${{ needs.fetch-supabase-data.outputs.total_frutiferas }}" \
            --arg especies "${{ needs.fetch-supabase-data.outputs.total_species }}" \
            --arg pendentes "${{ needs.fetch-supabase-data.outputs.pending_actions }}" \
            --arg timestamp "$TIMESTAMP" \
            '{
              tipo: $tipo,
              total_frutiferas: ($total | tonumber),
              especies: ($especies | tonumber),
              acoes_pendentes: ($pendentes | tonumber),
              executado_em: $timestamp
            }')
          
          # Inserir na tabela de logs
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$SUPABASE_URL/rest/v1/telegram_logs" \
            -H "apikey: $SUPABASE_SERVICE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "$JSON_DATA")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          
          if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
            echo "üìù Log registrado no Supabase com sucesso!"
          else
            echo "‚ö†Ô∏è Erro ao registrar log (HTTP $HTTP_CODE)"
            echo "Response: $(echo "$RESPONSE" | head -n-1)"
          fi
