name: NotificaÃ§Ãµes Telegram - SincronizaÃ§Ã£o AutomÃ¡tica

on:
  schedule:
    - cron: '0 9 * * *'
    - cron: '0 15 * * *'
    - cron: '0 21 * * *'
  workflow_dispatch:
jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Instalar dependÃªncias do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y jq postgis postgresql-client

      #######################################################################
      #  NOVO BLOCO CORRIGIDO â€” CONEXÃƒO SUPABASE VIA HOST/USER/PASSWORD     #
      #######################################################################
      - name: Baixar dados do Supabase (PostGIS â†’ GeoJSON)
        env:
          SUPABASE_HOST: ${{ secrets.SUPABASE_HOST }}
          SUPABASE_USER: ${{ secrets.SUPABASE_USER }}
          SUPABASE_PASSWORD: ${{ secrets.SUPABASE_PASSWORD }}
          SUPABASE_DB: ${{ secrets.SUPABASE_DB }}
          SUPABASE_PORT: ${{ secrets.SUPABASE_PORT }}
        run: |
          echo "Baixando dados do Supabase via conexÃ£o direta..."

          SQL="SELECT jsonb_build_object(
                  'type','FeatureCollection',
                  'features', jsonb_agg(
                    jsonb_build_object(
                      'type','Feature',
                      'geometry', ST_AsGeoJSON(geom)::jsonb,
                      'properties', to_jsonb(row) - 'geom'
                    )
                  )
                )
                FROM (SELECT * FROM arvores) row;"

          export PGPASSWORD="$SUPABASE_PASSWORD"

          psql -h "$SUPABASE_HOST" \
               -p "${SUPABASE_PORT:-5432}" \
               -U "$SUPABASE_USER" \
               -d "$SUPABASE_DB" \
               -t -A -c "$SQL" > dados.geojson

          echo "Dados baixados com sucesso!"
      #######################################################################

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Processar aÃ§Ãµes e notificar Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # (resto do seu script permanece exatamente igual)
          echo "Processando aÃ§Ãµes e enviando notificaÃ§Ãµes..."

          # Instalar jq
          sudo apt-get update
          sudo apt-get install -y jq
          
          export TZ='America/Sao_Paulo'
          
          HOJE=$(date +%Y-%m-%d)
          DATA_EXIBICAO=$(date +%d/%m/%Y)
          HORA_EXIBICAO=$(date +%H:%M)
          HORA_NUM=$(date +%H)

          # Intervalos
          declare -A REGA_INT=( ["Mangabeira"]=7 ["Cajueiro"]=10 ["Coqueiro"]=5 ["Cacau"]=3 ["default"]=7 )
          declare -A PODA_INT=( ["Mangabeira"]=180 ["Cajueiro"]=365 ["Coqueiro"]=730 ["Cacau"]=180 ["default"]=180 )
          declare -A COLH_INT=( ["Mangabeira"]=90 ["Cajueiro"]=60 ["Coqueiro"]=30 ["Cacau"]=120 ["default"]=90 )

          # FunÃ§Ã£o dias desde
          dias_desde() {
            if [ -z "$1" ] || [ "$1" = "null" ]; then
              echo "999"
            else
              echo $(( ( $(date -d "$HOJE" +%s) - $(date -d "$1" +%s) ) / 86400 ))
            fi
          }

          # FunÃ§Ã£o intervalo
          get_intervalo() {
            local especie=$1
            local tipo=$2
            case "$tipo" in
              "rega")
                case "$especie" in
                  *"Mangabeira"*) echo 7 ;;
                  *"Caju"*) echo 10 ;;
                  *"Coq"*) echo 5 ;;
                  *"Cacau"*) echo 3 ;;
                  *) echo 7 ;;
                esac ;;
              "poda")
                case "$especie" in
                  *"Mangabeira"*) echo 180 ;;
                  *"Caju"*) echo 365 ;;
                  *"Coq"*) echo 730 ;;
                  *"Cacau"*) echo 180 ;;
                  *) echo 180 ;;
                esac ;;
              "colheita")
                case "$especie" in
                  *"Mangabeira"*) echo 90 ;;
                  *"Caju"*) echo 60 ;;
                  *"Coq"*) echo 30 ;;
                  *"Cacau"*) echo 120 ;;
                  *) echo 90 ;;
                esac ;;
            esac
          }

          # Processar plantas
          jq -c '.features[]' dados.geojson | while read -r feature; do
            ID=$(echo "$feature" | jq -r '.properties.id // .properties.ID // "S/N"')
            NOME=$(echo "$feature" | jq -r '.properties.nome_popular // .properties.NOME_POPULAR // "Planta"')
            ULT_REGA=$(echo "$feature" | jq -r '.properties.ultima_rega // .properties.ULTIMA_REGA // "null"')
            ULT_PODA=$(echo "$feature" | jq -r '.properties.ultima_poda // .properties.ULTIMA_PODA // "null"')
            ULT_COLH=$(echo "$feature" | jq -r '.properties.ultima_colheita // .properties.ULTIMA_COLHEITA // "null"')

            INT_R=$(get_intervalo "$NOME" "rega")
            DIAS_R=$(dias_desde "$ULT_REGA")

            if [ "$DIAS_R" -ge $((INT_R+2)) ]; then
              echo "REGA_URG:$NOME #$ID - Atrasada $DIAS_R dias" >> /tmp/acoes.txt
            elif [ "$DIAS_R" -ge "$INT_R" ]; then
              echo "REGA_NORM:$NOME #$ID - HÃ¡ $DIAS_R dias" >> /tmp/acoes.txt
            fi

            INT_P=$(get_intervalo "$NOME" "poda")
            DIAS_P=$(dias_desde "$ULT_PODA")
            [ "$DIAS_P" -ge "$INT_P" ] && echo "PODA:$NOME #$ID" >> /tmp/acoes.txt

            INT_C=$(get_intervalo "$NOME" "colheita")
            DIAS_C=$(dias_desde "$ULT_COLH")
            [ "$DIAS_C" -ge "$INT_C" ] && echo "COLHEITA:$NOME #$ID" >> /tmp/acoes.txt
          done

          # Montar mensagem
          TOTAL=$(jq '.features | length' dados.geojson)

          if [ "$HORA_NUM" -lt 12 ]; then SAUD="â˜€ï¸ Bom dia"
          elif [ "$HORA_NUM" -lt 18 ]; then SAUD="â›… Boa tarde"
          else SAUD="ğŸŒ™ Boa noite"; fi

          MESSAGE="${SAUD}!%0AğŸ“… ${DATA_EXIBICAO} Ã s ${HORA_EXIBICAO}%0A%0A"

          if [ -f /tmp/acoes.txt ]; then
            TOTAL_AC=$(wc -l < /tmp/acoes.txt)
          else
            TOTAL_AC=0
          fi

          if [ "$TOTAL_AC" -eq 0 ]; then
            MESSAGE="${MESSAGE}âœ… *Tudo em dia!*%0AğŸŒ¿ Nenhuma aÃ§Ã£o necessÃ¡ria."
          else
            MESSAGE="${MESSAGE}ğŸ“‹ *AÃ§Ãµes pendentes: ${TOTAL_AC}*%0A%0A"
            while read linha; do
              MESSAGE="${MESSAGE}â€¢ ${linha}%0A"
            done < /tmp/acoes.txt
          fi

          rm -f /tmp/acoes.txt

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"

          echo "NotificaÃ§Ã£o enviada!"

