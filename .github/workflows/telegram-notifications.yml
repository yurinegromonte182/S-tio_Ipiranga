name: Notifica√ß√µes Telegram - Sincroniza√ß√£o Autom√°tica

on:
  push:
    branches:
      - main
    paths:
      - "dados.geojson"

  workflow_dispatch:

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          
      - name: Processar a√ß√µes e notificar Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Instalar jq
          sudo apt-get update
          sudo apt-get install -y jq
          
          # Fuso hor√°rio BR
          export TZ='America/Sao_Paulo'
          
          HOJE=$(date +%Y-%m-%d)
          DATA_EXIBICAO=$(date +%d/%m/%Y)
          HORA_EXIBICAO=$(date +%H:%M)
          HORA_NUM=$(date +%H)
          
          # Fun√ß√£o calcular dias
          dias_desde() {
            if [ -z "$1" ] || [ "$1" = "null" ]; then
              echo 999
            else
              echo $(( ( $(date -d "$HOJE" +%s) - $(date -d "$1" +%s) ) / 86400 ))
            fi
          }
          
          # Intervalos por esp√©cie
          get_intervalo() {
            local especie=$1
            local tipo=$2
            
            case "$tipo" in
              rega)
                case "$especie" in
                  *"Mangabeira"*) echo 7 ;;
                  *"Caju"*) echo 10 ;;
                  *"Coq"*) echo 5 ;;
                  *"Cacau"*) echo 3 ;;
                  *) echo 7 ;;
                esac ;;
                
              poda)
                case "$especie" in
                  *"Mangabeira"*) echo 180 ;;
                  *"Caju"*) echo 365 ;;
                  *"Coq"*) echo 730 ;;
                  *"Cacau"*) echo 180 ;;
                  *) echo 180 ;;
                esac ;;
                
              colheita)
                case "$especie" in
                  *"Mangabeira"*) echo 90 ;;
                  *"Caju"*) echo 60 ;;
                  *"Coq"*) echo 30 ;;
                  *"Cacau"*) echo 120 ;;
                  *) echo 90 ;;
                esac ;;
            esac
          }

          # Reset arquivo tempor√°rio
          rm -f /tmp/acoes.txt
          
          # Analisar cada frut√≠fera
          jq -c '.features[]' dados.geojson | while read -r feature; do
            ID=$(echo "$feature" | jq -r '.properties.ID // .properties.fid // "S/N"')
            NOME=$(echo "$feature" | jq -r '.properties.NOME_POPULAR // .properties.nome_popular // "Planta"')

            ULT_REGA=$(echo "$feature" | jq -r '.properties.ULTIMA_REGA // .properties.ultima_rega // "null"')
            ULT_PODA=$(echo "$feature" | jq -r '.properties.ULTIMA_PODA // .properties.ultima_poda // "null"')
            ULT_COLH=$(echo "$feature" | jq -r '.properties.ULTIMA_COLHEITA // .properties.ultima_colheita // "null"')

            # REGA
            INT_R=$(get_intervalo "$NOME" rega)
            DIAS_R=$(dias_desde "$ULT_REGA")

            if [ "$DIAS_R" -ge $((INT_R + 2)) ]; then
              echo "REGA_URG" >> /tmp/acoes.txt
            elif [ "$DIAS_R" -ge "$INT_R" ]; then
              echo "REGA_NORM" >> /tmp/acoes.txt
            fi

            # PODA
            INT_P=$(get_intervalo "$NOME" poda)
            DIAS_P=$(dias_desde "$ULT_PODA")
            if [ "$DIAS_P" -ge "$INT_P" ]; then
              echo "PODA" >> /tmp/acoes.txt
            fi

            # COLHEITA
            INT_C=$(get_intervalo "$NOME" colheita)
            DIAS_C=$(dias_desde "$ULT_COLH")
            if [ "$DIAS_C" -ge "$INT_C" ]; then
              echo "COLHEITA" >> /tmp/acoes.txt
            fi
          done

          # CONTAGENS
          TOTAL=$(jq '.features | length' dados.geojson)

          URG_COUNT=$(grep -c "REGA_URG" /tmp/acoes.txt 2>/dev/null || echo 0)
          NORM_COUNT=$(grep -c "REGA_NORM" /tmp/acoes.txt 2>/dev/null || echo 0)
          PODA_COUNT=$(grep -c "PODA" /tmp/acoes.txt 2>/dev/null || echo 0)
          COLH_COUNT=$(grep -c "COLHEITA" /tmp/acoes.txt 2>/dev/null || echo 0)

          TOTAL_ATRASADAS=$((URG_COUNT + NORM_COUNT + PODA_COUNT + COLH_COUNT))

          # Sauda√ß√£o
          if [ "$HORA_NUM" -lt 12 ]; then
            SAUDACAO="‚òÄÔ∏è Bom dia"
          elif [ "$HORA_NUM" -lt 18 ]; then
            SAUDACAO="‚õÖ Boa tarde"
          else
            SAUDACAO="üåô Boa noite"
          fi

          # MENSAGEM FINAL (padr√£o EXATO)
          MESSAGE="${SAUDACAO}!%0A"
          MESSAGE="${MESSAGE}üìÖ ${DATA_EXIBICAO} √†s ${HORA_EXIBICAO}%0A%0A"
          MESSAGE="${MESSAGE}üîÑ Atualiza√ß√£o autom√°tica%0A"
          MESSAGE="${MESSAGE}Dados sincronizados do Aplicativo %0A%0A"
          MESSAGE="${MESSAGE}üìã Total de frut√≠feras: (${TOTAL})%0A%0A"
          MESSAGE="${MESSAGE}üö® URGENTE: ${TOTAL_ATRASADAS} a√ß√µes atrasada(s)%0A"
          MESSAGE="${MESSAGE}üíß Rega : $((URG_COUNT + NORM_COUNT)) planta(s)%0A"
          MESSAGE="${MESSAGE}‚úÇÔ∏è Poda: ${PODA_COUNT} planta(s)%0A"
          MESSAGE="${MESSAGE}üçä Colheita: ${COLH_COUNT} planta(s)%0A%0A"
          MESSAGE="${MESSAGE}üí° Veja detalhes no app"

          # ENVIAR TELEGRAM
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"

          echo "Notifica√ß√£o enviada."
          echo "Frut√≠feras: ${TOTAL}"
          echo "Atrasadas: ${TOTAL_ATRASADAS}"
          
      - name: Resumo estat√≠stico (apenas 06h)
        if: github.event.schedule == '0 9 * * *'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          export TZ='America/Sao_Paulo'

          TOTAL=$(jq '.features | length' dados.geojson)
          COQUEIROS=$(jq '[.features[] | select(.properties.NOME_POPULAR=="Coqueiro")] | length' dados.geojson)
          CAJUEIROS=$(jq '[.features[] | select(.properties.NOME_POPULAR=="Cajueiro")] | length' dados.geojson)
          CACAU=$(jq '[.features[] | select(.properties.NOME_POPULAR=="Cacau")] | length' dados.geojson)
          MANGABEIRA=$(jq '[.features[] | select(.properties.NOME_POPULAR=="Mangabeira")] | length' dados.geojson)

          STATS="üìä *Resumo do S√≠tio:*%0A"
          STATS="${STATS}üå≥ Total: ${TOTAL} plantas%0A"
          [ "$COQUEIROS" -gt 0 ] && STATS="${STATS}ü•• Coqueiros: ${COQUEIROS}%0A"
          [ "$CAJUEIROS" -gt 0 ] && STATS="${STATS}üå∞ Cajueiros: ${CAJUEIROS}%0A"
          [ "$CACAU" -gt 0 ] && STATS="${STATS}üç´ Cacau: ${CACAU}%0A"
          [ "$MANGABEIRA" -gt 0 ] && STATS="${STATS}ü•≠ Mangabeira: ${MANGABEIRA}%0A"

          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${STATS}" \
            -d parse_mode="Markdown"
