name: Telegram Notifications - Supabase

on:
  schedule:
    # 06:00 BR = 09:00 UTC
    - cron: '0 9 * * *'
    # 12:00 BR = 15:00 UTC
    - cron: '0 15 * * *'
    # 18:00 BR = 21:00 UTC
    - cron: '0 21 * * *'
  workflow_dispatch:
    inputs:
      tipo_relatorio:
        description: 'Tipo de relat√≥rio'
        required: true
        default: 'diario'
        type: choice
        options:
          - diario
          - completo
          - urgente

jobs:
  fetch-supabase-data:
    runs-on: ubuntu-latest
    outputs:
      total_frutiferas: ${{ steps.count-data.outputs.total_frutiferas }}
      total_species: ${{ steps.count-data.outputs.total_species }}
      pending_actions: ${{ steps.count-data.outputs.pending_actions }}
    steps:
      - name: Buscar dados do Supabase
        id: count-data
        env:
          SUPABASE_URL: "https://erbefbnjxgpetbetlzya.supabase.co"
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          set -e
          
          echo "üîç Testando conex√£o com Supabase..."
          
          # Teste de conex√£o
          TEST_RESPONSE=$(curl -s -w "\n%{http_code}" "$SUPABASE_URL/rest/v1/" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY")
          
          TEST_CODE=$(echo "$TEST_RESPONSE" | tail -n1)
          echo "Status da conex√£o: $TEST_CODE"
          
          if [ "$TEST_CODE" != "200" ]; then
            echo "‚ùå Erro na conex√£o com Supabase"
            exit 1
          fi
          
          echo "‚úÖ Conex√£o OK"
          echo ""
          
          # 1. Contar total de frut√≠feras
          echo "üìä Contando frut√≠feras..."
          RESPONSE=$(curl -s "$SUPABASE_URL/rest/v1/frutiferas?select=id" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY")
          
          echo "Response: $RESPONSE"
          TOTAL_FRUTIFERAS=$(echo "$RESPONSE" | jq '. | length')
          echo "Total de frut√≠feras: $TOTAL_FRUTIFERAS"
          
          # 2. Contar esp√©cies √∫nicas
          echo "üìä Contando esp√©cies..."
          RESPONSE=$(curl -s "$SUPABASE_URL/rest/v1/frutiferas?select=nome_popular" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY")
          
          echo "Response: $RESPONSE"
          TOTAL_SPECIES=$(echo "$RESPONSE" | jq '[.[] | .nome_popular] | unique | length')
          echo "Total de esp√©cies: $TOTAL_SPECIES"
          
          # 3. Verificar a√ß√µes pendentes (ultima_rega > 7 dias)
          echo "üìä Verificando a√ß√µes pendentes..."
          DAYS_AGO=$(date -u -d "7 days ago" +%Y-%m-%d)
          echo "Data de refer√™ncia: $DAYS_AGO"
          
          RESPONSE=$(curl -s "$SUPABASE_URL/rest/v1/frutiferas?select=id&ultima_rega=lt.$DAYS_AGO" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY")
          
          echo "Response: $RESPONSE"
          PENDING_ACTIONS=$(echo "$RESPONSE" | jq '. | length')
          echo "A√ß√µes pendentes: $PENDING_ACTIONS"
          
          # Garantir valores v√°lidos
          TOTAL_FRUTIFERAS=${TOTAL_FRUTIFERAS:-0}
          TOTAL_SPECIES=${TOTAL_SPECIES:-0}
          PENDING_ACTIONS=${PENDING_ACTIONS:-0}
          
          # Salvar outputs
          echo "total_frutiferas=$TOTAL_FRUTIFERAS" >> $GITHUB_OUTPUT
          echo "total_species=$TOTAL_SPECIES" >> $GITHUB_OUTPUT
          echo "pending_actions=$PENDING_ACTIONS" >> $GITHUB_OUTPUT
          
          echo ""
          echo "‚úÖ Dados coletados com sucesso!"
          echo "  üå≥ Frut√≠feras: $TOTAL_FRUTIFERAS"
          echo "  üè∑Ô∏è Esp√©cies: $TOTAL_SPECIES"
          echo "  ‚ö†Ô∏è Pendentes: $PENDING_ACTIONS"

  send-telegram-report:
    runs-on: ubuntu-latest
    needs: fetch-supabase-data
    steps:
      - name: Enviar relat√≥rio para Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -e
          
          echo "üì± Preparando mensagem para Telegram..."
          
          # Definir tipo de relat√≥rio
          TIPO_RELATORIO="${{ github.event.inputs.tipo_relatorio }}"
          if [ -z "$TIPO_RELATORIO" ]; then
            TIPO_RELATORIO="Autom√°tico"
          fi
          
          # Criar mensagem
          MESSAGE="üåø *RELAT√ìRIO S√çTIO IPIRANGA* üåø

üìä *Dados do Sistema:*
üå≥ *Frut√≠feras:* ${{ needs.fetch-supabase-data.outputs.total_frutiferas }}
üè∑Ô∏è *Esp√©cies:* ${{ needs.fetch-supabase-data.outputs.total_species }}
‚ö†Ô∏è *A√ß√µes Pendentes:* ${{ needs.fetch-supabase-data.outputs.pending_actions }}

‚è∞ *Hor√°rio:* $(TZ='America/Fortaleza' date '+%d/%m/%Y %H:%M')
üîÑ *Tipo:* $TIPO_RELATORIO

üì° *Status:* ‚úÖ Conectado ao Supabase
üó∫Ô∏è *SIGWEB:* Operacional"
          
          echo "Mensagem preparada:"
          echo "$MESSAGE"
          echo ""
          
          # Enviar para Telegram
          echo "üì§ Enviando para Telegram..."
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            --data-urlencode text="$MESSAGE" \
            -d parse_mode="Markdown")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "Status HTTP: $HTTP_CODE"
          echo "Response: $RESPONSE_BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Relat√≥rio enviado para Telegram com sucesso!"
          else
            echo "‚ùå Erro ao enviar para Telegram"
            echo "$RESPONSE_BODY"
            exit 1
          fi

  log-to-supabase:
    runs-on: ubuntu-latest
    needs: [fetch-supabase-data, send-telegram-report]
    if: always()
    steps:
      - name: Registrar execu√ß√£o no Supabase
        env:
          SUPABASE_URL: "https://erbefbnjxgpetbetlzya.supabase.co"
          SUPABASE_SERVICE_KEY: ${{ secrets.SUPABASE_SERVICE_KEY }}
        run: |
          echo "üìù Registrando log no Supabase..."
          
          # Preparar dados
          TIPO_RELATORIO="${{ github.event.inputs.tipo_relatorio }}"
          if [ -z "$TIPO_RELATORIO" ]; then
            TIPO_RELATORIO="autom√°tico"
          fi
          
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
          
          # Criar JSON
          JSON_DATA=$(cat <<EOF
{
  "tipo": "$TIPO_RELATORIO",
  "total_frutiferas": ${{ needs.fetch-supabase-data.outputs.total_frutiferas }},
  "especies": ${{ needs.fetch-supabase-data.outputs.total_species }},
  "acoes_pendentes": ${{ needs.fetch-supabase-data.outputs.pending_actions }},
  "executado_em": "$TIMESTAMP"
}
EOF
)
          
          echo "JSON a ser enviado:"
          echo "$JSON_DATA"
          echo ""
          
          # Inserir no Supabase
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
            "$SUPABASE_URL/rest/v1/telegram_logs" \
            -H "apikey: $SUPABASE_SERVICE_KEY" \
            -H "Authorization: Bearer $SUPABASE_SERVICE_KEY" \
            -H "Content-Type: application/json" \
            -H "Prefer: return=minimal" \
            -d "$JSON_DATA")
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | head -n-1)
          
          echo "Status HTTP: $HTTP_CODE"
          
          if [ "$HTTP_CODE" = "201" ] || [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Log registrado no Supabase com sucesso!"
          else
            echo "‚ö†Ô∏è Erro ao registrar log (HTTP $HTTP_CODE)"
            echo "Response: $RESPONSE_BODY"
          fi
