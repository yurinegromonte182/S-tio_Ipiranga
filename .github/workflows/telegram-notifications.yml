name: Notifica√ß√µes Telegram - Sincroniza√ß√£o Autom√°tica (PostgreSQL)

on:
  push:
    branches:
      - main
  schedule:
    # 06:00 BR = 09:00 UTC
    - cron: '0 9 * * *'
    # 12:00 BR = 15:00 UTC
    - cron: '0 15 * * *'
    # 18:00 BR = 21:00 UTC
    - cron: '0 21 * * *'
  workflow_dispatch:

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client jq
          
      - name: Processar a√ß√µes e notificar Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          PGHOST: aws-1-us-east-1.pooler.supabase.com
          PGPORT: 6543
          PGDATABASE: postgres
          PGUSER: postgres.erbefbnjxgpetbetlzya
        run: |
          # Configurar fuso hor√°rio de Bras√≠lia
          export TZ='America/Sao_Paulo'
          
          # Data atual no hor√°rio de Bras√≠lia
          HOJE=$(date +%Y-%m-%d)
          DATA_EXIBICAO=$(date +%d/%m/%Y)
          HORA_EXIBICAO=$(date +%H:%M)
          HORA_NUM=$(date +%H)
          
          # Fun√ß√£o para calcular dias
          dias_desde() {
            if [ -z "$1" ] || [ "$1" = "null" ]; then
              echo "999"
            else
              echo $(( ( $(date -d "$HOJE" +%s) - $(date -d "$1" +%s) ) / 86400 ))
            fi
          }
          
          # Fun√ß√£o para obter intervalo
          get_intervalo() {
            local especie=$1
            local tipo=$2
            local valor=""
            
            case "$tipo" in
              "rega")
                case "$especie" in
                  *"Mangabeira"*) valor=7 ;;
                  *"Caju"*) valor=10 ;;
                  *"Coq"*) valor=5 ;;
                  *"Cacau"*) valor=3 ;;
                  *) valor=7 ;;
                esac
                ;;
              "poda")
                case "$especie" in
                  *"Mangabeira"*) valor=180 ;;
                  *"Caju"*) valor=365 ;;
                  *"Coq"*) valor=730 ;;
                  *"Cacau"*) valor=180 ;;
                  *) valor=180 ;;
                esac
                ;;
              "colheita")
                case "$especie" in
                  *"Mangabeira"*) valor=90 ;;
                  *"Caju"*) valor=60 ;;
                  *"Coq"*) valor=30 ;;
                  *"Cacau"*) valor=120 ;;
                  *) valor=90 ;;
                esac
                ;;
            esac
            
            echo "$valor"
          }
          
          # Buscar dados do banco
          echo "Conectando ao PostgreSQL..."
          psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -t -A -F"," \
            -c "SELECT 
                  COALESCE(id::text, fid::text, 'S/N') as id,
                  COALESCE(nome_popular, 'Planta') as nome,
                  COALESCE(ultima_rega::text, 'null') as ultima_rega,
                  COALESCE(ultima_poda::text, 'null') as ultima_poda,
                  COALESCE(ultima_colheita::text, 'null') as ultima_colheita
                FROM frutiferas
                ORDER BY id;" > /tmp/plantas.csv
          
          if [ ! -s /tmp/plantas.csv ]; then
            echo "Erro: N√£o foi poss√≠vel buscar dados do banco"
            exit 1
          fi
          
          # Processar cada planta
          while IFS=',' read -r ID NOME ULT_REGA ULT_PODA ULT_COLH; do
            # Verificar rega
            INT_R=$(get_intervalo "$NOME" "rega")
            DIAS_R=$(dias_desde "$ULT_REGA")
            
            if [ "$DIAS_R" -ge $((INT_R + 2)) ]; then
              echo "REGA_URG:$NOME #$ID - Atrasada $DIAS_R dias" >> /tmp/acoes.txt
            elif [ "$DIAS_R" -ge "$INT_R" ]; then
              if [ "$ULT_REGA" = "null" ]; then
                echo "REGA_NORM:$NOME #$ID - Nunca foi regada" >> /tmp/acoes.txt
              else
                echo "REGA_NORM:$NOME #$ID - H√° $DIAS_R dias sem regar" >> /tmp/acoes.txt
              fi
            fi
            
            # Verificar poda
            INT_P=$(get_intervalo "$NOME" "poda")
            DIAS_P=$(dias_desde "$ULT_PODA")
            
            if [ "$DIAS_P" -ge "$INT_P" ]; then
              if [ "$ULT_PODA" = "null" ]; then
                echo "PODA:$NOME #$ID - Nunca foi podada" >> /tmp/acoes.txt
              else
                echo "PODA:$NOME #$ID - H√° $DIAS_P dias sem poda" >> /tmp/acoes.txt
              fi
            fi
            
            # Verificar colheita
            INT_C=$(get_intervalo "$NOME" "colheita")
            DIAS_C=$(dias_desde "$ULT_COLH")
            
            if [ "$DIAS_C" -ge "$INT_C" ]; then
              if [ "$ULT_COLH" = "null" ]; then
                echo "COLHEITA:$NOME #$ID - Verificar frutos" >> /tmp/acoes.txt
              else
                echo "COLHEITA:$NOME #$ID - H√° $DIAS_C dias sem colheita" >> /tmp/acoes.txt
              fi
            fi
          done < /tmp/plantas.csv
          
          # Contar total de plantas
          TOTAL=$(wc -l < /tmp/plantas.csv)
          
          # Sauda√ß√£o por hor√°rio (hor√°rio de Bras√≠lia)
          if [ "$HORA_NUM" -lt 12 ]; then
            SAUDACAO="‚òÄÔ∏è Bom dia"
          elif [ "$HORA_NUM" -lt 18 ]; then
            SAUDACAO="‚õÖ Boa tarde"
          else
            SAUDACAO="üåô Boa noite"
          fi
          
          MESSAGE="${SAUDACAO}!%0A"
          MESSAGE="${MESSAGE}üìÖ ${DATA_EXIBICAO} √†s ${HORA_EXIBICAO}%0A%0A"
          
          # Contar a√ß√µes
          if [ -f /tmp/acoes.txt ]; then
            TOTAL_ACOES=$(wc -l < /tmp/acoes.txt)
          else
            TOTAL_ACOES=0
          fi
          
          # Detectar se foi acionado por commit (push)
          if [ "${{ github.event_name }}" = "push" ]; then
            MESSAGE="${MESSAGE}üìÑ *Atualiza√ß√£o autom√°tica*%0A"
            MESSAGE="${MESSAGE}Dados sincronizados do banco%0A%0A"
          fi
          
          if [ "$TOTAL_ACOES" -eq 0 ]; then
            MESSAGE="${MESSAGE}‚úÖ *Tudo em dia!*%0A"
            MESSAGE="${MESSAGE}Nenhuma a√ß√£o necess√°ria. üåø%0A%0A"
            MESSAGE="${MESSAGE}üìä Total: ${TOTAL} plantas cadastradas"
          else
            MESSAGE="${MESSAGE}üìã *A√ß√µes: ${TOTAL_ACOES}*%0A%0A"
            
            # Contar por tipo
            URG_COUNT=$(grep -c "^REGA_URG:" /tmp/acoes.txt 2>/dev/null || echo 0)
            NORM_COUNT=$(grep -c "^REGA_NORM:" /tmp/acoes.txt 2>/dev/null || echo 0)
            PODA_COUNT=$(grep -c "^PODA:" /tmp/acoes.txt 2>/dev/null || echo 0)
            COLH_COUNT=$(grep -c "^COLHEITA:" /tmp/acoes.txt 2>/dev/null || echo 0)
            
            # Mostrar apenas resumo se muitas a√ß√µes
            if [ "$TOTAL_ACOES" -gt 15 ]; then
              [ "$URG_COUNT" -gt 0 ] && MESSAGE="${MESSAGE}üö® URGENTE: ${URG_COUNT} rega(s) atrasada(s)%0A"
              [ "$NORM_COUNT" -gt 0 ] && MESSAGE="${MESSAGE}üíß Rega: ${NORM_COUNT} planta(s)%0A"
              [ "$PODA_COUNT" -gt 0 ] && MESSAGE="${MESSAGE}‚úÇÔ∏è Poda: ${PODA_COUNT} planta(s)%0A"
              [ "$COLH_COUNT" -gt 0 ] && MESSAGE="${MESSAGE}üçä Colheita: ${COLH_COUNT} planta(s)%0A"
              MESSAGE="${MESSAGE}%0Aüí° Veja detalhes no app"
            else
              # Mostrar detalhes (m√°ximo 15 a√ß√µes)
              CONTADOR=0
              
              # Urgentes primeiro
              if [ "$URG_COUNT" -gt 0 ]; then
                MESSAGE="${MESSAGE}üö® *URGENTE:*%0A"
                while IFS=: read -r tipo texto; do
                  if [ "$tipo" = "REGA_URG" ]; then
                    MESSAGE="${MESSAGE}‚Ä¢ ${texto}%0A"
                    CONTADOR=$((CONTADOR + 1))
                  fi
                done < /tmp/acoes.txt
                MESSAGE="${MESSAGE}%0A"
              fi
              
              # Rega normal
              if [ "$NORM_COUNT" -gt 0 ] && [ "$CONTADOR" -lt 15 ]; then
                MESSAGE="${MESSAGE}üíß *Rega:*%0A"
                while IFS=: read -r tipo texto; do
                  if [ "$tipo" = "REGA_NORM" ] && [ "$CONTADOR" -lt 15 ]; then
                    MESSAGE="${MESSAGE}‚Ä¢ ${texto}%0A"
                    CONTADOR=$((CONTADOR + 1))
                  fi
                done < /tmp/acoes.txt
                MESSAGE="${MESSAGE}%0A"
              fi
              
              # Poda
              if [ "$PODA_COUNT" -gt 0 ] && [ "$CONTADOR" -lt 15 ]; then
                MESSAGE="${MESSAGE}‚úÇÔ∏è *Poda:*%0A"
                while IFS=: read -r tipo texto; do
                  if [ "$tipo" = "PODA" ] && [ "$CONTADOR" -lt 15 ]; then
                    MESSAGE="${MESSAGE}‚Ä¢ ${texto}%0A"
                    CONTADOR=$((CONTADOR + 1))
                  fi
                done < /tmp/acoes.txt
                MESSAGE="${MESSAGE}%0A"
              fi
              
              # Colheita
              if [ "$COLH_COUNT" -gt 0 ] && [ "$CONTADOR" -lt 15 ]; then
                MESSAGE="${MESSAGE}üçä *Colheita:*%0A"
                while IFS=: read -r tipo texto; do
                  if [ "$tipo" = "COLHEITA" ] && [ "$CONTADOR" -lt 15 ]; then
                    MESSAGE="${MESSAGE}‚Ä¢ ${texto}%0A"
                    CONTADOR=$((CONTADOR + 1))
                  fi
                done < /tmp/acoes.txt
              fi
            fi
          fi
          
          # Limpar arquivos tempor√°rios
          rm -f /tmp/acoes.txt /tmp/plantas.csv
          
          # Enviar notifica√ß√£o
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"
          
          echo "Notifica√ß√£o enviada com sucesso!"
          echo "Hor√°rio: ${DATA_EXIBICAO} √†s ${HORA_EXIBICAO} (Bras√≠lia)"
          
      - name: Resumo estat√≠stico (apenas 06h)
        if: github.event.schedule == '0 9 * * *'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          PGPASSWORD: ${{ secrets.SUPABASE_DB_PASSWORD }}
          PGHOST: aws-1-us-east-1.pooler.supabase.com
          PGPORT: 6543
          PGDATABASE: postgres
          PGUSER: postgres.erbefbnjxgpetbetlzya
        run: |
          # Configurar fuso hor√°rio de Bras√≠lia
          export TZ='America/Sao_Paulo'
          
          # Estat√≠sticas gerais
          STATS=$(psql -t -A -c "SELECT 
            COUNT(*) as total,
            COUNT(*) FILTER (WHERE nome_popular = 'Coqueiro') as coqueiros,
            COUNT(*) FILTER (WHERE nome_popular = 'Cajueiro') as cajueiros,
            COUNT(*) FILTER (WHERE nome_popular = 'Cacau') as cacau,
            COUNT(*) FILTER (WHERE nome_popular = 'Mangabeira') as mangabeira
          FROM frutiferas;")
          
          IFS='|' read -r TOTAL COQUEIROS CAJUEIROS CACAU MANGABEIRA <<< "$STATS"
          
          MESSAGE="üìä *Resumo do S√≠tio:*%0A"
          MESSAGE="${MESSAGE}üå≥ Total: ${TOTAL} plantas%0A"
          [ "$COQUEIROS" -gt 0 ] && MESSAGE="${MESSAGE}ü•• Coqueiros: ${COQUEIROS}%0A"
          [ "$CAJUEIROS" -gt 0 ] && MESSAGE="${MESSAGE}üå∞ Cajueiros: ${CAJUEIROS}%0A"
          [ "$CACAU" -gt 0 ] && MESSAGE="${MESSAGE}üç´ Cacau: ${CACAU}%0A"
          [ "$MANGABEIRA" -gt 0 ] && MESSAGE="${MESSAGE}ü•≠ Mangabeira: ${MANGABEIRA}%0A"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"
