name: Notifica√ß√µes Telegram - S√≠tio Ipiranga

on:
  push:
    branches:
      - main
    paths:
      - 'dados.geojson'
  schedule:
    # 06:00 BR = 09:00 UTC
    - cron: '0 9 * * *'
    # 12:00 BR = 15:00 UTC
    - cron: '0 15 * * *'
    # 18:00 BR = 21:00 UTC
    - cron: '0 21 * * *'
  workflow_dispatch:

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Verificar se existe dados.geojson
        id: check_file
        run: |
          if [ -f "dados.geojson" ]; then
            echo "‚úÖ Arquivo dados.geojson encontrado"
            echo "file_exists=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è Arquivo dados.geojson n√£o encontrado"
            echo "file_exists=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Processar a√ß√µes das plantas
        if: steps.check_file.outputs.file_exists == 'true'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Instalar jq para processar JSON
          sudo apt-get update -y
          sudo apt-get install -y jq
          
          # Data atual
          HOJE=$(date +%Y-%m-%d)
          DATA_EXIBICAO=$(date +"%d/%m/%Y")
          HORA_EXIBICAO=$(date +"%H:%M")
          
          # Fun√ß√£o para calcular dias desde uma data
          dias_desde() {
            if [ -z "$1" ] || [ "$1" = "null" ] || [ "$1" = "" ]; then
              echo "999"
            else
              data_sec=$(date -d "$1" +%s 2>/dev/null || echo "0")
              hoje_sec=$(date -d "$HOJE" +%s)
              if [ "$data_sec" -eq "0" ]; then
                echo "999"
              else
                echo $(( (hoje_sec - data_sec) / 86400 ))
              fi
            fi
          }
          
          # Fun√ß√£o para normalizar texto
          normalizar_texto() {
            echo "$1" | tr '[:upper:]' '[:lower:]' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//'
          }
          
          # Processar cada planta
          TOTAL_PLANTAS=$(jq '.features | length' dados.geojson 2>/dev/null || echo "0")
          
          # Sauda√ß√£o por hor√°rio
          HORA_NUM=$(date +%H)
          if [ "$HORA_NUM" -lt 12 ]; then
            SAUDACAO="‚òÄÔ∏è Bom dia"
          elif [ "$HORA_NUM" -lt 18 ]; then
            SAUDACAO="‚õÖ Boa tarde"
          else
            SAUDACAO="üåô Boa noite"
          fi
          
          # Iniciar mensagem
          MESSAGE="${SAUDACAO}!%0A"
          MESSAGE="${MESSAGE}üåø *S√≠tio Ipiranga*%0A"
          MESSAGE="${MESSAGE}üìÖ ${DATA_EXIBICAO} √†s ${HORA_EXIBICAO}%0A%0A"
          MESSAGE="${MESSAGE}üå≥ *${TOTAL_PLANTAS} plantas* cadastradas%0A%0A"
          
          # Arrays para a√ß√µes
          REGA_URGENTE=""
          REGA_NORMAL=""
          PODA_PENDENTE=""
          COLHEITA_PENDENTE=""
          TOTAL_ACOES=0
          
          # Processar cada planta
          if [ "$TOTAL_PLANTAS" -gt 0 ]; then
            jq -c '.features[]' dados.geojson 2>/dev/null | while read -r feature; do
              # Extrair dados com tratamento de erro
              ID=$(echo "$feature" | jq -r '.properties.id // .properties.fid // .properties.ID // "S/N"' 2>/dev/null || echo "S/N")
              NOME=$(echo "$feature" | jq -r '.properties.nome_popular // .properties.nome_popular // "Planta sem nome"' 2>/dev/null || echo "Planta sem nome")
              ULT_REGA=$(echo "$feature" | jq -r '.properties.ultima_rega // .properties.ultima_rega // "null"' 2>/dev/null || echo "null")
              ULT_PODA=$(echo "$feature" | jq -r '.properties.ultima_poda // .properties.ultima_poda // "null"' 2>/dev/null || echo "null")
              ULT_COLH=$(echo "$feature" | jq -r '.properties.ultima_colheita // .properties.ultima_colheita // "null"' 2>/dev/null || echo "null")
              
              # Normalizar nome
              NOME_NORM=$(normalizar_texto "$NOME")
              
              # Definir intervalos
              REGA_INT=7
              PODA_INT=180
              COLHEITA_INT=90
              
              if echo "$NOME_NORM" | grep -q "mangabeira"; then
                REGA_INT=7
                PODA_INT=180
                COLHEITA_INT=90
              elif echo "$NOME_NORM" | grep -q "caju"; then
                REGA_INT=10
                PODA_INT=365
                COLHEITA_INT=60
              elif echo "$NOME_NORM" | grep -q "coq"; then
                REGA_INT=5
                PODA_INT=730
                COLHEITA_INT=30
              elif echo "$NOME_NORM" | grep -q "cacau"; then
                REGA_INT=3
                PODA_INT=180
                COLHEITA_INT=120
              fi
              
              # Verificar rega
              DIAS_REGA=$(dias_desde "$ULT_REGA")
              if [ "$DIAS_REGA" -ge $((REGA_INT + 2)) ]; then
                REGA_URGENTE="${REGA_URGENTE}‚Ä¢ üö® ${NOME} #${ID} - ${DIAS_REGA} dias sem regar%0A"
                TOTAL_ACOES=$((TOTAL_ACOES + 1))
              elif [ "$DIAS_REGA" -ge "$REGA_INT" ]; then
                REGA_NORMAL="${REGA_NORMAL}‚Ä¢ üíß ${NOME} #${ID} - ${DIAS_REGA} dias%0A"
                TOTAL_ACOES=$((TOTAL_ACOES + 1))
              fi
              
              # Verificar poda
              DIAS_PODA=$(dias_desde "$ULT_PODA")
              if [ "$DIAS_PODA" -ge "$PODA_INT" ]; then
                PODA_PENDENTE="${PODA_PENDENTE}‚Ä¢ ‚úÇÔ∏è ${NOME} #${ID} - ${DIAS_PODA} dias%0A"
                TOTAL_ACOES=$((TOTAL_ACOES + 1))
              fi
              
              # Verificar colheita
              DIAS_COLH=$(dias_desde "$ULT_COLH")
              if [ "$DIAS_COLH" -ge "$COLHEITA_INT" ]; then
                COLHEITA_PENDENTE="${COLHEITA_PENDENTE}‚Ä¢ üçé ${NOME} #${ID} - ${DIAS_COLH} dias%0A"
                TOTAL_ACOES=$((TOTAL_ACOES + 1))
              fi
            done
          fi
          
          # Montar mensagem final
          if [ "$TOTAL_ACOES" -eq 0 ]; then
            MESSAGE="${MESSAGE}‚úÖ *Tudo em dia!*%0ANenhuma a√ß√£o pendente.%0A%0Aüå± Continue o bom trabalho!"
          else
            MESSAGE="${MESSAGE}üìã *${TOTAL_ACOES} a√ß√£o(√µes) pendente(s):*%0A%0A"
            
            if [ -n "$REGA_URGENTE" ]; then
              MESSAGE="${MESSAGE}üö® *REGA URGENTE:*%0A${REGA_URGENTE}%0A"
            fi
            
            if [ -n "$REGA_NORMAL" ]; then
              MESSAGE="${MESSAGE}üíß *Rega normal:*%0A${REGA_NORMAL}%0A"
            fi
            
            if [ -n "$PODA_PENDENTE" ]; then
              MESSAGE="${MESSAGE}‚úÇÔ∏è *Poda pendente:*%0A${PODA_PENDENTE}%0A"
            fi
            
            if [ -n "$COLHEITA_PENDENTE" ]; then
              MESSAGE="${MESSAGE}üçé *Colheita pendente:*%0A${COLHEITA_PENDENTE}%0A"
            fi
          fi
          
          MESSAGE="${MESSAGE}%0Aüì± *Acesse o app:*%0Ahttps://yurimegromonte182.github.io/S-tio_Jintanga/"
          
          # Enviar para Telegram (s√≥ se tem token configurado)
          if [ -n "$TELEGRAM_BOT_TOKEN" ] && [ -n "$TELEGRAM_CHAT_ID" ]; then
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="${MESSAGE}" \
              -d parse_mode="Markdown"
            echo "‚úÖ Notifica√ß√£o enviada para Telegram"
          else
            echo "‚ö†Ô∏è Token ou Chat ID n√£o configurados"
            echo "Mensagem que seria enviada:"
            echo "---"
            echo -e "${MESSAGE//%0A/\\n}"
            echo "---"
          fi
          
      - name: Notificar se n√£o h√° dados
        if: steps.check_file.outputs.file_exists == 'false'
        run: |
          echo "‚ö†Ô∏è Arquivo dados.geojson n√£o encontrado no reposit√≥rio"
          echo "Para receber notifica√ß√µes, adicione o arquivo dados.geojson na raiz"
