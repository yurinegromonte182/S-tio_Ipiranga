name: üåø S√≠tio Ipiranga - Notifica√ß√µes

on:
  push:
    branches:
      - main
    paths:
      - 'dados.geojson'
  schedule:
    # 06:00 BR = 09:00 UTC
    - cron: '0 9 * * *'
    # 12:00 BR = 15:00 UTC
    - cron: '0 15 * * *'
    # 18:00 BR = 21:00 UTC
    - cron: '0 21 * * *'
  workflow_dispatch:

jobs:
  notificar-telegram:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Checkout do reposit√≥rio
        uses: actions/checkout@v4
        
      - name: üîß Instalar depend√™ncias
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl
          
      - name: üìä Processar dados e enviar notifica√ß√£o
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -e
          
          echo "=== INICIANDO PROCESSAMENTO ==="
          
          # Verificar se o arquivo existe
          if [ ! -f "dados.geojson" ]; then
            echo "‚ö†Ô∏è Arquivo dados.geojson n√£o encontrado"
            
            MENSAGEM="üåø S√≠tio Ipiranga%0A"
            MENSAGEM="${MENSAGEM}üìÖ $(date '+%d/%m/%Y √†s %H:%M')%0A%0A"
            MENSAGEM="${MENSAGEM}‚ö†Ô∏è AVISO: Arquivo de dados n√£o encontrado%0A"
            MENSAGEM="${MENSAGEM}%0AExporte os dados do QField e fa√ßa upload no reposit√≥rio.%0A"
            MENSAGEM="${MENSAGEM}%0Aüì± Acesse: https://yurimegromonte182.github.io/S-tio_Ipiranga/"
            
            curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d text="${MENSAGEM}"
            
            echo "‚úÖ Mensagem de aviso enviada"
            exit 0
          fi
          
          echo "‚úÖ Arquivo dados.geojson encontrado"
          
          # Validar JSON
          if ! jq empty dados.geojson 2>/dev/null; then
            echo "‚ùå Erro: arquivo JSON inv√°lido"
            exit 1
          fi
          
          # Data e hora atual
          HOJE=$(date +%Y-%m-%d)
          DATA_BR=$(date '+%d/%m/%Y')
          HORA_BR=$(date '+%H:%M')
          
          # Fun√ß√£o para calcular dias desde uma data
          dias_desde() {
            if [ -z "$1" ] || [ "$1" = "null" ]; then
              echo "999"
            else
              echo $(( ( $(date -d "$HOJE" +%s) - $(date -d "$1" +%s) ) / 86400 ))
            fi
          }
          
          # Normalizar texto
          normalizar() {
            echo "$1" | tr '[:upper:]' '[:lower:]' | sed 's/^ *//;s/ *$//'
          }
          
          # Obter intervalos por esp√©cie
          get_intervalo() {
            local especie=$(normalizar "$1")
            local tipo=$2
            
            case "$tipo" in
              "rega")
                case "$especie" in
                  *"mangabeira"*) echo 7 ;;
                  *"caju"*) echo 10 ;;
                  *"coq"*) echo 5 ;;
                  *"cacau"*) echo 3 ;;
                  *) echo 7 ;;
                esac
                ;;
              "poda")
                case "$especie" in
                  *"mangabeira"*) echo 180 ;;
                  *"caju"*) echo 365 ;;
                  *"coq"*) echo 730 ;;
                  *"cacau"*) echo 180 ;;
                  *) echo 180 ;;
                esac
                ;;
              "colheita")
                case "$especie" in
                  *"mangabeira"*) echo 90 ;;
                  *"caju"*) echo 60 ;;
                  *"coq"*) echo 30 ;;
                  *"cacau"*) echo 120 ;;
                  *) echo 90 ;;
                esac
                ;;
            esac
          }
          
          # Limpar arquivo tempor√°rio
          rm -f /tmp/acoes.txt
          
          # Processar cada planta
          echo "üìã Processando plantas..."
          jq -c '.features[]' dados.geojson | while read -r feature; do
            ID=$(echo "$feature" | jq -r '.properties.id // .properties.fid // "SN"')
            NOME=$(echo "$feature" | jq -r '.properties.nome_popular // .properties.especie // "Planta"')
            ULT_REGA=$(echo "$feature" | jq -r '.properties.ultima_rega // "null"')
            ULT_PODA=$(echo "$feature" | jq -r '.properties.ultima_poda // "null"')
            ULT_COLH=$(echo "$feature" | jq -r '.properties.ultima_colheita // "null"')
            
            NOME_NORM=$(normalizar "$NOME")
            
            # Verificar rega
            INT_R=$(get_intervalo "$NOME_NORM" "rega")
            DIAS_R=$(dias_desde "$ULT_REGA")
            
            if [ "$DIAS_R" -ge $((INT_R + 2)) ]; then
              echo "REGA_URG:$NOME #$ID|Atrasada $DIAS_R dias" >> /tmp/acoes.txt
            elif [ "$DIAS_R" -ge "$INT_R" ]; then
              if [ "$ULT_REGA" = "null" ]; then
                echo "REGA_NORM:$NOME #$ID|Nunca regada" >> /tmp/acoes.txt
              else
                echo "REGA_NORM:$NOME #$ID|Ha $DIAS_R dias" >> /tmp/acoes.txt
              fi
            fi
            
            # Verificar poda
            INT_P=$(get_intervalo "$NOME_NORM" "poda")
            DIAS_P=$(dias_desde "$ULT_PODA")
            
            if [ "$DIAS_P" -ge "$INT_P" ]; then
              if [ "$ULT_PODA" = "null" ]; then
                echo "PODA:$NOME #$ID|Nunca podada" >> /tmp/acoes.txt
              else
                echo "PODA:$NOME #$ID|Ha $DIAS_P dias" >> /tmp/acoes.txt
              fi
            fi
            
            # Verificar colheita
            INT_C=$(get_intervalo "$NOME_NORM" "colheita")
            DIAS_C=$(dias_desde "$ULT_COLH")
            
            if [ "$DIAS_C" -ge "$INT_C" ]; then
              if [ "$ULT_COLH" = "null" ]; then
                echo "COLHEITA:$NOME #$ID|Verificar frutos" >> /tmp/acoes.txt
              else
                echo "COLHEITA:$NOME #$ID|Ha $DIAS_C dias" >> /tmp/acoes.txt
              fi
            fi
          done
          
          # Contar total de plantas
          TOTAL=$(jq '.features | length' dados.geojson)
          
          # Sauda√ß√£o por hor√°rio
          HORA_NUM=$(date +%H)
          if [ "$HORA_NUM" -lt 12 ]; then
            SAUDACAO="‚òÄÔ∏è Bom dia"
          elif [ "$HORA_NUM" -lt 18 ]; then
            SAUDACAO="‚õÖ Boa tarde"
          else
            SAUDACAO="üåô Boa noite"
          fi
          
          # Montar mensagem
          MENSAGEM="${SAUDACAO}!%0A"
          MENSAGEM="${MENSAGEM}üìÖ ${DATA_BR} √†s ${HORA_BR}%0A"
          MENSAGEM="${MENSAGEM}üå≥ ${TOTAL} plantas no sistema%0A%0A"
          
          # Contar a√ß√µes
          if [ -f /tmp/acoes.txt ]; then
            TOTAL_ACOES=$(wc -l < /tmp/acoes.txt)
          else
            TOTAL_ACOES=0
          fi
          
          if [ "$TOTAL_ACOES" -eq 0 ]; then
            MENSAGEM="${MENSAGEM}‚úÖ *Tudo em dia!*%0A"
            MENSAGEM="${MENSAGEM}Nenhuma a√ß√£o necess√°ria hoje. üåø"
          else
            URG_COUNT=$(grep -c "^REGA_URG:" /tmp/acoes.txt 2>/dev/null || echo 0)
            NORM_COUNT=$(grep -c "^REGA_NORM:" /tmp/acoes.txt 2>/dev/null || echo 0)
            PODA_COUNT=$(grep -c "^PODA:" /tmp/acoes.txt 2>/dev/null || echo 0)
            COLH_COUNT=$(grep -c "^COLHEITA:" /tmp/acoes.txt 2>/dev/null || echo 0)
            
            MENSAGEM="${MENSAGEM}üìã *${TOTAL_ACOES} a√ß√µes pendentes*%0A%0A"
            
            # Mostrar resumo se muitas a√ß√µes
            if [ "$TOTAL_ACOES" -gt 12 ]; then
              [ "$URG_COUNT" -gt 0 ] && MENSAGEM="${MENSAGEM}üö® *URGENTE:* ${URG_COUNT} rega(s) atrasada(s)%0A"
              [ "$NORM_COUNT" -gt 0 ] && MENSAGEM="${MENSAGEM}üíß *Rega:* ${NORM_COUNT} planta(s)%0A"
              [ "$PODA_COUNT" -gt 0 ] && MENSAGEM="${MENSAGEM}‚úÇÔ∏è *Poda:* ${PODA_COUNT} planta(s)%0A"
              [ "$COLH_COUNT" -gt 0 ] && MENSAGEM="${MENSAGEM}üçä *Colheita:* ${COLH_COUNT} planta(s)%0A"
              MENSAGEM="${MENSAGEM}%0Aüí° Veja detalhes no app"
            else
              CONTADOR=0
              
              # Urgentes primeiro
              if [ "$URG_COUNT" -gt 0 ]; then
                MENSAGEM="${MENSAGEM}üö® *URGENTE:*%0A"
                while IFS='|' read -r tipo_planta descricao; do
                  tipo=$(echo "$tipo_planta" | cut -d: -f1)
                  planta=$(echo "$tipo_planta" | cut -d: -f2)
                  if [ "$tipo" = "REGA_URG" ] && [ "$CONTADOR" -lt 12 ]; then
                    MENSAGEM="${MENSAGEM}‚Ä¢ ${planta} - ${descricao}%0A"
                    CONTADOR=$((CONTADOR + 1))
                  fi
                done < /tmp/acoes.txt
                MENSAGEM="${MENSAGEM}%0A"
              fi
              
              # Rega normal
              if [ "$NORM_COUNT" -gt 0 ] && [ "$CONTADOR" -lt 12 ]; then
                MENSAGEM="${MENSAGEM}üíß *Rega:*%0A"
                while IFS='|' read -r tipo_planta descricao; do
                  tipo=$(echo "$tipo_planta" | cut -d: -f1)
                  planta=$(echo "$tipo_planta" | cut -d: -f2)
                  if [ "$tipo" = "REGA_NORM" ] && [ "$CONTADOR" -lt 12 ]; then
                    MENSAGEM="${MENSAGEM}‚Ä¢ ${planta} - ${descricao}%0A"
                    CONTADOR=$((CONTADOR + 1))
                  fi
                done < /tmp/acoes.txt
                MENSAGEM="${MENSAGEM}%0A"
              fi
              
              # Poda
              if [ "$PODA_COUNT" -gt 0 ] && [ "$CONTADOR" -lt 12 ]; then
                MENSAGEM="${MENSAGEM}‚úÇÔ∏è *Poda:*%0A"
                while IFS='|' read -r tipo_planta descricao; do
                  tipo=$(echo "$tipo_planta" | cut -d: -f1)
                  planta=$(echo "$tipo_planta" | cut -d: -f2)
                  if [ "$tipo" = "PODA" ] && [ "$CONTADOR" -lt 12 ]; then
                    MENSAGEM="${MENSAGEM}‚Ä¢ ${planta} - ${descricao}%0A"
                    CONTADOR=$((CONTADOR + 1))
                  fi
                done < /tmp/acoes.txt
                MENSAGEM="${MENSAGEM}%0A"
              fi
              
              # Colheita
              if [ "$COLH_COUNT" -gt 0 ] && [ "$CONTADOR" -lt 12 ]; then
                MENSAGEM="${MENSAGEM}üçä *Colheita:*%0A"
                while IFS='|' read -r tipo_planta descricao; do
                  tipo=$(echo "$tipo_planta" | cut -d: -f1)
                  planta=$(echo "$tipo_planta" | cut -d: -f2)
                  if [ "$tipo" = "COLHEITA" ] && [ "$CONTADOR" -lt 12 ]; then
                    MENSAGEM="${MENSAGEM}‚Ä¢ ${planta} - ${descricao}%0A"
                    CONTADOR=$((CONTADOR + 1))
                  fi
                done < /tmp/acoes.txt
              fi
            fi
          fi
          
          MENSAGEM="${MENSAGEM}%0Aüì± *Acesse:*%0A"
          MENSAGEM="${MENSAGEM}https://yurimegromonte182.github.io/S-tio_Ipiranga/"
          
          # Limpar tempor√°rio
          rm -f /tmp/acoes.txt
          
          # Enviar notifica√ß√£o
          echo "üì§ Enviando notifica√ß√£o..."
          
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}" -X POST \
            "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MENSAGEM}" \
            -d parse_mode="Markdown")
          
          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          RESPONSE_BODY=$(echo "$RESPONSE" | grep -v "HTTP_CODE:")
          
          echo "Status HTTP: ${HTTP_CODE}"
          echo "Resposta: ${RESPONSE_BODY}"
          
          if [ "${HTTP_CODE}" = "200" ] && echo "$RESPONSE_BODY" | grep -q '"ok":true'; then
            echo "‚úÖ Notifica√ß√£o enviada com sucesso!"
          else
            echo "‚ùå Erro ao enviar notifica√ß√£o"
            echo "Detalhes: ${RESPONSE_BODY}"
            exit 1
          fi
          
      - name: üìä Resumo estat√≠stico (apenas 06h)
        if: github.event.schedule == '0 9 * * *'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "=== ENVIANDO RESUMO ESTAT√çSTICO ==="
          
          if [ ! -f "dados.geojson" ]; then
            echo "‚ö†Ô∏è Arquivo n√£o encontrado, pulando estat√≠sticas"
            exit 0
          fi
          
          TOTAL=$(jq '.features | length' dados.geojson)
          
          COQUEIROS=$(jq '[.features[] | select(
            (.properties.nome_popular // .properties.especie // "") | 
            ascii_downcase | contains("coq")
          )] | length' dados.geojson)
          
          CAJUEIROS=$(jq '[.features[] | select(
            (.properties.nome_popular // .properties.especie // "") | 
            ascii_downcase | contains("caju")
          )] | length' dados.geojson)
          
          CACAU=$(jq '[.features[] | select(
            (.properties.nome_popular // .properties.especie // "") | 
            ascii_downcase | contains("cacau")
          )] | length' dados.geojson)
          
          MANGABEIRA=$(jq '[.features[] | select(
            (.properties.nome_popular // .properties.especie // "") | 
            ascii_downcase | contains("mangabeira")
          )] | length' dados.geojson)
          
          OUTRAS=$((TOTAL - COQUEIROS - CAJUEIROS - CACAU - MANGABEIRA))
          
          STATS="üìä *Resumo do S√≠tio*%0A"
          STATS="${STATS}üå≥ *Total:* ${TOTAL} plantas%0A%0A"
          [ "$COQUEIROS" -gt 0 ] && STATS="${STATS}ü•• Coqueiros: ${COQUEIROS}%0A"
          [ "$CAJUEIROS" -gt 0 ] && STATS="${STATS}üå∞ Cajueiros: ${CAJUEIROS}%0A"
          [ "$CACAU" -gt 0 ] && STATS="${STATS}üç´ Cacau: ${CACAU}%0A"
          [ "$MANGABEIRA" -gt 0 ] && STATS="${STATS}ü•≠ Mangabeira: ${MANGABEIRA}%0A"
          [ "$OUTRAS" -gt 0 ] && STATS="${STATS}üåø Outras: ${OUTRAS}%0A"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${STATS}" \
            -d parse_mode="Markdown"
          
          echo "‚úÖ Resumo estat√≠stico enviado!"
