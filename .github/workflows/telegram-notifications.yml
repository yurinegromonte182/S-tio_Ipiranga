name: Notifica√ß√µes Telegram - Supabase

on:
  schedule:
    # 06:00 BR = 09:00 UTC
    - cron: '0 9 * * *'
    # 12:00 BR = 15:00 UTC  
    - cron: '0 15 * * *'
    # 18:00 BR = 21:00 UTC
    - cron: '0 21 * * *'
  workflow_dispatch:

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    env:
      SUPABASE_URL: https://mcp.supabase.com/mcp?project_ref=erbefbnjxgpetbetlzya
      SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVyYmVmYm5qeGdwZXRiZXRsenlhIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEwMzI4ODcsImV4cCI6MjA3NjYwODg4N30.d09pjgddZpNY3Z4cVZ3V4h77aAf_GVGF0sOBTZkZf2A
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup environment
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq bc
      
      - name: Buscar dados e processar notifica√ß√£o
        run: |
          # Configurar fuso hor√°rio
          export TZ='America/Sao_Paulo'
          
          # Data atual
          HOJE=$(date +%Y-%m-%d)
          DATA_EXIBICAO=$(date +%d/%m/%Y)
          HORA_EXIBICAO=$(date +%H:%M)
          HORA_NUM=$(date +%H)
          
          # Fun√ß√£o para calcular dias
          dias_desde() {
            if [ -z "$1" ] || [ "$1" = "null" ] || [ "$1" = "" ]; then
              echo "999"
            else
              data_epoch=$(date -d "$1" +%s 2>/dev/null || echo "0")
              hoje_epoch=$(date -d "$HOJE" +%s)
              if [ "$data_epoch" = "0" ]; then
                echo "999"
              else
                echo $(( (hoje_epoch - data_epoch) / 86400 ))
              fi
            fi
          }
          
          echo "üîÑ Tentando buscar dados do Supabase..."
          
          # Tentar buscar da fun√ß√£o RPC
          RESPONSE=$(curl -s -X POST \
            "$SUPABASE_URL/rest/v1/rpc/get_plantas_para_telegram" \
            -H "apikey: $SUPABASE_ANON_KEY" \
            -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
            -H "Content-Type: application/json" \
            -d '{}' 2>/dev/null || echo "[]")
          
          # Verificar se a resposta √© v√°lida
          if echo "$RESPONSE" | jq -e . >/dev/null 2>&1; then
            TOTAL=$(echo "$RESPONSE" | jq '. | length')
            echo "‚úÖ $TOTAL plantas encontradas no Supabase"
            echo "$RESPONSE" > plantas.json
          else
            echo "‚ö†Ô∏è Erro ao buscar do Supabase, usando backup local..."
            
            # Verificar se existe arquivo local
            if [ -f "dados.geojson" ]; then
              TOTAL=$(jq '.features | length' dados.geojson 2>/dev/null || echo "0")
              echo "‚úÖ $TOTAL plantas no backup local"
              
              # Converter para formato similar
              jq '[.features[] | {
                id: (.properties.id // .properties.fid // "S/N"),
                nome: (.properties.nome_popular // "Planta"),
                ultRega: .properties.ultima_rega,
                ultPoda: .properties.ultima_poda,
                ultColh: .properties.ultima_colheita,
                dataPlantio: .properties.data_plantio
              }]' dados.geojson > plantas.json
            else
              TOTAL=0
              echo '[]' > plantas.json
            fi
          fi
          
          # Sauda√ß√£o
          if [ "$HORA_NUM" -lt 12 ]; then
            SAUDACAO="‚òÄÔ∏è Bom dia"
          elif [ "$HORA_NUM" -lt 18 ]; then
            SAUDACAO="‚õÖ Boa tarde"
          else
            SAUDACAO="üåô Boa noite"
          fi
          
          # Iniciar mensagem
          MESSAGE="${SAUDACAO}!%0A"
          MESSAGE="${MESSAGE}üåø *S√≠tio Ipiranga*%0A"
          MESSAGE="${MESSAGE}üìÖ ${DATA_EXIBICAO} √†s ${HORA_EXIBICAO}%0A"
          MESSAGE="${MESSAGE}üå≥ *${TOTAL} plantas* cadastradas%0A%0A"
          
          if [ "$TOTAL" -eq "0" ]; then
            MESSAGE="${MESSAGE}‚ö†Ô∏è *Nenhuma planta encontrada*%0A"
          else
            # Arrays para a√ß√µes
            REGA_URG=""
            REGA_NORM=""
            PODA_PEND=""
            COLHEITA_PEND=""
            TOTAL_ACOES=0
            
            # Processar cada planta
            while IFS= read -r planta; do
              ID=$(echo "$planta" | jq -r '.id // .planta_id // "S/N"')
              NOME=$(echo "$planta" | jq -r '.nome // .nome_popular // "Planta"')
              ULT_REGA=$(echo "$planta" | jq -r '.ultRega // .ultima_rega // "null"')
              ULT_PODA=$(echo "$planta" | jq -r '.ultPoda // .ultima_poda // "null"')
              ULT_COLH=$(echo "$planta" | jq -r '.ultColh // .ultima_colheita // "null"')
              
              # Normalizar nome
              NOME_NORM=$(echo "$NOME" | tr '[:upper:]' '[:lower:]')
              
              # Determinar intervalos
              if echo "$NOME_NORM" | grep -q "mangabeira"; then
                REGA_INT=7; PODA_INT=180; COLHEITA_INT=90
              elif echo "$NOME_NORM" | grep -q "caju"; then
                REGA_INT=10; PODA_INT=365; COLHEITA_INT=60
              elif echo "$NOME_NORM" | grep -q "coq"; then
                REGA_INT=5; PODA_INT=730; COLHEITA_INT=30
              elif echo "$NOME_NORM" | grep -q "cacau"; then
                REGA_INT=3; PODA_INT=180; COLHEITA_INT=120
              else
                REGA_INT=7; PODA_INT=180; COLHEITA_INT=90
              fi
              
              # Verificar rega
              DIAS_R=$(dias_desde "$ULT_REGA")
              if [ "$DIAS_R" -ge $((REGA_INT + 2)) ]; then
                REGA_URG="${REGA_URG}‚Ä¢ üö® ${NOME} #${ID} - ${DIAS_R} dias%0A"
                TOTAL_ACOES=$((TOTAL_ACOES + 1))
              elif [ "$DIAS_R" -ge "$REGA_INT" ]; then
                REGA_NORM="${REGA_NORM}‚Ä¢ üíß ${NOME} #${ID} - ${DIAS_R} dias%0A"
                TOTAL_ACOES=$((TOTAL_ACOES + 1))
              fi
              
              # Verificar poda
              DIAS_P=$(dias_desde "$ULT_PODA")
              if [ "$DIAS_P" -ge "$PODA_INT" ]; then
                PODA_PEND="${PODA_PEND}‚Ä¢ ‚úÇÔ∏è ${NOME} #${ID} - ${DIAS_P} dias%0A"
                TOTAL_ACOES=$((TOTAL_ACOES + 1))
              fi
              
              # Verificar colheita
              DIAS_C=$(dias_desde "$ULT_COLH")
              if [ "$DIAS_C" -ge "$COLHEITA_INT" ]; then
                COLHEITA_PEND="${COLHEITA_PEND}‚Ä¢ üçé ${NOME} #${ID} - ${DIAS_C} dias%0A"
                TOTAL_ACOES=$((TOTAL_ACOES + 1))
              fi
              
            done < <(jq -c '.[]' plantas.json)
            
            # Montar mensagem final
            if [ "$TOTAL_ACOES" -eq 0 ]; then
              MESSAGE="${MESSAGE}‚úÖ *Tudo em dia!*%0ANenhuma a√ß√£o pendente.%0A"
            else
              MESSAGE="${MESSAGE}üìã *${TOTAL_ACOES} a√ß√£o(√µes) pendente(s):*%0A%0A"
              [ -n "$REGA_URG" ] && MESSAGE="${MESSAGE}üö® *URGENTE:*%0A${REGA_URG}%0A"
              [ -n "$REGA_NORM" ] && MESSAGE="${MESSAGE}üíß *Rega:*%0A${REGA_NORM}%0A"
              [ -n "$PODA_PEND" ] && MESSAGE="${MESSAGE}‚úÇÔ∏è *Poda:*%0A${PODA_PEND}%0A"
              [ -n "$COLHEITA_PEND" ] && MESSAGE="${MESSAGE}üçé *Colheita:*%0A${COLHEITA_PEND}%0A"
            fi
          fi
          
          MESSAGE="${MESSAGE}%0Aüì± *Acesse o app:*%0A"
          MESSAGE="${MESSAGE}https://yurimegromonte182.github.io/S-tio_Jintanga/"
          
          # Salvar mensagem para debug
          echo "=== MENSAGEM GERADA ==="
          echo -e "$MESSAGE" | sed 's/%0A/\n/g'
          echo "======================"
          
          # Enviar para Telegram
          curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
            -d chat_id="$TELEGRAM_CHAT_ID" \
            -d text="$MESSAGE" \
            -d parse_mode="Markdown"
          
          echo "‚úÖ Notifica√ß√£o enviada!"
          
          # Estat√≠sticas di√°rias (06h)
          if [[ "${{ github.event.schedule }}" == "0 9 * * *" ]] && [ "$TOTAL" -gt "0" ]; then
            # Contar por tipo
            COQUEIROS=0
            CAJUEIROS=0
            CACAU=0
            MANGABEIRA=0
            
            while IFS= read -r planta; do
              NOME=$(echo "$planta" | jq -r '.nome // .nome_popular // ""' | tr '[:upper:]' '[:lower:]')
              
              if echo "$NOME" | grep -q "coq"; then
                COQUEIROS=$((COQUEIROS + 1))
              elif echo "$NOME" | grep -q "caju"; then
                CAJUEIROS=$((CAJUEIROS + 1))
              elif echo "$NOME" | grep -q "cacau"; then
                CACAU=$((CACAU + 1))
              elif echo "$NOME" | grep -q "mangabeira"; then
                MANGABEIRA=$((MANGABEIRA + 1))
              fi
            done < <(jq -c '.[]' plantas.json)
            
            STATS="üìä *Resumo do S√≠tio:*%0A"
            STATS="${STATS}üå≥ Total: ${TOTAL} plantas%0A"
            [ "$COQUEIROS" -gt 0 ] && STATS="${STATS}ü•• Coqueiros: ${COQUEIROS}%0A"
            [ "$CAJUEIROS" -gt 0 ] && STATS="${STATS}üå∞ Cajueiros: ${CAJUEIROS}%0A"
            [ "$CACAU" -gt 0 ] && STATS="${STATS}üç´ Cacau: ${CACAU}%0A"
            [ "$MANGABEIRA" -gt 0 ] && STATS="${STATS}ü•≠ Mangabeira: ${MANGABEIRA}%0A"
            
            curl -s -X POST "https://api.telegram.org/bot$TELEGRAM_BOT_TOKEN/sendMessage" \
              -d chat_id="$TELEGRAM_CHAT_ID" \
              -d text="$STATS" \
              -d parse_mode="Markdown"
              
            echo "‚úÖ Estat√≠sticas enviadas!"
          fi
