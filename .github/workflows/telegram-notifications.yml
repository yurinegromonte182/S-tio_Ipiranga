name: Notifica√ß√µes Telegram - Sincroniza√ß√£o Autom√°tica

on:
  schedule:
    - cron: '0 9 * * *'
    - cron: '0 15 * * *'
    - cron: '0 21 * * *'
  workflow_dispatch:

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    env:
      # N√£o colocar host/port separados aqui para evitar mascaramento amb√≠guo.
      # Usaremos a URL completa em SUPABASE_DB_URL (secret).
      TZ: 'America/Sao_Paulo'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Instalar depend√™ncias do sistema
        run: |
          sudo apt-get update
          sudo apt-get install -y jq postgresql-client

      - name: Verificar se secrets existem (debug seguro)
        run: |
          if [ -z "${{ secrets.SUPABASE_DB_URL }}" ]; then
            echo "ERROR: SUPABASE_DB_URL n√£o encontrado. Crie o secret e rode novamente."
            exit 1
          fi
          if [ -z "${{ secrets.TELEGRAM_BOT_TOKEN }}" ] || [ -z "${{ secrets.TELEGRAM_CHAT_ID }}" ]; then
            echo "ERROR: Secrets do Telegram faltando. Crie TELEGRAM_BOT_TOKEN e TELEGRAM_CHAT_ID."
            exit 1
          fi
          echo "Secrets m√≠nimos encontrados."
          # Mostrar a URL mascarada para confirmar formato (senha escondida)
          echo "${{ secrets.SUPABASE_DB_URL }}" | sed -E 's#://([^:]+):([^@]+)@#://\1:*****@#'
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

      - name: Baixar dados do Supabase (PostGIS ‚Üí GeoJSON)
        run: |
          set -euo pipefail
          echo "Baixando dados do Supabase e criando dados.geojson..."

          SQL="SELECT jsonb_build_object(
                  'type','FeatureCollection',
                  'features', COALESCE(jsonb_agg(
                    jsonb_build_object(
                      'type','Feature',
                      'geometry', ST_AsGeoJSON(geom)::jsonb,
                      'properties', to_jsonb(row) - 'geom'
                    )
                  ), '[]'::jsonb)
                ) FROM (SELECT * FROM arvores) row;"

          # Executa o psql usando a URL completa armazenada no secret.
          # A sa√≠da pode vir com espa√ßos/novas linhas ‚Üí removemos leading/trailing.
          resultado=$(psql "${{ secrets.SUPABASE_DB_URL }}" -t -A -c "$SQL" || true)

          if [ -z "$resultado" ] || [ "$resultado" = "NULL" ]; then
            echo "Nenhum dado retornado ou falha na query. Saindo com erro."
            echo "Sa√≠da do comando psql (mas n√£o mostramos secrets):"
            echo "$resultado"
            exit 1
          fi

          # Normalizar e gravar em arquivo .geojson
          echo "$resultado" > dados.geojson
          echo "Arquivo dados.geojson gerado (tamanho: $(wc -c < dados.geojson) bytes)."
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

      - name: Setup Node.js (necess√°rio por compatibilidade do seu script)
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Processar a√ß√µes e notificar Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          set -euo pipefail
          # instalar jq caso n√£o exista (passo anterior j√° instalou)
          sudo apt-get update
          sudo apt-get install -y jq

          export TZ='America/Sao_Paulo'
          HOJE=$(date +%Y-%m-%d)
          DATA_EXIBICAO=$(date +%d/%m/%Y)
          HORA_EXIBICAO=$(date +%H:%M)
          HORA_NUM=$(date +%H)

          # Fun√ß√µes e intervalos (mesma l√≥gica que voc√™ tinha)
          dias_desde() {
            if [ -z "$1" ] || [ "$1" = "null" ]; then
              echo "999"
            else
              echo $(( ( $(date -d "$HOJE" +%s) - $(date -d "$1" +%s) ) / 86400 ))
            fi
          }

          get_intervalo() {
            local especie=$1
            local tipo=$2
            case "$tipo" in
              "rega")
                case "$especie" in
                  *"Mangabeira"*) echo 7 ;;
                  *"Caju"*) echo 10 ;;
                  *"Coq"*) echo 5 ;;
                  *"Cacau"*) echo 3 ;;
                  *) echo 7 ;;
                esac ;;
              "poda")
                case "$especie" in
                  *"Mangabeira"*) echo 180 ;;
                  *"Caju"*) echo 365 ;;
                  *"Coq"*) echo 730 ;;
                  *"Cacau"*) echo 180 ;;
                  *) echo 180 ;;
                esac ;;
              "colheita")
                case "$especie" in
                  *"Mangabeira"*) echo 90 ;;
                  *"Caju"*) echo 60 ;;
                  *"Coq"*) echo 30 ;;
                  *"Cacau"*) echo 120 ;;
                  *) echo 90 ;;
                esac ;;
            esac
          }

          # Limpa arquivo tempor√°rio anterior
          rm -f /tmp/acoes.txt || true

          # Processar cada feature do GeoJSON
          if [ ! -f dados.geojson ]; then
            echo "dados.geojson n√£o encontrado ‚Äî abortando."
            exit 1
          fi

          jq -c '.features[]' dados.geojson | while read -r feature; do
            ID=$(echo "$feature" | jq -r '.properties.ID // .properties.id // "S/N"')
            NOME=$(echo "$feature" | jq -r '.properties.NOME_POPULAR // .properties.nome_popular // "Planta"')
            ULT_REGA=$(echo "$feature" | jq -r '.properties.ULTIMA_REGA // .properties.ultima_rega // "null"')
            ULT_PODA=$(echo "$feature" | jq -r '.properties.ULTIMA_PODA // .properties.ultima_poda // "null"')
            ULT_COLH=$(echo "$feature" | jq -r '.properties.ULTIMA_COLHEITA // .properties.ultima_colheita // "null"')

            INT_R=$(get_intervalo "$NOME" "rega")
            DIAS_R=$(dias_desde "$ULT_REGA")

            if [ "$DIAS_R" -ge $((INT_R + 2)) ]; then
              echo "REGA_URG:$NOME #$ID - Atrasada $DIAS_R dias" >> /tmp/acoes.txt
            elif [ "$DIAS_R" -ge "$INT_R" ]; then
              if [ "$ULT_REGA" = "null" ]; then
                echo "REGA_NORM:$NOME #$ID - Nunca foi regada" >> /tmp/acoes.txt
              else
                echo "REGA_NORM:$NOME #$ID - H√° $DIAS_R dias sem regar" >> /tmp/acoes.txt
              fi
            fi

            INT_P=$(get_intervalo "$NOME" "poda")
            DIAS_P=$(dias_desde "$ULT_PODA")
            if [ "$DIAS_P" -ge "$INT_P" ]; then
              if [ "$ULT_PODA" = "null" ]; then
                echo "PODA:$NOME #$ID - Nunca foi podada" >> /tmp/acoes.txt
              else
                echo "PODA:$NOME #$ID - H√° $DIAS_P dias sem poda" >> /tmp/acoes.txt
              fi
            fi

            INT_C=$(get_intervalo "$NOME" "colheita")
            DIAS_C=$(dias_desde "$ULT_COLH")
            if [ "$DIAS_C" -ge "$INT_C" ]; then
              if [ "$ULT_COLH" = "null" ]; then
                echo "COLHEITA:$NOME #$ID - Verificar frutos" >> /tmp/acoes.txt
              else
                echo "COLHEITA:$NOME #$ID - H√° $DIAS_C dias sem colheita" >> /tmp/acoes.txt
              fi
            fi
          done

          # Montar mensagem
          TOTAL=$(jq '.features | length' dados.geojson 2>/dev/null || echo 0)

          if [ -f /tmp/acoes.txt ]; then
            TOTAL_ACOES=$(wc -l < /tmp/acoes.txt)
          else
            TOTAL_ACOES=0
          fi

          if [ "$HORA_NUM" -lt 12 ]; then
            SAUDACAO="‚òÄÔ∏è Bom dia"
          elif [ "$HORA_NUM" -lt 18 ]; then
            SAUDACAO="‚õÖ Boa tarde"
          else
            SAUDACAO="üåô Boa noite"
          fi

          MESSAGE="${SAUDACAO}!%0A"
          MESSAGE="${MESSAGE}üìÖ ${DATA_EXIBICAO} √†s ${HORA_EXIBICAO}%0A%0A"

          if [ "$TOTAL_ACOES" -eq 0 ]; then
            MESSAGE="${MESSAGE}‚úÖ *Tudo em dia!*%0A"
            MESSAGE="${MESSAGE}Nenhuma a√ß√£o necess√°ria. üåø%0A%0A"
            MESSAGE="${MESSAGE}üìä Total: ${TOTAL} plantas cadastradas"
          else
            MESSAGE="${MESSAGE}üìã *A√ß√µes: ${TOTAL_ACOES}*%0A%0A"

            URG_COUNT=$(grep -c "^REGA_URG:" /tmp/acoes.txt 2>/dev/null || echo 0)
            NORM_COUNT=$(grep -c "^REGA_NORM:" /tmp/acoes.txt 2>/dev/null || echo 0)
            PODA_COUNT=$(grep -c "^PODA:" /tmp/acoes.txt 2>/dev/null || echo 0)
            COLH_COUNT=$(grep -c "^COLHEITA:" /tmp/acoes.txt 2>/dev/null || echo 0)

            if [ "$TOTAL_ACOES" -gt 15 ]; then
              [ "$URG_COUNT" -gt 0 ] && MESSAGE="${MESSAGE}üö® URGENTE: ${URG_COUNT} rega(s) atrasada(s)%0A"
              [ "$NORM_COUNT" -gt 0 ] && MESSAGE="${MESSAGE}üíß Rega: ${NORM_COUNT} planta(s)%0A"
              [ "$PODA_COUNT" -gt 0 ] && MESSAGE="${MESSAGE}‚úÇÔ∏è Poda: ${PODA_COUNT} planta(s)%0A"
              [ "$COLH_COUNT" -gt 0 ] && MESSAGE="${MESSAGE}üçä Colheita: ${COLH_COUNT} planta(s)%0A"
              MESSAGE="${MESSAGE}%0Aüí° Veja detalhes no app"
            else
              CONTADOR=0
              if [ "$URG_COUNT" -gt 0 ]; then
                MESSAGE="${MESSAGE}üö® *URGENTE:*%0A"
                while IFS=: read -r tipo texto; do
                  if [ "$tipo" = "REGA_URG" ]; then
                    MESSAGE="${MESSAGE}‚Ä¢ ${texto}%0A"
                    CONTADOR=$((CONTADOR + 1))
                  fi
                done < /tmp/acoes.txt
                MESSAGE="${MESSAGE}%0A"
              fi

              if [ "$NORM_COUNT" -gt 0 ] && [ "$CONTADOR" -lt 15 ]; then
                MESSAGE="${MESSAGE}üíß *Rega:*%0A"
                while IFS=: read -r tipo texto; do
                  if [ "$tipo" = "REGA_NORM" ] && [ "$CONTADOR" -lt 15 ]; then
                    MESSAGE="${MESSAGE}‚Ä¢ ${texto}%0A"
                    CONTADOR=$((CONTADOR + 1))
                  fi
                done < /tmp/acoes.txt
                MESSAGE="${MESSAGE}%0A"
              fi

              if [ "$PODA_COUNT" -gt 0 ] && [ "$CONTADOR" -lt 15 ]; then
                MESSAGE="${MESSAGE}‚úÇÔ∏è *Poda:*%0A"
                while IFS=: read -r tipo texto; do
                  if [ "$tipo" = "PODA" ] && [ "$CONTADOR" -lt 15 ]; then
                    MESSAGE="${MESSAGE}‚Ä¢ ${texto}%0A"
                    CONTADOR=$((CONTADOR + 1))
                  fi
                done < /tmp/acoes.txt
                MESSAGE="${MESSAGE}%0A"
              fi

              if [ "$COLH_COUNT" -gt 0 ] && [ "$CONTADOR" -lt 15 ]; then
                MESSAGE="${MESSAGE}üçä *Colheita:*%0A"
                while IFS=: read -r tipo texto; do
                  if [ "$tipo" = "COLHEITA" ] && [ "$CONTADOR" -lt 15 ]; then
                    MESSAGE="${MESSAGE}‚Ä¢ ${texto}%0A"
                    CONTADOR=$((CONTADOR + 1))
                  fi
                done < /tmp/acoes.txt
              fi
            fi
          fi

          rm -f /tmp/acoes.txt

          # Enviar notifica√ß√£o via Telegram
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"

          echo "Notifica√ß√£o enviada!"
