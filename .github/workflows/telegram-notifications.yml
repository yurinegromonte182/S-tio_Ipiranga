name: Notifica√ß√µes Telegram - Sincroniza√ß√£o Autom√°tica

on:
  push:
    branches:
      - main
    paths:
      - 'dados.geojson'
  schedule:
    # 06:00 BR = 09:00 UTC
    - cron: '0 9 * * *'
    # 12:00 BR = 15:00 UTC
    - cron: '0 15 * * *'
    # 18:00 BR = 21:00 UTC
    - cron: '0 21 * * *'
  workflow_dispatch:

jobs:
  notify-telegram:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Processar a√ß√µes e notificar Telegram
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Instalar jq para processar JSON
          sudo apt-get update
          sudo apt-get install -y jq
          
          # Configurar fuso hor√°rio de Bras√≠lia
          export TZ='America/Sao_Paulo'
          
          # Data atual no hor√°rio de Bras√≠lia
          HOJE=$(date +%Y-%m-%d)
          DATA_EXIBICAO=$(date +%d/%m/%Y)
          HORA_EXIBICAO=$(date +%H:%M)
          HORA_NUM=$(date +%H)
          
          # Inicializar contadores
          URG_COUNT=0
          NORM_COUNT=0
          PODA_COUNT=0
          COLH_COUNT=0
          TOTAL_ATRASADAS=0
          
          echo "üìä Processando dados.geojson..."
          
          # Processar cada planta com a mesma l√≥gica da Edge Function
          jq -c '.features[]' dados.geojson | while read -r feature; do
            # Extrair dados (com fallback para diferentes nomes de campos)
            ESPECIE=$(echo "$feature" | jq -r '
              .properties.NOME_POPULAR // 
              .properties.nome_popular // 
              .properties.nome_cientifico // 
              .properties.especie // 
              "Desconhecida"
            ')
            
            # Datas (com fallback)
            DATA_REGA=$(echo "$feature" | jq -r '
              .properties.data_irrigacao_ordinaria // 
              .properties.ULTIMA_REGA // 
              .properties.ultima_rega // 
              .properties.data_rega // 
              "null"
            ')
            
            DATA_PODA=$(echo "$feature" | jq -r '
              .properties.data_poda_formacao_1 // 
              .properties.ULTIMA_PODA // 
              .properties.ultima_poda // 
              .properties.data_poda // 
              "null"
            ')
            
            DATA_COLH=$(echo "$feature" | jq -r '
              .properties.inicio_colheita // 
              .properties.ULTIMA_COLHEITA // 
              .properties.ultima_colheita // 
              .properties.data_colheita // 
              "null"
            ')
            
            # Fun√ß√£o para calcular dias
            dias_desde() {
              if [ -z "$1" ] || [ "$1" = "null" ]; then
                echo "999"
              else
                echo $(( ( $(date -d "$HOJE" +%s) - $(date -d "$1" +%s) ) / 86400 ))
              fi
            }
            
            # Fun√ß√£o para obter intervalo (mesma l√≥gica da Edge Function)
            get_intervalo() {
              local especie="$1"
              local tipo="$2"
              
              case "$tipo" in
                "rega")
                  case "$especie" in
                    *"Coqueiro"*) echo "5" ;;
                    *"Cacau"*) echo "3" ;;
                    *"Cajueiro"*) echo "10" ;;
                    *"Mangabeira"*) echo "7" ;;
                    *) echo "7" ;;
                  esac
                  ;;
                "poda")
                  case "$especie" in
                    *"Coqueiro"*) echo "730" ;;
                    *"Cacau"*) echo "180" ;;
                    *"Cajueiro"*) echo "365" ;;
                    *"Mangabeira"*) echo "180" ;;
                    *) echo "180" ;;
                  esac
                  ;;
                "colheita")
                  case "$especie" in
                    *"Coqueiro"*) echo "30" ;;
                    *"Cacau"*) echo "120" ;;
                    *"Cajueiro"*) echo "60" ;;
                    *"Mangabeira"*) echo "90" ;;
                    *) echo "90" ;;
                  esac
                  ;;
                *) echo "0" ;;
              esac
            }
            
            # Calcular dias desde cada a√ß√£o
            DIAS_REGA=$(dias_desde "$DATA_REGA")
            DIAS_PODA=$(dias_desde "$DATA_PODA")
            DIAS_COLH=$(dias_desde "$DATA_COLH")
            
            # Obter intervalos
            INT_REGA=$(get_intervalo "$ESPECIE" "rega")
            INT_PODA=$(get_intervalo "$ESPECIE" "poda")
            INT_COLH=$(get_intervalo "$ESPECIE" "colheita")
            
            # Contar a√ß√µes atrasadas (mesma l√≥gica da Edge Function)
            if [ "$DIAS_REGA" -ge "$INT_REGA" ]; then
              TOTAL_ATRASADAS=$((TOTAL_ATRASADAS + 1))
              if [ "$DIAS_REGA" -ge $((INT_REGA + 2)) ]; then
                URG_COUNT=$((URG_COUNT + 1))
              else
                NORM_COUNT=$((NORM_COUNT + 1))
              fi
            fi
            
            if [ "$DIAS_PODA" -ge "$INT_PODA" ]; then
              TOTAL_ATRASADAS=$((TOTAL_ATRASADAS + 1))
              PODA_COUNT=$((PODA_COUNT + 1))
            fi
            
            if [ "$DIAS_COLH" -ge "$INT_COLH" ]; then
              TOTAL_ATRASADAS=$((TOTAL_ATRASADAS + 1))
              COLH_COUNT=$((COLH_COUNT + 1))
            fi
            
          done
          
          # Total de plantas
          TOTAL=$(jq '.features | length' dados.geojson)
          
          # Sauda√ß√£o por hor√°rio (hor√°rio de Bras√≠lia)
          if [ "$HORA_NUM" -lt 12 ]; then
            SAUDACAO="‚òÄÔ∏è Bom dia"
          elif [ "$HORA_NUM" -lt 18 ]; then
            SAUDACAO="‚õÖ Boa tarde"
          else
            SAUDACAO="üåô Boa noite"
          fi
          
          echo "üìä Estat√≠sticas:"
          echo "Total plantas: $TOTAL"
          echo "Atrasadas: $TOTAL_ATRASADAS"
          echo "Rega URG: $URG_COUNT, NORM: $NORM_COUNT"
          echo "Poda: $PODA_COUNT"
          echo "Colheita: $COLH_COUNT"
          
          # Montar mensagem (mesmo formato da Edge Function)
          MESSAGE="${SAUDACAO}!
üìÖ ${DATA_EXIBICAO} √†s ${HORA_EXIBICAO}

üîÑ Atualiza√ß√£o autom√°tica
Dados sincronizados do Aplicativo 

üìã Total de frut√≠feras: ${TOTAL}"

          # Adicionar se√ß√£o de URGENTE apenas se houver atrasos
          if [ "$TOTAL_ATRASADAS" -gt 0 ]; then
            MESSAGE="${MESSAGE}

üö® URGENTE: ${TOTAL_ATRASADAS} a√ß√£o(√µes) atrasada(s)
üíß Rega: $((URG_COUNT + NORM_COUNT)) planta(s)
‚úÇÔ∏è Poda: ${PODA_COUNT} planta(s)
üçä Colheita: ${COLH_COUNT} planta(s)"
          fi
          
          MESSAGE="${MESSAGE}

üí° Veja detalhes no app"
          
          # Remover quebras de linha duplas
          MESSAGE=$(echo "$MESSAGE" | sed '/^$/N;/^\n$/D')
          
          # Converter quebras de linha para %0A
          MESSAGE=$(echo "$MESSAGE" | sed ':a;N;$!ba;s/\n/%0A/g')
          
          echo "üì§ Enviando mensagem para Telegram..."
          echo "Mensagem:"
          echo -e "${MESSAGE//%0A/\\n}"
          
          # Enviar notifica√ß√£o (SEM parse_mode ou com "HTML" se preferir)
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${MESSAGE}"
          
          if [ $? -eq 0 ]; then
            echo "‚úÖ Notifica√ß√£o enviada com sucesso!"
          else
            echo "‚ùå Erro ao enviar notifica√ß√£o"
            exit 1
          fi
          
      - name: Resumo estat√≠stico (apenas 06h)
        if: github.event.schedule == '0 9 * * *'
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # Configurar fuso hor√°rio de Bras√≠lia
          export TZ='America/Sao_Paulo'
          
          # Estat√≠sticas gerais
          TOTAL=$(jq '.features | length' dados.geojson)
          COQUEIROS=$(jq '[.features[] | select(.properties.NOME_POPULAR == "Coqueiro")] | length' dados.geojson)
          CAJUEIROS=$(jq '[.features[] | select(.properties.NOME_POPULAR == "Cajueiro")] | length' dados.geojson)
          CACAU=$(jq '[.features[] | select(.properties.NOME_POPULAR == "Cacau")] | length' dados.geojson)
          MANGABEIRA=$(jq '[.features[] | select(.properties.NOME_POPULAR == "Mangabeira")] | length' dados.geojson)
          
          STATS="üìä *Resumo do S√≠tio:*%0A"
          STATS="${STATS}üå≥ Total: ${TOTAL} plantas%0A"
          [ "$COQUEIROS" -gt 0 ] && STATS="${STATS}ü•• Coqueiros: ${COQUEIROS}%0A"
          [ "$CAJUEIROS" -gt 0 ] && STATS="${STATS}üå∞ Cajueiros: ${CAJUEIROS}%0A"
          [ "$CACAU" -gt 0 ] && STATS="${STATS}üç´ Cacau: ${CACAU}%0A"
          [ "$MANGABEIRA" -gt 0 ] && STATS="${STATS}ü•≠ Mangabeira: ${MANGABEIRA}%0A"
          
          curl -s -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            -d text="${STATS}" \
            -d parse_mode="Markdown"
