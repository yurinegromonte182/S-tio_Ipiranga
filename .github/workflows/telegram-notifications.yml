name: üåø S√≠tio Ipiranga - Notifica√ß√µes

on:
  workflow_dispatch:
  schedule:
    # 06:00, 12:00, 18:00 (hor√°rio Brasil)
    - cron: '0 9,15,21 * * *'

jobs:
  enviar-notificacao:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• Baixar reposit√≥rio
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          
      - name: üì§ Enviar mensagem para Telegram
        env:
          TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          echo "=== INICIANDO ENVIO ==="
          
          # Verificar se temos os dados
          if [ ! -f "dados.geojson" ]; then
            echo "‚ö†Ô∏è Arquivo dados.geojson n√£o encontrado"
            echo "Criando mensagem b√°sica..."
            
            MENSAGEM="üåø *S√≠tio Ipiranga*%0A"
            MENSAGEM="${MENSAGEM}üìÖ $(date '+%d/%m/%Y') √†s $(date '+%H:%M')%0A"
            MENSAGEM="${MENSAGEM}‚ö†Ô∏è *AVISO:* Arquivo dados.geojson n√£o encontrado%0A"
            MENSAGEM="${MENSAGEM}Exporte os dados do QField e fa√ßa upload.%0A"
            MENSAGEM="${MENSAGEM}%0Aüì± *Acesse o app:*%0A"
            MENSAGEM="${MENSAGEM}https://yurimegromonte182.github.io/S-tio_Jintanga/"
          else
            echo "‚úÖ Arquivo dados.geojson encontrado"
            
            # Contar plantas
            QTDE_PLANTAS=$(jq '.features | length' dados.geojson 2>/dev/null || echo "0")
            
            MENSAGEM="üåø *S√≠tio Ipiranga*%0A"
            MENSAGEM="${MENSAGEM}üìÖ $(date '+%d/%m/%Y') √†s $(date '+%H:%M')%0A"
            MENSAGEM="${MENSAGEM}üå≥ *${QTDE_PLANTAS} plantas* cadastradas%0A"
            MENSAGEM="${MENSAGEM}‚úÖ Sistema funcionando normalmente%0A"
            MENSAGEM="${MENSAGEM}%0Aüì± *Acesse o app:*%0A"
            MENSAGEM="${MENSAGEM}https://yurimegromonte182.github.io/S-tio_Jintanga/"
          fi
          
          echo "üìù Mensagem preparada:"
          echo "---"
          echo -e "${MENSAGEM//%0A/\\n}"
          echo "---"
          
          echo "ü§ñ Enviando para Telegram..."
          
          # Enviar com timeout e tratamento de erro
          RESPOSTA=$(curl -s -m 30 -X POST \
            "https://api.telegram.org/bot${TOKEN}/sendMessage" \
            -d chat_id="${CHAT_ID}" \
            -d text="${MENSAGEM}" \
            -d parse_mode="Markdown" \
            -w "\nCURL_EXIT:%{exitcode}")
          
          # Separar resposta do c√≥digo de sa√≠da
          CURL_EXIT=$(echo "$RESPOSTA" | grep "CURL_EXIT:" | cut -d: -f2)
          RESPOSTA_API=$(echo "$RESPOSTA" | grep -v "CURL_EXIT:")
          
          echo "C√≥digo de sa√≠da do curl: ${CURL_EXIT:-0}"
          echo "Resposta da API: $RESPOSTA_API"
          
          if [ "${CURL_EXIT:-0}" -eq 0 ] && echo "$RESPOSTA_API" | grep -q '"ok":true'; then
            echo "üéâ ‚úÖ MENSAGEM ENVIADA COM SUCESSO!"
            exit 0
          else
            echo "‚ùå ERRO AO ENVIAR MENSAGEM"
            echo "Detalhes do erro:"
            echo "$RESPOSTA_API"
            exit 1
          fi
